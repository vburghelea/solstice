Below are the access-control / security issues I can **verify in the provided code**, including the ones called out in `route-tree-implementation-review.md` plus a few additional gaps I found.

---

## 1) Saved reports can be enumerated cross-org (and even unauthenticated)

1. **Severity:** High
2. **Location:** `src/features/reports/reports.queries.ts:13` (also `:23-30`)
3. **Issue:** `listSavedReports` does **not require a session** and is **not scoped to org access**.
   - If `organizationId` is **not** provided, it returns **all saved reports** (`return db.select().from(savedReports)`).
   - If `organizationId` **is** provided, the filter is wrong:
     `or(eq(savedReports.organizationId, data.organizationId), eq(savedReports.isOrgWide, true))`
     This returns **every org-wide report across all orgs**, not just the requested org.

4. **Impact:**
   - **Unauthenticated callers** can enumerate saved report definitions (names, filters, columns, sharing config, etc.).
   - **Cross-organization exposure** of saved report metadata and sharing settings.

5. **Fix:**
   - Require authentication at the top (throw 401, don’t return data).
   - Enforce org scoping with `requireOrganizationAccess` and/or `context.organizationId`.
   - Fix the “org-wide” filter to remain org-scoped, e.g.:
     - Only include `isOrgWide = true` **for the same org**, or define “org-wide” as “within org”.
     - Example condition shape:
       - `(savedReports.organizationId = orgId) AND (owner/sharedWith/isOrgWide rules…)`

   - Recommended authorization logic for listing:
     - Allow report if: `ownerId == userId` OR `sharedWith contains userId` OR (`isOrgWide == true` AND user has access to report.organizationId)

---

## 2) Creating saved reports allows arbitrary org targeting (no org access check)

1. **Severity:** High
2. **Location:** `src/features/reports/reports.mutations.ts:130`
3. **Issue:** `createSavedReport` accepts `organizationId` and does **no** `requireOrganizationAccess` / membership validation for that org. It only checks session + feature flag.
4. **Impact:** Any authenticated user can create “org-scoped” (and potentially org-wide) reports for **any** organization ID, enabling cross-org tampering/confusion and (combined with Issue #1) cross-org visibility.
5. **Fix:**
   - If `organizationId` is provided, require `requireOrganizationAccess({ userId, organizationId })` (and likely enforce roles, e.g. `ORG_ADMIN_ROLES` when `isOrgWide`).
   - If not provided, default to `context.organizationId` and reject if missing.

---

## 3) Updating saved reports can “move” a report into another org without access

1. **Severity:** High
2. **Location:** `src/features/reports/reports.mutations.ts:171`
3. **Issue:** `updateSavedReport` checks only **ownership** (or global admin) but allows updating `organizationId` without validating access to the **new** org.
4. **Impact:** Report owners can re-scope their report into orgs they don’t have access to and potentially mark it org-wide/shared, leading to cross-org injection/tampering.
5. **Fix:**
   - If `organizationId` is being changed, enforce `requireOrganizationAccess` to the target org and role requirements (especially for `isOrgWide`).
   - Consider forbidding changing `organizationId` except for global admin.

---

## 4) Report export uses membership (not access) and has no org-role restriction

1. **Severity:** Medium
2. **Location:** `src/features/reports/reports.mutations.ts:267` (notably `:301-317`)
3. **Issue:** `exportReport`:
   - For non-global admins, uses `requireOrganizationMembership` (not `requireOrganizationAccess`) → delegated access is ignored. (`:314`)
   - Does **not** restrict org role (any active member can export).
   - Gets org scope from `x-organization-id` header or `filters.organizationId`, rather than using the resolved org context (`context.organizationId`).

4. **Impact:**
   - Users with only delegated access can’t export (functional + access model mismatch).
   - Any basic org member can export potentially sensitive org data (even with PII masking, exports can still be sensitive).

5. **Fix:**
   - Prefer `context.organizationId` (resolved by middleware) as the org scope for non-admins.
   - Use `requireOrganizationAccess` (not membership) and enforce roles like `["owner","admin","reporter"]` for export.
   - Consider requiring step-up already present (`requireRecentAuth`) — keep it.

---

## 5) SIN org creation is missing global admin enforcement (privilege escalation)

1. **Severity:** High
2. **Location:** `src/features/organizations/organizations.mutations.ts:120`
3. **Issue:** `createOrganization` checks `sin_admin_orgs` feature + session only; it does **not** call `requireAdmin` / `PermissionService.isGlobalAdmin`.
4. **Impact:** Any authenticated user can create an org and becomes its `owner`, effectively enabling self-service org creation even if intended as admin-only. In an admin console context, that’s a privilege escalation + data sprawl risk.
5. **Fix:**
   - Add `requireAdmin(sessionUser.id)` early in `createOrganization`.
   - Optionally add step-up (`requireRecentAuth`) for org creation, similar to reporting mutations.

---

## 6) Org search and list-all endpoints are “admin” but effectively public

1. **Severity:** High
2. **Location:**
   - `src/features/organizations/organizations.queries.ts:96` (`searchOrganizations`)
   - `src/features/organizations/organizations.queries.ts:127` (`listAllOrganizations`)

3. **Issue:** These endpoints only assert the feature flag; they do **not** require session or admin role.
4. **Impact:** **Unauthenticated** users can search and enumerate orgs, leaking organization metadata and enabling targeted attacks.
5. **Fix:**
   - Require session (`getSessionUserId` must exist; otherwise throw 401).
   - Enforce `requireAdmin(userId)` for both endpoints (and potentially step-up for broad enumeration).

---

## 7) Organization lookup by ID has no auth/access check

1. **Severity:** Medium
2. **Location:** `src/features/organizations/organizations.queries.ts:31`
3. **Issue:** `getOrganization` returns an org record by ID with no session check and no org access enforcement.
4. **Impact:** Anyone who can guess/obtain an org UUID can fetch org data (including settings/metadata fields).
5. **Fix:**
   - Require session and `requireOrganizationAccess({ userId, organizationId })`.
   - Or constrain to `context.organizationId` if this is meant to fetch “current org”.

---

## 8) Any org member can list all members (including emails)

1. **Severity:** Medium
2. **Location:** `src/features/organizations/organizations.queries.ts:156`
3. **Issue:** `listOrganizationMembers` only requires membership (no role restriction). It returns `userEmail` for all members.
4. **Impact:** Low-privilege members can enumerate all member emails → PII exposure and phishing/spam vector.
5. **Fix:**
   - Require `requireOrganizationAccess` with roles (at least `ORG_ADMIN_ROLES`, or a deliberate subset like `["owner","admin"]`).
   - If you want a “directory” endpoint for all members, create a separate endpoint that omits emails for non-admin roles.

---

## 9) Org admin flows use membership instead of access (global admin + delegated access blocked)

1. **Severity:** Low (access-model mismatch / admin workflow breakage)
2. **Location:** Examples:
   - `src/features/organizations/organizations.mutations.ts:205` (`updateOrganization` uses `requireOrganizationMembership`)
   - `src/features/organizations/organizations.queries.ts:156` (`listOrganizationMembers` uses membership)
   - `src/features/organizations/organizations.queries.ts:204` (`listDelegatedAccess` uses membership)

3. **Issue:** These use `requireOrganizationMembership` where `requireOrganizationAccess` would better align with your model (global admins and delegated access).
4. **Impact:** Global admins must be manually added as org members everywhere, which encourages risky operational workarounds and undermines delegated access.
5. **Fix:** Switch admin-console endpoints to `requireOrganizationAccess` (and keep role requirements). If some actions truly require explicit membership, document and enforce intentionally.

---

## 10) Privacy admin mutations missing admin enforcement

1. **Severity:** High
2. **Location:**
   - `src/features/privacy/privacy.mutations.ts:23` (`createPolicyDocument`)
   - `src/features/privacy/privacy.mutations.ts:133` (`updatePrivacyRequest`)
   - `src/features/privacy/privacy.mutations.ts:171` (`upsertRetentionPolicy`)

3. **Issue:** These admin actions only check feature flag + session; no global admin requirement.
4. **Impact:** Any authenticated user can publish policy documents, change DSAR/privacy request results, and alter retention rules — major compliance and integrity risk.
5. **Fix:**
   - Add `requireAdmin(sessionUser.id)` (and consider step-up) to all three.
   - Consider preventing client-controlled “publishedAt” semantics except via admin.

---

## 11) Reporting queries allow unauthenticated enumeration (cycles/tasks/submissions)

1. **Severity:** High
2. **Location:**
   - `src/features/reporting/reporting.queries.ts:36` (`listReportingCycles`)
   - `src/features/reporting/reporting.queries.ts:46` (`listReportingTasks`)
   - `src/features/reporting/reporting.queries.ts:80` (`listReportingSubmissions`)

3. **Issue:**
   - `listReportingCycles` has **no auth**.
   - `listReportingTasks` only enforces org access **if** `organizationId` is provided **and** a session exists; otherwise it returns data. With no filters, it returns all tasks.
   - `listReportingSubmissions` similarly skips access enforcement when unauthenticated.

4. **Impact:** Unauthenticated users can enumerate reporting structure, deadlines, tasks, and submission records across orgs.
5. **Fix:**
   - Require session at top of all three endpoints (throw 401).
   - For org-scoped queries, always enforce `requireOrganizationAccess`.
   - Avoid “return all tasks” behavior unless `requireAdmin` (and ideally step-up) is satisfied. Prefer joining through `reportingSubmissions` filtered to accessible org IDs.

---

## 12) Notification creation is unauthenticated and audit can be spoofed

1. **Severity:** High
2. **Location:** `src/features/notifications/notifications.mutations.ts:122` (also audit line `:148`)
3. **Issue:** `createNotification` has **no session guard** and accepts arbitrary `userId`/`organizationId`/content. It logs audit with `actorUserId: data.userId` (the target), not the real actor.
4. **Impact:**
   - Anyone can create notifications for arbitrary users/orgs (spam/phishing).
   - Audit integrity is compromised (logs can falsely implicate the victim as the actor).

5. **Fix:**
   - Require authentication.
   - Set `actorUserId` to the authenticated user/service identity, not the target user.
   - If this is meant only for internal/server use, don’t expose it as a public serverFn; gate with admin or a signed internal token, and restrict target fields.

---

## 13) Notification template creation + scheduling missing admin enforcement

1. **Severity:** High
2. **Location:**
   - `src/features/notifications/notifications.mutations.ts:159` (`createNotificationTemplate`)
   - `src/features/notifications/notifications.mutations.ts:285` (`scheduleNotification`)

3. **Issue:** Both only require session; no `requireAdmin`. `createNotificationTemplate` also allows client to set `isSystem`.
4. **Impact:** Any authenticated user can create templates (possibly “system” templates) and schedule notifications to others/orgs → spam/social engineering risk.
5. **Fix:**
   - Add `requireAdmin(userId)` (and step-up) to both endpoints.
   - Remove `isSystem` from client input or force it to `false` unless admin.

---

## Notes on “org context validation” (what I can verify in this subset)

- **Server-side org context resolution looks correct**: `orgContextMiddleware` only sets `context.organizationId` / role if `resolveOrganizationAccess` succeeds. (`src/lib/auth/guards/org-context.ts:52-86`)
- **But many sensitive endpoints do not rely on context**, and some don’t validate org access at all (issues above). So org context being validated in middleware doesn’t protect endpoints that ignore it.

---

If you want, I can also propose a **standard enforcement pattern** (e.g., `authMiddleware` + a small `requireOrgContext()` helper that uses `context.organizationId` + `requireOrganizationAccess`) to prevent these regressions from reappearing across new serverFns.
