Below are the highest-impact issues I see in **Forms, Imports, Reporting, and Reports** relative to the SIN questions (validation/versioning, lane handling, org scoping, field-level ACL, audit logging). Line numbers are approximate because this is a Repomix-packed view, but the **function blocks** and **file paths** are exact.

---

## Forms

### 1) Server does not enforce “submitted must be valid”

1. **Feature**: Forms
2. **Type**: Gap / Security
3. **Location**: `src/features/forms/forms.mutations.ts:~150-220` (`submitForm`), `~260-340` (`updateFormSubmission`)
4. **Issue**: Both `submitForm` and `updateFormSubmission` compute `missingFields` / `validationErrors`, but they **still persist** the submission even when status is `"submitted"` and required fields are missing or validation errors exist.
5. **Impact**: A malicious or buggy client can submit invalid/incomplete “submitted” records, undermining compliance, reporting accuracy, and review workflow integrity.
6. **Fix**:
   - If `status === "submitted"`, **reject** when `missingFields.length > 0 || validationErrors.length > 0` (throw `badRequest` or return structured error).
   - Allow incomplete payload only when `status === "draft"`.

---

### 2) Required-field logic is wrong for checkboxes, multiselect, and files

1. **Feature**: Forms
2. **Type**: Bug
3. **Location**: `src/features/forms/forms.utils.ts:~70-135` (`validateFormPayload`)
4. **Issue**: `isEmpty` only checks `null` / missing / empty string. It does **not** treat:
   - `[]` (multiselect) as empty
   - `false` (checkbox) as empty when checkbox is “required” (common meaning: must be checked)
   - file fields as empty when no file payload exists

5. **Impact**: Missing required values won’t be flagged; completeness score and compliance gates will be incorrect; imports/automation can “pass” with missing data.
6. **Fix**: Make emptiness field-type aware, e.g.
   - multiselect: empty if not array or `length === 0`
   - checkbox: empty if value is not `true` when required
   - file: empty if no file payload(s) present
   - number: empty if `null` or `NaN` (see next issue)

---

### 3) `NaN` values slip through as “valid” numbers

1. **Feature**: Forms
2. **Type**: Bug
3. **Location**:
   - `src/features/forms/components/form-builder-shell.tsx:~240-320` (DynamicFormRenderer number handling)
   - `src/features/forms/forms.utils.ts:~70-135` (`validateFormPayload`)

4. **Issue**: Numeric conversions can produce `NaN`, but required checks and min/max checks don’t treat `NaN` as empty/invalid.
5. **Impact**: “Submitted” data may contain invalid numeric values that bypass validation and break downstream reporting.
6. **Fix**:
   - Treat `Number.isNaN(value)` as invalid/empty for required and min/max validation.
   - On client, when parsing number input, either keep as string until submit or show a validation error when conversion yields `NaN`.

---

### 4) Regex validation can crash (invalid patterns)

1. **Feature**: Forms
2. **Type**: Bug
3. **Location**:
   - `src/features/forms/components/form-builder-shell.tsx:~200-290` (DynamicFormRenderer validator, `new RegExp(...)`)
   - `src/features/forms/forms.utils.ts:~95-130` (`validateFormPayload`, `new RegExp(...)`)

4. **Issue**: `new RegExp(String(rule.value))` is not guarded. An invalid pattern will throw and can break form interaction/server validation.
5. **Impact**: Admin can brick a form version; submissions can fail unexpectedly.
6. **Fix**:
   - Validate regex at **publish time** (zod refine on `validationRuleSchema` when `type==="pattern"`).
   - Wrap RegExp construction in try/catch and return a safe validation error.

---

### 5) File attachment security: storageKey is never validated on submission

1. **Feature**: Forms
2. **Type**: Security
3. **Location**:
   - `src/features/forms/forms.mutations.ts:~150-220` (`submitForm` payload accepted)
   - `src/features/forms/forms.mutations.ts:~260-340` (`updateFormSubmission`)
   - `src/features/forms/forms.utils.ts:~200-240` (`isValidStorageKeyPrefix` exists but unused)

4. **Issue**: A client can submit a “file payload” with an arbitrary `storageKey` (pointing to another object) because the server never checks that the key matches the expected prefix or was generated by `createFormUpload`.
5. **Impact**: Unauthorized file attachment / data exfiltration risk; violates tenant/org boundaries and audit expectations.
6. **Fix**:
   - Enforce `isValidStorageKeyPrefix(storageKey, \`forms/${formId}/`)` (or form.id) for each file payload.
   - Consider persisting an “upload init record” and requiring it to exist for `(actorUserId, formId, storageKey)` before accepting in a submission.

---

### 6) `createFormUpload` accepts _any_ fieldKey (even non-file / nonexistent)

1. **Feature**: Forms
2. **Type**: Security / Gap
3. **Location**: `src/features/forms/forms.mutations.ts:~220-290` (`createFormUpload`) + `src/features/forms/forms.utils.ts:~140-190` (`getFileConfigForField`)
4. **Issue**: `getFileConfigForField` returns a default config when the field is not found or not a file field, so `createFormUpload` may allow uploads for arbitrary `fieldKey`s.
5. **Impact**: Users can upload unexpected objects into your artifacts bucket under `forms/<formId>/...` without the form actually having that file field (cost/abuse + potential compliance drift).
6. **Fix**: In `createFormUpload`, load the latest definition and **hard-fail** unless `fieldKey` exists and `field.type === "file"`.

---

### 7) `maxFiles` is configured but not enforced; multi-file flows likely broken

1. **Feature**: Forms
2. **Type**: Bug / Gap
3. **Location**:
   - `src/features/forms/components/form-builder-shell.tsx:~120-200` (`normalizePayload` handles only single `File`)
   - `src/features/forms/forms.mutations.ts:~40-110` (`buildSubmissionFiles` supports only single file payload per field)

4. **Issue**: UI supports `maxFiles` configuration, but client normalization and server persistence only handle a **single** file payload object per file field. Arrays of files won’t upload or persist properly.
5. **Impact**: Forms configured for multiple files won’t behave correctly; required file counts can be bypassed.
6. **Fix**:
   - Decide on payload contract: file field value should be **array** of file payloads.
   - Update `normalizePayload` to upload N files and write array payload.
   - Update `buildSubmissionFiles` to iterate array payloads and enforce `maxFiles`.

---

### 8) Submission read/update endpoints are too permissive (org membership == full access)

1. **Feature**: Forms
2. **Type**: Security
3. **Location**:
   - `src/features/forms/forms.queries.ts:~120-270` (`listFormSubmissions`, `listFormSubmissionVersions`, `listSubmissionFiles`, `getSubmissionFileDownloadUrl`)
   - `src/features/forms/forms.mutations.ts:~260-340` (`updateFormSubmission`)

4. **Issue**: These endpoints only require org membership (`requireOrgAccess`), not “submitter-only” or “reviewer/admin-only.” That enables any org member to enumerate and download other users’ submissions/attachments if they can guess IDs or access the form.
5. **Impact**: PII leakage and workflow tampering risk.
6. **Fix**:
   - For “list all submissions” and file download: require `ORG_ADMIN_ROLES` (or explicit reviewer permission).
   - For “view/update a submission”: allow submitter, plus admins/reviewers.
   - Implement row-level checks: `submission.submitterId === actorUserId` unless privileged.

---

### 9) File download access is not audit-logged

1. **Feature**: Forms
2. **Type**: Gap / Compliance
3. **Location**: `src/features/forms/forms.queries.ts:~220-270` (`getSubmissionFileDownloadUrl`)
4. **Issue**: Generating a signed download URL is a sensitive access event, but it isn’t logged.
5. **Impact**: Missing audit trail for who accessed/downloaded attachments (often required for compliance).
6. **Fix**: Add an audit event (e.g., `FORM_FILE_DOWNLOAD_URL_ISSUED`) with `submissionFileId`, `submissionId`, orgId, actorUserId.

---

### 10) Completeness score denominator counts inactive conditional fields

1. **Feature**: Forms
2. **Type**: Bug
3. **Location**: `src/features/forms/forms.utils.ts:~120-135` (`completenessScore`)
4. **Issue**: `totalFields = definition.fields.length` even though conditional inactive fields are skipped from `missingFields`. This inflates scores when conditional fields exist.
5. **Impact**: Misleading completeness metrics, potentially impacting compliance thresholds and reviews.
6. **Fix**: Compute `totalFields` as the number of **active** fields (or active required fields) given the payload.

---

### 11) `updateForm` will clear description unintentionally

1. **Feature**: Forms
2. **Type**: Bug
3. **Location**: `src/features/forms/forms.mutations.ts:~60-110` (`updateForm`)
4. **Issue**: `description: data.data.description ?? null` will set description to `null` whenever description is omitted in the update payload.
5. **Impact**: Any update that doesn’t explicitly include `description` will wipe it.
6. **Fix**: Use “preserve existing if undefined” semantics, e.g. `description: data.data.description !== undefined ? data.data.description : existing.description`.

---

### 12) Form settings exist but aren’t enforced server-side

1. **Feature**: Forms
2. **Type**: Gap
3. **Location**:
   - `src/features/forms/forms.schemas.ts:settings`
   - `src/features/forms/forms.mutations.ts:~150-220` (`submitForm`)

4. **Issue**: `settings.requireApproval` and `settings.notifyOnSubmit` are stored/published, but submissions don’t enforce approval transitions or notifications.
5. **Impact**: Form behavior won’t match expected SIN workflows (approval gating and notifications are “paper config”).
6. **Fix**:
   - If `requireApproval`, auto-transition submitted submissions to `under_review` (or prevent “approved” path until review).
   - Dispatch notifications for `notifyOnSubmit` on submit (server-side).

---

## Imports

### 13) Interactive import can target the wrong form (job/form mismatch not enforced)

1. **Feature**: Imports
2. **Type**: Security
3. **Location**: `src/features/imports/imports.mutations.ts:~140-240` (`runInteractiveImport`)
4. **Issue**: `runInteractiveImport` loads the job by `jobId` but does **not** verify:
   - `job.targetFormId === data.formId`
   - the form belongs to / is valid for `job.organizationId`
   - the actor has access to the form’s org scope

5. **Impact**: A user could import rows into a form they shouldn’t be able to touch (cross-org contamination).
6. **Fix**: Load the form record and enforce:
   - `job.targetFormId` must match `data.formId` (or `job.targetFormId` must be null and set it once)
   - form’s org scope must equal `job.organizationId` (or explicitly allow global templates)
   - actor must have access to form’s org scope

---

### 14) Interactive import trusts client-supplied rows (hash/file key not used)

1. **Feature**: Imports
2. **Type**: Gap / Compliance
3. **Location**: `src/features/imports/imports.mutations.ts:~140-240` (`runInteractiveImport`)
4. **Issue**: The job stores `sourceFileKey` and `sourceFileHash`, but `runInteractiveImport` ignores them and imports `data.rows` sent from the browser.
5. **Impact**: Audit trail claims import is based on an uploaded artifact, but actual imported data can differ (tampering risk).
6. **Fix**: For lane 1: server should fetch and parse the stored file (`sourceFileKey`) and verify its hash matches `sourceFileHash`, then apply the mapping server-side.

---

### 15) Mapping template CRUD is not audit logged

1. **Feature**: Imports
2. **Type**: Gap / Compliance
3. **Location**: `src/features/imports/imports.mutations.ts:~60-140` (`createMappingTemplate`, `updateMappingTemplate`, `deleteMappingTemplate`)
4. **Issue**: Mapping templates can materially affect imports, but create/update/delete actions are not logged.
5. **Impact**: Missing audit trail for a core compliance-related artifact.
6. **Fix**: Add `logDataChange`/`logAdminAction` for template create/update/delete including orgId, templateId, and diffs.

---

### 16) `updateImportJobStatus` is not audit logged

1. **Feature**: Imports
2. **Type**: Gap / Compliance
3. **Location**: `src/features/imports/imports.mutations.ts:~40-70` (`updateImportJobStatus`)
4. **Issue**: Job status changes are not logged.
5. **Impact**: Harder to reconstruct import timeline for audits.
6. **Fix**: Log status transitions with metadata (previous → next, stats summary).

---

### 17) Rollback deletes submissions but may leave orphaned versions/files/errors

1. **Feature**: Imports
2. **Type**: Bug / Gap
3. **Location**: `src/features/imports/imports.mutations.ts:~260-330` (`rollbackImportJob`)
4. **Issue**: Rollback deletes from `formSubmissions` by `importJobId`, but does not explicitly delete dependent rows (submission versions, submission files, import job errors). If FK constraints don’t cascade, rollback may fail or orphan data.
5. **Impact**: Incomplete rollback, referential integrity issues, “rolled_back” jobs with leftover data.
6. **Fix**: Wrap in a DB transaction: collect submission IDs, delete dependent records (`formSubmissionVersions`, `submissionFiles`, possibly `importJobErrors`), then delete submissions.

---

### 18) Import stats are misleading (`failed` counts errors, not failed rows)

1. **Feature**: Imports
2. **Type**: Bug
3. **Location**: `src/features/imports/imports.mutations.ts:~210-240` (`runInteractiveImport` stats)
4. **Issue**: `failed: errors.length` counts individual field errors, not rows that failed.
5. **Impact**: Incorrect operational metrics and misleading audit summaries.
6. **Fix**: Track distinct failed row numbers; compute `failedRows` and `errorCount` separately.

---

### 19) Import type conversion allows invalid numbers + weak multiselect parsing

1. **Feature**: Imports
2. **Type**: Bug
3. **Location**: `src/features/imports/imports.mutations.ts:~150-210` (`runInteractiveImport` row parsing)
4. **Issue**: `Number(rawValue)` can produce `NaN` and currently passes through; multiselect splitting doesn’t filter blanks.
5. **Impact**: Corrupt data inserted; validation preview and server validation won’t catch it reliably (because `validateFormPayload` isn’t NaN-aware).
6. **Fix**:
   - If numeric conversion yields `NaN`, record a row error and skip insert.
   - For multiselect, `.split(",").map(trim).filter(Boolean)`.

---

### 20) File fields are not supported in imports (but not blocked)

1. **Feature**: Imports
2. **Type**: Gap
3. **Location**: `src/features/imports/imports.mutations.ts:~150-210` (`runInteractiveImport`) and UI mapping in `import-wizard-shell.tsx:~240-320`
4. **Issue**: Imports treat file fields as simple values; there’s no file ingestion/upload path.
5. **Impact**: File-required forms can’t be imported correctly; could create “submitted” records without required attachments.
6. **Fix**: Either:
   - disallow mapping to `type === "file"` fields (server + UI), or
   - implement a controlled file ingestion mechanism (URLs → server fetch → `createFormUpload`-style validation/storage).

---

## Reporting

### 21) Reporting queries leak data without authentication

1. **Feature**: Reporting
2. **Type**: Security
3. **Location**: `src/features/reporting/reporting.queries.ts:~15-120` (`listReportingCycles`, `listReportingTasks`, `listReportingSubmissions`)
4. **Issue**: These handlers do not require a session user ID. `listReportingSubmissions` explicitly skips org access checks when `userId` is null.
5. **Impact**: If the feature gate is enabled, an unauthenticated caller could read reporting cycles/tasks/submissions (high-severity data leak).
6. **Fix**:
   - Require session user for all reporting queries (`unauthorized` if missing).
   - Always enforce org membership checks for org-scoped data.
   - For cycles/tasks, decide role-based visibility (e.g., admin-only vs org members via join).

---

### 22) Status enum mismatch: UI supports `rejected`, schema does not

1. **Feature**: Reporting
2. **Type**: Bug / UX
3. **Location**: `src/features/reporting/reporting.schemas.ts:~10-25` (`reportingSubmissionStatusSchema`) vs `reporting-dashboard-shell.tsx:~30-60` (`submissionStatusOptions`)
4. **Issue**: UI offers `"rejected"` but backend schema doesn’t allow it.
5. **Impact**: Users will select “rejected” and the update will fail validation.
6. **Fix**: Add `"rejected"` to `reportingSubmissionStatusSchema` (and enforce permissions) **or** remove it from the UI.

---

### 23) Linking form submissions to reporting submissions is not validated

1. **Feature**: Reporting
2. **Type**: Security / Data Integrity
3. **Location**: `src/features/reporting/reporting.mutations.ts:~120-220` (`updateReportingSubmission`)
4. **Issue**: `formSubmissionId` is accepted and written without verifying it belongs to the same org and matches the reporting task’s `formId`. `formSubmissionVersionId` is only stored in history, not validated either.
5. **Impact**: A reviewer could (accidentally or maliciously) associate the wrong submission/version, breaking audit traceability.
6. **Fix**: Validate via DB joins:
   - reporting submission → task → expected formId
   - formSubmissionId → formSubmissions.organizationId + formId must match
   - formSubmissionVersionId must belong to that formSubmissionId

---

### 24) Review/submission metadata can become stale when status changes

1. **Feature**: Reporting
2. **Type**: Bug
3. **Location**: `src/features/reporting/reporting.mutations.ts:~170-220` (`updateReportingSubmission` update logic)
4. **Issue**: When moving away from review statuses or away from submitted, the code doesn’t clear `reviewedBy/reviewedAt/reviewNotes` or `submittedAt/submittedBy`.
5. **Impact**: Records can show “reviewed by X” even when status is back to “in_progress”; audit/confusion risk.
6. **Fix**: Explicitly clear fields when transitioning out of those states (or track immutable events only in history and keep main table “current state only”).

---

### 25) Reminder schedule input isn’t sanitized (negatives/duplicates)

1. **Feature**: Reporting
2. **Type**: Gap
3. **Location**: `src/features/reporting/reporting.mutations.ts:~60-160` (`createReportingTask` reminder scheduling)
4. **Issue**: `days_before` accepts negative or duplicate values. Negative offsets schedule notifications _after_ due date.
5. **Impact**: Noisy/bad reminders; potential compliance SLA problems.
6. **Fix**: Normalize days to `unique(positiveInt)` and enforce a reasonable max range.

---

## Reports

### 26) Saved reports listing has no authz and leaks all reports

1. **Feature**: Reports
2. **Type**: Security
3. **Location**: `src/features/reports/reports.queries.ts:~1-40` (`listSavedReports`)
4. **Issue**: `listSavedReports` does not check session user and returns **all** saved reports when no org filter is passed. Even with org filter, it doesn’t enforce org membership.
5. **Impact**: Users can discover other users’ report definitions (filters, columns, org IDs, possibly sharedWith lists).
6. **Fix**: Require session, then return only:
   - reports the user owns, OR
   - reports shared with the user (`sharedWith` includes userId), OR
   - org-wide reports _for orgs the user belongs to_
   - global admin can see all

---

### 27) Creating org-scoped / org-wide saved reports isn’t permission-checked

1. **Feature**: Reports
2. **Type**: Security
3. **Location**: `src/features/reports/reports.mutations.ts:~85-140` (`createSavedReport`)
4. **Issue**: A user can set `organizationId` and `isOrgWide` without any membership/role validation.
5. **Impact**: Users can create org-wide reports in orgs they don’t belong to (or inappropriately broadcast reports within an org).
6. **Fix**:
   - If `organizationId` is set, require org membership.
   - If `isOrgWide === true`, require org admin/owner or explicit permission.
   - Validate `sharedWith` recipients are within org scope (if required by SIN).

---

### 28) Export ignores filters/columns/sort (but audit stores “filtersUsed”)

1. **Feature**: Reports
2. **Type**: Gap / Compliance
3. **Location**: `src/features/reports/reports.mutations.ts:~40-90` (`loadReportData`) and `~150-240` (`exportReport`)
4. **Issue**: `exportReport` accepts `filters` and `columns`, but `loadReportData` doesn’t apply them (beyond org scoping). Export history stores `filtersUsed`, which becomes misleading.
5. **Impact**: Users export more data than intended; audit trail suggests filters were applied when they weren’t.
6. **Fix**: Implement server-side filtering/column projection/sorting with a strict allowlist per `dataSource`. Ensure `exportHistory.filtersUsed` reflects actual applied filters.

---

### 29) “Excel” and “PDF” exports aren’t real exports

1. **Feature**: Reports
2. **Type**: Bug / Gap
3. **Location**:
   - `src/features/reports/reports.mutations.ts:~180-230` (`exportReport`)
   - `src/features/reports/components/report-builder-shell.tsx:~40-95` (download extension/type logic)

4. **Issue**:
   - `exportType === "excel"` returns CSV (`toCsv`)
   - `exportType === "pdf"` returns `JSON.stringify(filteredRows)` (not a PDF)
   - UI downloads excel as `.csv` unless pdf

5. **Impact**: Users think they’re getting XLSX/PDF but receive wrong formats (breaks SIN “export” expectation).
6. **Fix**:
   - Implement XLSX generation (e.g., `xlsx`/`exceljs`) and return bytes with correct content-type.
   - Implement PDF generation (server-side PDF renderer) or remove PDF option until implemented.
   - Fix UI extension mapping: excel → `.xlsx`, csv → `.csv`, pdf → `.pdf`.

---

### 30) Field-level ACL only masks top-level keys and misses form payload PII

1. **Feature**: Reports
2. **Type**: Security
3. **Location**: `src/features/reports/reports.mutations.ts:~1-70` (`SENSITIVE_FIELDS`, `applyFieldLevelAcl`) and `~40-90` (`loadReportData` for `form_submissions`)
4. **Issue**: For `form_submissions`, PII is likely inside `payload` (nested JSON). The current masking only checks top-level keys like `"email"`; it will not redact `payload.email`, `payload.dateOfBirth`, etc. Also, sensitive fields are hardcoded rather than tied to form definitions/ACL.
5. **Impact**: PII can leak in exports even when the user lacks PII permission.
6. **Fix**:
   - For `form_submissions`, parse/redact inside `payload` recursively.
   - Prefer storing a PII flag per form field in `FormDefinition` and applying redaction based on that metadata.
   - Enforce column allowlists and redaction server-side regardless of client-provided `columns`.

---

### 31) PII access policy is overly permissive by default

1. **Feature**: Reports
2. **Type**: Security
3. **Location**: `src/features/reports/reports.mutations.ts:~20-55` (`canViewSensitiveFields`)
4. **Issue**: Org owners/admins are automatically allowed to view sensitive fields even without an explicit PII permission.
5. **Impact**: Violates least-privilege in many compliance regimes; increases blast radius of compromised admin accounts.
6. **Fix**: Require explicit permission (`pii.read`) for PII export/view; treat role-based access as separate and configurable if needed.

---

## Audit logging coverage check (quick callout)

- ✅ Good: Form create/update/publish, submission create/update/review, import job create/upload/init/complete/rollback, reporting cycle/task create + submission update, report create/update/delete + export are logged.
- ❌ Missing/high-value additions: mapping template CRUD logs, import job status update logs, **file download URL issuance logs**, and (depending on SIN policy) “view submission” access logs.

---

If you want, I can also propose a **tight “minimum compliance patch set”** (the smallest changes that close the biggest security/compliance gaps) across these four features, but the items above are the concrete issues I’d fix first.
