### Issue 1

1. **Category:** Security
2. **Severity:** High
3. **Location:** `src/features/security/security.mutations.ts:9-44`
4. **Issue:** `recordSecurityEvent` can be called without any session/auth check. Anyone who can hit this endpoint can write to `security_events` and trigger `applySecurityRules` (potentially locking accounts) by providing `userId` or an `identifier` email. That’s a direct integrity/abuse vector (event log poisoning + denial-of-service lockouts).
5. **Requirement:** **SEC-AGG-002** (Monitoring & Threat Detection) + **SEC-AGG-004** (Audit Trail integrity) + **SEC-AGG-001** (Access control)
6. **Fix:**
   - Require authentication for all event writes (even if the user is unknown).
   - Split “system-generated auth pipeline events” (trusted) from “client-reported events” (untrusted).
   - If you must accept unauthenticated events (e.g., pre-auth login failures), restrict to a very small allowlist of event types and **do not** accept `userId` from the caller; resolve internally from the auth subsystem.
   - Add rate limiting / abuse protection on this endpoint and consider writing only aggregated counters for unauthenticated failures.

---

### Issue 2

1. **Category:** Permissions
2. **Severity:** High
3. **Location:** `src/features/organizations/organizations.mutations.ts:120-175`
4. **Issue:** `createOrganization` is only gated by `assertFeatureEnabled("sin_admin_orgs")` + “user is logged in”. There is **no** global-admin requirement. Any authenticated user can create organizations and is automatically inserted as **owner**. If `sin_admin_orgs` is enabled in an environment, this becomes self-service org creation with owner privileges—likely not intended for SIN tenancy governance.
5. **Requirement:** **F-001** (Organization & Tenancy Model) + **DM-AGG-003** (Data Governance & Access Control) + **SEC-AGG-001** (role/affiliation restriction)
6. **Fix:**
   - Require global admin (same pattern you use in security admin mutations): `await requireAdmin(sessionUser.id)` or `PermissionService.isGlobalAdmin(...)`.
   - If you _do_ want self-service creation, explicitly constrain which org `type` can be self-created (e.g., allow only `club`, disallow `governing_body/pso/league`), and force an approval workflow (`status: pending`) before becoming active.

---

### Issue 3

1. **Category:** Permissions
2. **Severity:** High
3. **Location:** `src/features/organizations/organizations.queries.ts:27-45`
4. **Issue:** `getOrganization` returns an org record by ID with **no membership check** and no global-admin check. Any authenticated user who can call this endpoint (feature flag enabled) can enumerate or fetch org details if they can guess/obtain UUIDs.
5. **Requirement:** **F-001** + **DM-AGG-003** + **SEC-AGG-001**
6. **Fix:**
   - Require either global admin **or** membership/delegated access to that org (and/or its ancestors/descendants, depending on your tenancy rule).
   - Recommended: reuse `resolveOrganizationAccess({ userId, organizationId })` and forbid if null.

---

### Issue 4

1. **Category:** Permissions
2. **Severity:** High
3. **Location:**
   - `src/features/organizations/organizations.queries.ts:85-112` (`searchOrganizations`)
   - `src/features/organizations/organizations.queries.ts:121-150` (`listAllOrganizations`)

4. **Issue:** Both endpoints are described/used as “Admin-only” but only gate on `assertFeatureEnabled("sin_admin_orgs")`. There’s no verification that the caller is a **global admin**. If the feature flag is enabled, any logged-in user can search/list all organizations in the system.
5. **Requirement:** **F-001** + **DM-AGG-003** + **SEC-AGG-001**
6. **Fix:**
   - Add a global admin check (PermissionService / `requireAdmin`) at the start of both handlers.
   - Optionally: log and alert on repeated org enumeration attempts.

---

### Issue 5

1. **Category:** Orgs
2. **Severity:** High
3. **Location:** `src/features/organizations/organizations.mutations.ts:191-300`
4. **Issue:** `updateOrganization` allows any org admin (via `requireOrganizationMembership(..., { roles: ORG_ADMIN_ROLES })`) to change high-impact tenancy fields like `type` and `parentOrgId`. Because your access model **inherits down the org tree** (`organizations.access.ts`), changing `parentOrgId` can change who implicitly gains access to descendants. That’s a tenancy boundary control and should not be editable by ordinary org admins.
5. **Requirement:** **F-001** (tenancy boundary enforcement) + **DM-AGG-003** + **SEC-AGG-001**
6. **Fix:**
   - Restrict changes to `type` and `parentOrgId` to **global admins only**, or require an explicit elevated workflow (step-up auth + approval + audit).
   - Consider preventing _any_ parent change once data exists, unless done by global admin and audited heavily.

---

### Issue 6

1. **Category:** Orgs
2. **Severity:** Medium
3. **Location:** `src/features/organizations/organizations.mutations.ts:270`
4. **Issue:** Bug: `updateOrganization` always writes `parentOrgId: data.data.parentOrgId ?? null`. If the caller omits `parentOrgId` (undefined), this expression resolves to `null`, unintentionally **clearing the parent**. This can silently break the hierarchy even when the user didn’t intend to change it.
5. **Requirement:** **F-001** (org hierarchy correctness)
6. **Fix:**
   - Only set `parentOrgId` when the field is present in the patch object. Example pattern:
     - If `"parentOrgId" in data.data`, then set `parentOrgId` to `data.data.parentOrgId ?? null`, else do not update that column.

   - You already computed `nextParentOrgId`—use that and/or conditional updates.

---

### Issue 7

1. **Category:** Permissions
2. **Severity:** High
3. **Location:** `src/features/organizations/organizations.queries.ts:152-194`
4. **Issue:** `listOrganizationMembers` only requires **membership** in the org, not an admin role. That means any org member can list all members, including **emails** (`user.email`). That’s likely overbroad and can become a privacy issue and an escalation surface (member enumeration).
5. **Requirement:** **SEC-AGG-001** (restrict access based on roles/affiliations) + **SEC-AGG-003** (privacy) + **DM-AGG-003**
6. **Fix:**
   - Require org admin roles (`ORG_ADMIN_ROLES`) to list members (at least for email visibility).
   - If you need a “directory” feature for regular members, return a minimized projection (e.g., display name only) and hide email unless the viewer has appropriate role.

---

### Issue 8

1. **Category:** Orgs
2. **Severity:** Medium
3. **Location:** `src/features/organizations/organizations.queries.ts:47-82`
4. **Issue:** `listOrganizations` does not filter `organizationMembers.status = 'active'`. It filters org status when `includeArchived` is false, but memberships that are `pending/suspended/removed` can still join and be returned. That can expose org presence or give users confusing UI access they shouldn’t have.
5. **Requirement:** **F-001** (membership enforcement) + **SEC-AGG-001**
6. **Fix:**
   - Add `eq(organizationMembers.status, "active")` to the query conditions (both branches).
   - Consider also excluding orgs with non-active status unless explicitly requested by privileged roles.

---

### Issue 9

1. **Category:** Security
2. **Severity:** Medium
3. **Location:** `src/lib/security/events.ts:18-27`
4. **Issue:** `ipAddress` is taken directly from `x-forwarded-for` / `x-real-ip` without parsing/validation. `x-forwarded-for` commonly contains a **comma-separated list**, which can fail an `inet` insert or record garbage. It’s also spoofable unless you only trust it behind a known proxy. This degrades detection quality and can break inserts.
5. **Requirement:** **SEC-AGG-002** (detection accuracy) + **SEC-AGG-004** (audit/event integrity)
6. **Fix:**
   - Parse `x-forwarded-for` and take the first valid IP (trim + validate).
   - Prefer platform-provided trusted headers only when running behind your infrastructure; otherwise fall back to the real remote addr from the runtime if available.
   - Consider normalizing IPv6/IPv4-mapped formats.

---

### Issue 10

1. **Category:** Security
2. **Severity:** Medium
3. **Location:** `src/lib/security/detection.ts:4-86`
4. **Issue:** `applySecurityRules` implements only simple threshold lockouts for `login_fail` and `mfa_fail`. The SIN requirements/spec call out suspicious patterns like “login from new country” / anomalies. Your schema supports `riskScore` and `riskFactors`, but the rules engine isn’t using them and no anomaly detection is implemented here.
5. **Requirement:** **SEC-AGG-002** (Monitoring & Threat Detection)
6. **Fix:**
   - Add rules that compare recent successful login geo/device fingerprints per user (country/region/userAgent hash) and record events with `riskScore/riskFactors`.
   - Add “flag for review” vs “lock” actions (not everything should lock).
   - Consider configurable thresholds (not hard-coded) and store them in config/settings.

---

### Issue 11

1. **Category:** Security
2. **Severity:** Medium
3. **Location:** `src/features/security/security.queries.ts:107-153`
4. **Issue:** `listAccountLocks` returns **all locks** for the org/user set, including already unlocked and expired locks. But the UI text says “No active locks.” This is both misleading and may expose unnecessary historical lock reasons to org admins.
5. **Requirement:** **SEC-AGG-002** (lockout behavior & admin controls) + **SEC-AGG-003** (data minimization)
6. **Fix:**
   - Filter for “active” locks: `unlockedAt IS NULL AND (unlockAt IS NULL OR unlockAt > now)` (same logic as `isAccountLocked`).
   - If you need history, add an explicit `includeHistory` flag and gate it behind stronger permissions.

---

### Issue 12

1. **Category:** Security
2. **Severity:** Medium
3. **Location:** `src/lib/security/config.ts:25-34`
4. **Issue:** Session configuration uses `maxAge: 30 days`, which conflicts with the SIN backlog’s **ADR-005: Session Security** (8 hours max age, 30 min idle, shorter for admins). Even if the session enforcement is elsewhere, this config strongly suggests the app may not be compliant with the stated SIN security posture.
5. **Requirement:** **SEC-AGG-001** (Authentication & Access Control)
6. **Fix:**
   - Align session max age and idle timeout with ADR-005 (or update ADR if this changed).
   - Enforce shorter admin sessions and step-up auth for sensitive actions.
   - Ensure cookies/sessions are invalidated server-side, not just client-side.

---

### Issue 13

1. **Category:** Security
2. **Severity:** Low
3. **Location:** `src/db/schema/security.schema.ts:12-38`
4. **Issue:** The security tables do not define indexes (in this schema file) for common access patterns you already use: `securityEvents.userId + createdAt`, `securityEvents.ipAddress + createdAt`, and “active locks by user”. This can become a performance bottleneck and delay detection/lockout decisions under load.
5. **Requirement:** **SEC-AGG-002** (monitoring/detection reliability)
6. **Fix:**
   - Add indexes equivalent to the backlog spec:
     - `security_events(user_id, created_at desc)`
     - `security_events(ip_address, created_at desc)`
     - `account_locks(user_id) WHERE unlocked_at IS NULL`

   - Add an index to support `isAccountLocked` filtering on `unlockAt` if needed.

---

### Issue 14

1. **Category:** Security
2. **Severity:** Low
3. **Location:** `src/lib/security/config.ts:42-47`
4. **Issue:** CORS `allowedHeaders` only includes `Content-Type` and `Authorization`. Your server-side security queries rely on `x-organization-id` for org scoping. If you ever call these cross-origin (admin tools, preview deployments, etc.), this header may be blocked.
5. **Requirement:** **SEC-AGG-001** (reliable access control enforcement)
6. **Fix:**
   - Add `X-Organization-Id` to `allowedHeaders` (and any other required internal headers).
   - Ensure the header is set server-side when possible (e.g., derived from the session’s active org cookie) rather than trusting arbitrary client input.

---

If you want to prioritize fixes: **Issue 1 (unauthenticated security event writes)**, **Issue 2/4/3 (org admin endpoints & org data enumeration without global-admin/membership checks)**, and **Issue 5/6 (reparenting + parentOrgId clearing bug)** are the ones that most directly break tenancy/security guarantees.
