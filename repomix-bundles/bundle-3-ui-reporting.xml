This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/components/ui/admin-sidebar.tsx, src/components/ui/alert.tsx, src/components/ui/avatar.tsx, src/components/ui/badge.tsx, src/components/ui/breadcrumbs.tsx, src/components/ui/button.tsx, src/components/ui/card.tsx, src/components/ui/checkbox.tsx, src/components/ui/data-state.tsx, src/components/ui/data-table.tsx, src/components/ui/dialog.tsx, src/components/ui/dropdown-menu.tsx, src/components/ui/icons.tsx, src/components/ui/input.tsx, src/components/ui/label.tsx, src/components/ui/logo.tsx, src/components/ui/select.tsx, src/components/ui/table.tsx, src/components/ui/tabs.tsx, src/components/ui/TypedLink.tsx, src/shared/**/*.ts, src/shared/**/*.tsx, src/features/layouts/**/*.ts, src/features/layouts/**/*.tsx, src/features/dashboard/**/*.tsx, src/features/profile/components/**/*.tsx, src/features/profile/hooks/**/*.ts, src/features/events/events.queries.ts, src/features/events/events.types.ts, src/features/membership/membership.queries.ts, src/features/membership/membership.types.ts, src/features/membership/components/**/*.tsx, src/features/members/**/*.ts, src/lib/utils/csv-export.ts, src/lib/email/**/*.ts, src/routes/onboarding/**/*.tsx, src/routes/__root.tsx, src/routes/index.tsx, src/routes/dashboard/index.tsx, src/routes/dashboard/reports.tsx, src/routes/dashboard/members.tsx, src/routes/dashboard/membership.tsx, repomix-bundles/REQUIREMENTS-BUNDLE-3.md
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
repomix-bundles/
  REQUIREMENTS-BUNDLE-3.md
src/
  components/
    ui/
      admin-sidebar.tsx
      alert.tsx
      avatar.tsx
      badge.tsx
      breadcrumbs.tsx
      button.tsx
      card.tsx
      checkbox.tsx
      data-state.tsx
      data-table.tsx
      dialog.tsx
      dropdown-menu.tsx
      icons.tsx
      input.tsx
      label.tsx
      logo.tsx
      select.tsx
      table.tsx
      tabs.tsx
      TypedLink.tsx
  features/
    dashboard/
      MemberDashboard.tsx
      PublicPortalPage.tsx
    events/
      events.queries.ts
      events.types.ts
    layouts/
      __tests__/
        admin-layout.test.tsx
      admin-layout.tsx
      admin-nav.ts
    members/
      index.ts
      members.queries.ts
      members.schemas.ts
      members.types.ts
    membership/
      components/
        admin-memberships-report.tsx
      membership.queries.ts
      membership.types.ts
    profile/
      components/
        complete-profile-form-simple.tsx
        profile-view.tsx
      hooks/
        useProfileFormReducer.ts
  lib/
    email/
      sendgrid.ts
    utils/
      csv-export.ts
  routes/
    dashboard/
      index.tsx
      members.tsx
      membership.tsx
      reports.tsx
    onboarding/
      index.tsx
      route.tsx
    __root.tsx
    index.tsx
  shared/
    contexts/
      ThemeContext.tsx
    hooks/
      useAsyncState.ts
      useFocusOnMount.ts
      useLocalStorage.ts
      useTheme.ts
    lib/
      utils.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="repomix-bundles/REQUIREMENTS-BUNDLE-3.md">
# Bundle 3: Dashboard, UI/UX, Reporting & Onboarding

> **Your Task:** Implement or enhance the 13 requirements below for the viaSport Strength in Numbers (SIN) system.

---

## Requirements You Must Address

### REPORTING

#### RP-AGG-002: Reporting Information Management
**Description:** The system shall manage metadata related to reporting including but not limited to contribution agreements, NCCP, contact details, fiscal periods, organization profiles, and delegated access rights.

**Acceptance Criteria:** Users can update relevant metadata and access reporting features accordingly.

**Current Status:** 35% complete
- Events have metadata (JSONB fields)
- Team/membership data tracked

**Gaps to Implement:**
- [ ] Reporting metadata schema (fiscal periods, agreements, NCCP)
- [ ] Organization profile management
- [ ] Delegated access rights for reporting
- [ ] Metadata update UI for admins

---

#### RP-AGG-003: Reporting Flow & Support
**Description:** The system shall support automated reporting reminders, allow users to track data resubmissions, and visualize submitted data through dashboards.

**Acceptance Criteria:** Users are reminded, track changes, and view data in a dashboard format.

**Current Status:** 40% complete
- Dashboard exists (MemberDashboard.tsx)
- Email infrastructure exists (SendGrid)
- No automated reminders

**Gaps to Implement:**
- [ ] Reporting deadline tracking
- [ ] Automated email reminders (upcoming deadlines, overdue)
- [ ] Resubmission tracking with history
- [ ] Submission status dashboard (pending, submitted, approved)

---

#### RP-AGG-004: Reporting Configuration & Collection
**Description:** The system shall allow system administrators to configure customizable reporting forms, define required fields, display files for users to read, edit, delete, and download.

**Acceptance Criteria:** System admin can configure reporting information and forms.

**Current Status:** 10% complete
- Basic form components exist
- No admin form configuration UI

**Gaps to Implement:**
- [ ] Admin form builder UI
- [ ] Required field configuration per form
- [ ] File attachment management (view, edit, delete, download)
- [ ] Form versioning (track changes to form structure)

---

#### RP-AGG-005: Self-Service Analytics & Data Export
**Description:** Enable authorized users to build ad-hoc charts, pivot tables, and export raw or aggregated datasets in CSV, Excel, or JSON (optional) without developer intervention.

**Acceptance Criteria:** User builds a custom chart and exports underlying dataset to CSVs; export respects field-level access rules.

**Current Status:** 5% complete
- CSV export utility exists
- No chart builder or analytics UI

**Gaps to Implement:**
- [ ] Chart builder UI (bar, line, pie charts)
- [ ] Pivot table functionality
- [ ] Data aggregation queries
- [ ] Export with field-level access control
- [ ] Save/share custom reports

---

### USER INTERFACE

#### UI-AGG-002: Personalized Dashboard
**Description:** The system shall provide the capability to create personalized dashboard for each user role, summarizing relevant data, actions, and reporting progress.

**Acceptance Criteria:** Users can view personalized dashboards based on their roles.

**Current Status:** 70% complete
- MemberDashboard.tsx shows role-based content
- Admin routes exist

**Gaps to Implement:**
- [ ] Dashboard widget customization (add/remove/reorder)
- [ ] Role-specific default dashboards
- [ ] Reporting progress indicators
- [ ] Quick action shortcuts per role

---

#### UI-AGG-003: Responsive and Inclusive Design
**Description:** The system shall provide a responsive interface across devices and include accessibility features such as screen reader compatibility, color contrast tools, and etc.

**Acceptance Criteria:** System is functional on all devices and meets accessibility compliance.

**Current Status:** 80% complete
- Tailwind CSS responsive utilities
- shadcn/ui (accessibility-focused components)
- Mobile-friendly layouts

**Gaps to Implement:**
- [ ] Accessibility audit (WCAG 2.1 AA compliance)
- [ ] Screen reader testing and fixes
- [ ] High contrast mode toggle
- [ ] Keyboard navigation improvements

---

#### UI-AGG-004: Communication: Task & Notification Management
**Description:** The system shall enable automated and customizable notification messages and task reminders that alert users of pending actions and updates, both on the platform and via email.

**Acceptance Criteria:** Users receive timely and relevant notifications and reminders.

**Current Status:** 25% complete
- Email sending via SendGrid exists
- No in-app notifications

**Gaps to Implement:**
- [ ] In-app notification system (bell icon, notification panel)
- [ ] Notification preferences (email, in-app, frequency)
- [ ] Task reminder scheduling
- [ ] Customizable notification templates
- [ ] Mark as read/unread functionality

---

#### UI-AGG-005: Content Navigation & Interaction
**Description:** The system shall allow users to efficiently locate and interact with information using robust categorization, search and filtering capabilities.

**Acceptance Criteria:** Users can retrieve accurate results through search and filter functions.

**Current Status:** 40% complete
- Data tables with basic filtering
- No global search

**Gaps to Implement:**
- [ ] Global search across all entities
- [ ] Advanced filtering UI (multiple criteria)
- [ ] Saved search/filter presets
- [ ] Search result highlighting
- [ ] Category-based navigation

---

#### UI-AGG-006: User Support & Feedback Mechanism
**Description:** The system shall enable users to submit support inquiries and feedback and allow administrators to respond through a managed interface.

**Acceptance Criteria:** Users can submit and receive responses to inquiries within the system.

**Current Status:** 0% complete
- No support system exists

**Gaps to Implement:**
- [ ] Support ticket submission form
- [ ] Ticket tracking (open, in progress, resolved)
- [ ] Admin ticket management interface
- [ ] Email notifications for ticket updates
- [ ] Feedback collection (ratings, comments)

---

#### UI-AGG-007: Consistent Visual Language & Branding
**Description:** The system shall maintain a consistent design style, color scheme, and branding across all modules.

**Acceptance Criteria:** All UI components follow a standardized visual style.

**Current Status:** 85% complete
- shadcn/ui component library
- Tailwind theme configuration
- Consistent styling across features

**Gaps to Implement:**
- [ ] Brand guidelines documentation
- [ ] Theme customization for white-labeling (if needed)
- [ ] Component style audit for consistency

---

### TRAINING & ONBOARDING

#### TO-AGG-001: Template Support & Integration
**Description:** The system shall provide a centralized templates tab and offer contextual template access directly from each data entry item to guide users through required formats.

**Acceptance Criteria:** Users can easily locate and access the correct template when needed.

**Current Status:** 0% complete
- No template system exists

**Gaps to Implement:**
- [ ] Templates library page
- [ ] Template categorization
- [ ] Contextual template suggestions in forms
- [ ] Template download/preview functionality

---

#### TO-AGG-002: Guided Learning & Walkthroughs
**Description:** The system shall offer onboarding and data upload tutorials to help users navigate key processes, especially during their first-time use.

**Acceptance Criteria:** Users can complete tasks independently with support from walkthroughs.

**Current Status:** 20% complete
- Onboarding route exists for profile completion
- No interactive tutorials

**Gaps to Implement:**
- [ ] Interactive walkthrough system (step-by-step tooltips)
- [ ] First-time user detection and onboarding flow
- [ ] Feature tours for key functionality
- [ ] Progress tracking for onboarding completion

---

#### TO-AGG-003: Reference Materials & Support
**Description:** The system shall provide categorized guides and a frequently asked questions (FAQ) section to help users resolve issues and understand system functionality.

**Acceptance Criteria:** Users can find accurate answers and instructional material without needing direct support.

**Current Status:** 0% complete
- No help system exists

**Gaps to Implement:**
- [ ] Help center / documentation pages
- [ ] FAQ section with search
- [ ] Categorized guides (by feature area)
- [ ] Contextual help links from UI

---

## Context: viaSport SIN Project

viaSport BC is replacing legacy systems with a modern platform for B.C. amateur sport data management.

**Key Context:**
- Users: Sport organizations, administrators, provincial staff
- Primary use: Data submission, reporting, analytics
- User experience is critical for adoption

## Existing Patterns to Follow

```typescript
// Dashboard pattern (see MemberDashboard.tsx)
export function Dashboard() {
  const { data } = useSuspenseQuery(queryOptions);
  return <Card>...</Card>;
}

// Email pattern (see sendgrid.ts)
await sendEmail({ to, subject, html });

// Query pattern (see members.queries.ts, events.queries.ts)
export const getData = createServerFn()
  .handler(async () => {
    return db.select().from(table);
  });
```
</file>

<file path="src/routes/onboarding/index.tsx">
import { createFileRoute } from "@tanstack/react-router";
import { CompleteProfileForm } from "~/features/profile/components/complete-profile-form-simple";

export const Route = createFileRoute("/onboarding/")({
  component: OnboardingPage,
});

function OnboardingPage() {
  return (
    <div className="container mx-auto max-w-2xl py-8">
      <div className="mb-8">
        <h1 className="text-3xl font-bold">Complete Your Profile</h1>
        <p className="text-muted-foreground mt-2">
          Please provide the following information to complete your membership
          registration.
        </p>
      </div>
      <CompleteProfileForm />
    </div>
  );
}
</file>

<file path="src/routes/onboarding/route.tsx">
import { createFileRoute, redirect } from "@tanstack/react-router";
import { AdminLayout } from "~/features/layouts/admin-layout";

export const Route = createFileRoute("/onboarding")({
  component: OnboardingLayout,
  beforeLoad: async ({ context }) => {
    // First check if user is authenticated
    if (!context.user) {
      throw redirect({ to: "/auth/login" });
    }

    // Check if profile is already complete
    if (context.user.profileComplete) {
      throw redirect({ to: "/dashboard" });
    }
  },
});

function OnboardingLayout() {
  return <AdminLayout />;
}
</file>

<file path="src/shared/lib/utils.ts">
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="src/components/ui/alert.tsx">
import { cva, type VariantProps } from "class-variance-authority";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  );
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className,
      )}
      {...props}
    />
  );
}

function AlertDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className,
      )}
      {...props}
    />
  );
}

export { Alert, AlertDescription, AlertTitle };
</file>

<file path="src/components/ui/avatar.tsx">
import * as AvatarPrimitive from "@radix-ui/react-avatar";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className,
      )}
      {...props}
    />
  );
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  );
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className,
      )}
      {...props}
    />
  );
}

export { Avatar, AvatarFallback, AvatarImage };
</file>

<file path="src/components/ui/badge.tsx">
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline: "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span";

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  );
}

export { Badge, badgeVariants };
</file>

<file path="src/components/ui/button.tsx">
import { Slot } from "@radix-ui/react-slot";
import { cva, type VariantProps } from "class-variance-authority";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
        destructive:
          "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean;
  }) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  );
}

export { Button, buttonVariants };
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className,
      )}
      {...props}
    />
  );
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className,
      )}
      {...props}
    />
  );
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  );
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className,
      )}
      {...props}
    />
  );
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return <div data-slot="card-content" className={cn("px-6", className)} {...props} />;
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  );
}

export {
  Card,
  CardAction,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
};
</file>

<file path="src/components/ui/checkbox.tsx">
import * as CheckboxPrimitive from "@radix-ui/react-checkbox";
import { CheckIcon } from "lucide-react";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="flex items-center justify-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  );
}

export { Checkbox };
</file>

<file path="src/components/ui/data-state.tsx">
import { AlertCircle } from "lucide-react";
import { Button } from "~/components/ui/button";

interface DataErrorStateProps {
  title?: string;
  description?: string | undefined;
  retryLabel?: string;
  onRetry?: () => void;
}

export function DataErrorState({
  title = "Something went wrong",
  description = "We couldnâ€™t load this data. Please try again in a moment.",
  retryLabel = "Retry",
  onRetry,
}: DataErrorStateProps) {
  return (
    <div className="border-destructive/20 bg-destructive/10 flex flex-col items-center justify-center gap-4 rounded-xl border p-6 text-center">
      <div className="text-destructive flex items-center gap-2">
        <AlertCircle className="h-5 w-5" />
        <span className="text-sm font-semibold tracking-wide uppercase">Error</span>
      </div>
      <div className="space-y-2">
        <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
        <p className="text-sm text-gray-600">{description}</p>
      </div>
      {onRetry && (
        <Button
          variant="outline"
          onClick={onRetry}
          className="border-destructive text-destructive hover:bg-destructive/10"
        >
          {retryLabel}
        </Button>
      )}
    </div>
  );
}
</file>

<file path="src/components/ui/dialog.tsx">
import * as DialogPrimitive from "@radix-ui/react-dialog";
import { XIcon } from "lucide-react";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Dialog({ ...props }: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />;
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />;
}

function DialogPortal({ ...props }: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />;
}

function DialogClose({ ...props }: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />;
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean;
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className,
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  );
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  );
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end", className)}
      {...props}
    />
  );
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  );
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
};
</file>

<file path="src/components/ui/dropdown-menu.tsx">
"use client";

import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />;
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />;
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return <DropdownMenuPrimitive.Trigger data-slot="dropdown-menu-trigger" {...props} />;
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className,
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  );
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />;
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked ?? false}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  );
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup data-slot="dropdown-menu-radio-group" {...props} />
  );
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  );
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8", className)}
      {...props}
    />
  );
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function DropdownMenuShortcut({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn("text-muted-foreground ml-auto text-xs tracking-widest", className)}
      {...props}
    />
  );
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />;
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  );
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className,
      )}
      {...props}
    />
  );
}

export {
  DropdownMenu,
  DropdownMenuCheckboxItem,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuPortal,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuTrigger,
};
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className,
      )}
      {...props}
    />
  );
}

export { Input };
</file>

<file path="src/components/ui/label.tsx">
import * as LabelPrimitive from "@radix-ui/react-label";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className,
      )}
      {...props}
    />
  );
}

export { Label };
</file>

<file path="src/components/ui/logo.tsx">
import { useState } from "react";

interface LogoProps {
  className?: string;
  alt?: string;
}

export function Logo({ className, alt = "Quadball Canada logo" }: LogoProps) {
  const [src, setSrc] = useState<string>("/quadball-canada-logo.svg");

  return (
    <img
      src={src}
      alt={alt}
      className={"object-contain " + (className ?? "")}
      onError={() => setSrc("/quadball-canada-logo.jpg")}
    />
  );
}
</file>

<file path="src/components/ui/select.tsx">
import * as SelectPrimitive from "@radix-ui/react-select";
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Select({ ...props }: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />;
}

function SelectGroup({ ...props }: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />;
}

function SelectValue({ ...props }: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />;
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default";
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  );
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className,
        )}
        position={position}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1",
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  );
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  );
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className,
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  );
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn("flex cursor-default items-center justify-center py-1", className)}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  );
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn("flex cursor-default items-center justify-center py-1", className)}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  );
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
};
</file>

<file path="src/components/ui/table.tsx">
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div data-slot="table-container" className="relative w-full overflow-x-auto">
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  );
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  );
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  );
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn("bg-muted/50 border-t font-medium [&>tr]:last:border-b-0", className)}
      {...props}
    />
  );
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className,
      )}
      {...props}
    />
  );
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className,
      )}
      {...props}
    />
  );
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className,
      )}
      {...props}
    />
  );
}

function TableCaption({ className, ...props }: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  );
}

export {
  Table,
  TableBody,
  TableCaption,
  TableCell,
  TableFooter,
  TableHead,
  TableHeader,
  TableRow,
};
</file>

<file path="src/components/ui/tabs.tsx">
import * as TabsPrimitive from "@radix-ui/react-tabs";
import * as React from "react";

import { cn } from "~/shared/lib/utils";

function Tabs({ className, ...props }: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  );
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className,
      )}
      {...props}
    />
  );
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  );
}

export { Tabs, TabsContent, TabsList, TabsTrigger };
</file>

<file path="src/features/dashboard/PublicPortalPage.tsx">
import { Link } from "@tanstack/react-router";
import { ExternalLink, LogIn, UserPlus } from "lucide-react";
import { Button } from "~/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "~/components/ui/card";

/**
 * Public portal page shown to unauthenticated visitors.
 * Directs them to login/signup or the public marketing site.
 */
export function PublicPortalPage() {
  return (
    <div className="flex min-h-screen flex-col items-center justify-center bg-gray-50 px-4">
      <div className="w-full max-w-md space-y-8">
        {/* Logo/Brand */}
        <div className="text-center">
          <h1 className="text-3xl font-bold tracking-tight text-gray-900">
            Quadball Canada
          </h1>
          <p className="mt-2 text-lg text-gray-600">Members Portal</p>
        </div>

        {/* Main Card */}
        <Card>
          <CardHeader className="text-center">
            <CardTitle>Welcome</CardTitle>
            <CardDescription>
              This is the member management system for registered players, teams, and
              officials.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Login Button */}
            <Button asChild className="w-full" size="lg">
              <Link to="/auth/login">
                <LogIn className="mr-2 h-4 w-4" />
                Log in
              </Link>
            </Button>

            {/* Sign Up Button */}
            <Button asChild variant="outline" className="w-full" size="lg">
              <Link to="/auth/signup">
                <UserPlus className="mr-2 h-4 w-4" />
                Create an account
              </Link>
            </Button>

            {/* Divider */}
            <div className="relative py-4">
              <div className="absolute inset-0 flex items-center">
                <span className="w-full border-t" />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                <span className="bg-white px-2 text-gray-500">or</span>
              </div>
            </div>

            {/* Marketing Site Link */}
            <div className="text-center">
              <p className="mb-3 text-sm text-gray-600">
                Looking for general information about Quadball Canada?
              </p>
              <Button asChild variant="ghost" className="text-primary">
                <a
                  href="https://quadballcanada.ca"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Visit quadballcanada.ca
                  <ExternalLink className="ml-2 h-3 w-3" />
                </a>
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Footer */}
        <p className="text-center text-xs text-gray-500">
          &copy; {new Date().getFullYear()} Quadball Canada. All rights reserved.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/features/members/index.ts">
export * from "./members.queries";
export * from "./members.schemas";
export * from "./members.types";
</file>

<file path="src/features/members/members.types.ts">
export type MemberDirectoryErrorCode = "NOT_AUTHENTICATED" | "DATABASE_ERROR";

export interface MemberDirectoryError {
  code: MemberDirectoryErrorCode;
  message: string;
}

export interface MemberDirectoryMembershipSummary {
  status: "active" | "expired" | "cancelled";
  membershipType: string | null;
  startDate: string | null;
  endDate: string | null;
}

export interface MemberDirectoryMember {
  id: string;
  name: string;
  email: string | null;
  emailVisible: boolean;
  phone: string | null;
  phoneVisible: boolean;
  pronouns: string | null;
  teams: string[];
  membershipStatus: "active" | "expired" | "cancelled" | "none";
  membershipType: string | null;
  membershipEndDate: string | null;
  hasActiveMembership: boolean;
  allowTeamInvitations: boolean;
  birthYear: number | null;
  birthYearVisible: boolean;
  profileUpdatedAt: string | null;
  membershipHistory: MemberDirectoryMembershipSummary[];
}

export interface MemberDirectoryPagination {
  total: number;
  limit: number;
  offset: number;
  hasMore: boolean;
}

export interface MemberDirectoryResponse {
  members: MemberDirectoryMember[];
  pagination: MemberDirectoryPagination;
}

export interface MemberDirectoryOperationResult<TData> {
  success: boolean;
  data?: TData;
  errors?: MemberDirectoryError[];
}
</file>

<file path="src/features/membership/components/admin-memberships-report.tsx">
import { useQuery } from "@tanstack/react-query";
import { type ColumnDef } from "@tanstack/react-table";
import { useState } from "react";
import { DataTable } from "~/components/ui/data-table";
import { exportToCSV, formatCurrency, formatDate } from "~/lib/utils/csv-export";
import { getAllMemberships, type MembershipReportRow } from "../membership.admin-queries";

const columns: ColumnDef<MembershipReportRow>[] = [
  {
    accessorKey: "userName",
    header: "User Name",
  },
  {
    accessorKey: "userEmail",
    header: "Email",
  },
  {
    accessorKey: "membershipType",
    header: "Membership Type",
  },
  {
    accessorKey: "startDate",
    header: "Start Date",
    cell: ({ row }) => formatDate(row.getValue("startDate")),
  },
  {
    accessorKey: "endDate",
    header: "End Date",
    cell: ({ row }) => formatDate(row.getValue("endDate")),
  },
  {
    accessorKey: "status",
    header: "Status",
    cell: ({ row }) => {
      const status = row.getValue("status") as string;
      return (
        <span
          className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
            status === "active"
              ? "bg-green-100 text-green-800"
              : status === "expired"
                ? "bg-gray-100 text-gray-800"
                : "bg-red-100 text-red-800"
          }`}
        >
          {status}
        </span>
      );
    },
  },
  {
    accessorKey: "priceCents",
    header: "Price",
    cell: ({ row }) => formatCurrency(row.getValue("priceCents")),
  },
  {
    accessorKey: "paymentId",
    header: "Payment ID",
    cell: ({ row }) => row.getValue("paymentId") || "-",
  },
  {
    accessorKey: "createdAt",
    header: "Created At",
    cell: ({ row }) => formatDate(row.getValue("createdAt")),
  },
];

export function AdminMembershipsReport() {
  const [statusFilter, setStatusFilter] = useState<
    "all" | "active" | "expired" | "cancelled"
  >("all");

  const { data, isLoading, error } = useQuery({
    queryKey: ["admin-memberships", statusFilter],
    queryFn: async () => {
      const result = await getAllMemberships({ data: { status: statusFilter } });
      return result;
    },
  });

  const handleExport = () => {
    if (data?.data) {
      const exportData = data.data.map((row) => ({
        "User Name": row.userName,
        Email: row.userEmail,
        "Membership Type": row.membershipType,
        "Start Date": formatDate(row.startDate),
        "End Date": formatDate(row.endDate),
        Status: row.status,
        Price: formatCurrency(row.priceCents),
        "Payment ID": row.paymentId || "-",
        "Created At": formatDate(row.createdAt),
      }));

      const filename = `memberships-report-${new Date().toISOString().split("T")[0]}.csv`;
      exportToCSV(exportData, filename);
    }
  };

  if (isLoading) {
    return (
      <div className="flex h-64 items-center justify-center">
        <div className="text-muted-foreground">Loading memberships...</div>
      </div>
    );
  }

  if (error || !data?.success) {
    const errorMessage = data?.errors?.[0]?.message || "Failed to load memberships";

    // Check if it's an admin access error
    if (errorMessage === "Admin access required") {
      return (
        <div className="border-destructive/50 bg-destructive/10 rounded-lg border p-6">
          <h3 className="text-destructive text-lg font-semibold">Access Denied</h3>
          <p className="text-muted-foreground mt-2">
            You do not have permission to view this report. Admin access is required.
          </p>
        </div>
      );
    }

    return (
      <div className="border-destructive/50 bg-destructive/10 rounded-lg border p-6">
        <h3 className="text-destructive text-lg font-semibold">Error Loading Report</h3>
        <p className="text-muted-foreground mt-2">{errorMessage}</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold tracking-tight">Memberships Report</h2>
          <p className="text-muted-foreground">
            View and export all membership data across the platform
          </p>
        </div>
        <div className="flex items-center gap-4">
          <select
            value={statusFilter}
            onChange={(e) =>
              setStatusFilter(
                e.target.value as "all" | "active" | "expired" | "cancelled",
              )
            }
            className="border-input bg-background ring-offset-background focus-visible:ring-ring rounded-md border px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none"
          >
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="expired">Expired</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>

      <DataTable
        columns={columns}
        data={data.data || []}
        pageSize={20}
        onExport={handleExport}
      />
    </div>
  );
}
</file>

<file path="src/features/profile/hooks/useProfileFormReducer.ts">
import { useReducer } from "react";
import type { ProfileInputType } from "~/features/profile/profile.schemas";

export type StepId = "personal" | "emergency" | "privacy";

interface ProfileFormState {
  currentStep: StepId;
  isSubmitting: boolean;
  error: string | null;
  formData: ProfileInputType;
  emergencyContactStarted: boolean;
}

type ProfileFormAction =
  | { type: "SET_STEP"; step: StepId }
  | { type: "SET_SUBMITTING"; isSubmitting: boolean }
  | { type: "SET_ERROR"; error: string | null }
  | { type: "UPDATE_FORM_DATA"; data: Partial<ProfileInputType> }
  | { type: "SET_EMERGENCY_STARTED"; started: boolean }
  | { type: "RESET_FORM" }
  | { type: "SUBMIT_START" }
  | { type: "SUBMIT_SUCCESS" }
  | { type: "SUBMIT_ERROR"; error: string };

const initialState: ProfileFormState = {
  currentStep: "personal",
  isSubmitting: false,
  error: null,
  formData: {
    dateOfBirth: new Date(),
    gender: "",
    pronouns: "",
    phone: "",
    emergencyContact: undefined,
    privacySettings: {
      showEmail: false,
      showPhone: false,
      showBirthYear: false,
      allowTeamInvitations: true,
    },
  },
  emergencyContactStarted: false,
};

function profileFormReducer(
  state: ProfileFormState,
  action: ProfileFormAction,
): ProfileFormState {
  switch (action.type) {
    case "SET_STEP":
      return { ...state, currentStep: action.step, error: null };

    case "SET_SUBMITTING":
      return { ...state, isSubmitting: action.isSubmitting };

    case "SET_ERROR":
      return { ...state, error: action.error };

    case "UPDATE_FORM_DATA":
      return {
        ...state,
        formData: { ...state.formData, ...action.data },
      };

    case "SET_EMERGENCY_STARTED":
      return { ...state, emergencyContactStarted: action.started };

    case "RESET_FORM":
      return initialState;

    case "SUBMIT_START":
      return { ...state, isSubmitting: true, error: null };

    case "SUBMIT_SUCCESS":
      return { ...state, isSubmitting: false, error: null };

    case "SUBMIT_ERROR":
      return { ...state, isSubmitting: false, error: action.error };

    default:
      return state;
  }
}

/**
 * Custom hook for managing profile form state with a reducer
 * Groups related state together and provides consistent update patterns
 */
export function useProfileFormReducer() {
  const [state, dispatch] = useReducer(profileFormReducer, initialState);

  return {
    state,
    dispatch,
    // Convenience methods
    setStep: (step: StepId) => dispatch({ type: "SET_STEP", step }),
    updateFormData: (data: Partial<ProfileInputType>) =>
      dispatch({ type: "UPDATE_FORM_DATA", data }),
    setEmergencyStarted: (started: boolean) =>
      dispatch({ type: "SET_EMERGENCY_STARTED", started }),
    submitStart: () => dispatch({ type: "SUBMIT_START" }),
    submitSuccess: () => dispatch({ type: "SUBMIT_SUCCESS" }),
    submitError: (error: string) => dispatch({ type: "SUBMIT_ERROR", error }),
    resetForm: () => dispatch({ type: "RESET_FORM" }),
  };
}
</file>

<file path="src/lib/utils/csv-export.ts">
/**
 * Utility for exporting data to CSV format
 */

export function exportToCSV<T extends Record<string, unknown>>(
  data: T[],
  filename: string,
  headers?: { [K in keyof T]?: string },
) {
  if (data.length === 0) {
    console.warn("No data to export");
    return;
  }

  // Get all unique keys from the data
  const keys = Object.keys(data[0]) as (keyof T)[];

  // Create header row
  const headerRow = keys
    .map((key) => {
      const headerLabel = headers?.[key] || String(key);
      // Escape quotes and wrap in quotes if needed
      return `"${String(headerLabel).replace(/"/g, '""')}"`;
    })
    .join(",");

  // Create data rows
  const dataRows = data.map((row) => {
    return keys
      .map((key) => {
        const value = row[key];

        // Handle different value types
        if (value === null || value === undefined) {
          return "";
        }

        if (value instanceof Date) {
          return `"${value.toISOString()}"`;
        }

        if (typeof value === "object") {
          return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
        }

        // Convert to string and escape quotes
        const stringValue = String(value);

        // Wrap in quotes if contains comma, newline, or quotes
        if (
          stringValue.includes(",") ||
          stringValue.includes("\n") ||
          stringValue.includes('"')
        ) {
          return `"${stringValue.replace(/"/g, '""')}"`;
        }

        return stringValue;
      })
      .join(",");
  });

  // Combine header and data
  const csvContent = [headerRow, ...dataRows].join("\n");

  // Create blob and download
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");

  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }
}

/**
 * Format currency for display
 */
export function formatCurrency(cents: number): string {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(cents / 100);
}

/**
 * Format date for display
 */
export function formatDate(date: string | Date): string {
  const d = typeof date === "string" ? new Date(date) : date;
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  }).format(d);
}
</file>

<file path="src/shared/contexts/ThemeContext.tsx">
import { createContext, ReactNode, use } from "react";
import { useTheme as useThemeHook } from "~/shared/hooks/useTheme";

interface ThemeContextValue {
  theme: "light" | "dark" | "system";
  resolvedTheme: "light" | "dark";
  setTheme: (theme: "light" | "dark" | "system") => void;
  toggleTheme: () => void;
}

const ThemeContext = createContext<ThemeContextValue | undefined>(undefined);

/**
 * Theme provider that wraps the app and provides theme state to all children
 * This prevents prop drilling for theme-related functionality
 */
export function ThemeProvider({ children }: { children: ReactNode }) {
  const themeValue = useThemeHook();

  return <ThemeContext value={themeValue}>{children}</ThemeContext>;
}

/**
 * Hook to access theme context
 * Must be used within a ThemeProvider
 *
 * @example
 * const { theme, toggleTheme } = useTheme();
 */
export function useTheme() {
  const context = use(ThemeContext);

  if (!context) {
    throw new Error("useTheme must be used within a ThemeProvider");
  }

  return context;
}
</file>

<file path="src/shared/hooks/useAsyncState.ts">
import { useCallback, useState } from "react";

type AsyncState<T> =
  | { status: "idle" }
  | { status: "loading" }
  | { status: "success"; data: T }
  | { status: "error"; error: string };

/**
 * Custom hook for managing async state without contradictions
 * Ensures states like loading/error/success are mutually exclusive
 *
 * @example
 * const { state, execute, reset } = useAsyncState<UserData>();
 *
 * const handleSubmit = async () => {
 *   await execute(async () => {
 *     const data = await fetchUserData();
 *     return data;
 *   });
 * };
 *
 * if (state.status === 'loading') return <Spinner />;
 * if (state.status === 'error') return <Error message={state.error} />;
 * if (state.status === 'success') return <Success data={state.data} />;
 */
export function useAsyncState<T>() {
  const [state, setState] = useState<AsyncState<T>>({ status: "idle" });

  const execute = useCallback(async (asyncFunction: () => Promise<T>) => {
    setState({ status: "loading" });

    try {
      const data = await asyncFunction();
      setState({ status: "success", data });
      return data;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : "An error occurred";
      setState({ status: "error", error: errorMessage });
      throw error;
    }
  }, []);

  const reset = useCallback(() => {
    setState({ status: "idle" });
  }, []);

  const setError = useCallback((error: string) => {
    setState({ status: "error", error });
  }, []);

  const setData = useCallback((data: T) => {
    setState({ status: "success", data });
  }, []);

  return {
    state,
    execute,
    reset,
    setError,
    setData,
    isIdle: state.status === "idle",
    isLoading: state.status === "loading",
    isSuccess: state.status === "success",
    isError: state.status === "error",
  };
}
</file>

<file path="src/shared/hooks/useFocusOnMount.ts">
import { useEffect, useRef } from "react";

/**
 * Custom hook to focus an element when the component mounts
 * Useful for improving form UX by automatically focusing the first input
 *
 * @example
 * const emailInputRef = useFocusOnMount<HTMLInputElement>();
 *
 * return <input ref={emailInputRef} type="email" />
 */
export function useFocusOnMount<T extends HTMLElement = HTMLElement>(shouldFocus = true) {
  const elementRef = useRef<T>(null);

  useEffect(() => {
    if (shouldFocus && elementRef.current) {
      // Use setTimeout to ensure the element is fully rendered
      const timeoutId = setTimeout(() => {
        elementRef.current?.focus();
      }, 0);

      return () => clearTimeout(timeoutId);
    }
  }, [shouldFocus]);

  return elementRef;
}

/**
 * Create refs for managing focus between multiple elements
 * Useful for form navigation with keyboard (Tab, Shift+Tab)
 *
 * @example
 * const focusManager = createFocusManager(3);
 *
 * return (
 *   <>
 *     <input ref={focusManager.refs[0]} onKeyDown={(e) => e.key === 'Enter' && focusManager.focusNext(0)} />
 *     <input ref={focusManager.refs[1]} />
 *     <input ref={focusManager.refs[2]} />
 *   </>
 * )
 */
export function createFocusManager<T extends HTMLElement = HTMLElement>(count: number) {
  const refs = Array.from({ length: count }, () => ({ current: null as T | null }));

  const focusNext = (currentIndex: number) => {
    const nextIndex = (currentIndex + 1) % count;
    refs[nextIndex].current?.focus();
  };

  const focusPrevious = (currentIndex: number) => {
    const prevIndex = (currentIndex - 1 + count) % count;
    refs[prevIndex].current?.focus();
  };

  const focusFirst = () => {
    refs[0].current?.focus();
  };

  const focusLast = () => {
    refs[count - 1].current?.focus();
  };

  return {
    refs,
    focusNext,
    focusPrevious,
    focusFirst,
    focusLast,
  };
}
</file>

<file path="src/shared/hooks/useLocalStorage.ts">
import { useCallback, useEffect, useState } from "react";

/**
 * Custom hook for syncing state with localStorage
 * Handles SSR gracefully and provides error handling
 *
 * @example
 * const [theme, setTheme] = useLocalStorage('theme', 'light');
 */
export function useLocalStorage<T>(
  key: string,
  initialValue: T,
  options?: {
    serialize?: (value: T) => string;
    deserialize?: (value: string) => T;
  },
): [T, (value: T | ((prev: T) => T)) => void, () => void] {
  const serialize = options?.serialize || JSON.stringify;
  const deserialize = options?.deserialize || JSON.parse;

  // Initialize state with a function to handle SSR
  const [storedValue, setStoredValue] = useState<T>(() => {
    if (typeof window === "undefined") {
      return initialValue;
    }

    try {
      const item = window.localStorage.getItem(key);
      return item ? deserialize(item) : initialValue;
    } catch (error) {
      console.error(`Error loading localStorage key "${key}":`, error);
      return initialValue;
    }
  });

  // Wrapped setValue function that persists to localStorage
  const setValue = useCallback(
    (value: T | ((prev: T) => T)) => {
      try {
        // Allow value to be a function so we have the same API as useState
        const valueToStore = value instanceof Function ? value(storedValue) : value;

        setStoredValue(valueToStore);

        if (typeof window !== "undefined") {
          window.localStorage.setItem(key, serialize(valueToStore));
        }
      } catch (error) {
        console.error(`Error setting localStorage key "${key}":`, error);
      }
    },
    [key, serialize, storedValue],
  );

  // Remove value from localStorage
  const removeValue = useCallback(() => {
    try {
      setStoredValue(initialValue);
      if (typeof window !== "undefined") {
        window.localStorage.removeItem(key);
      }
    } catch (error) {
      console.error(`Error removing localStorage key "${key}":`, error);
    }
  }, [key, initialValue]);

  // Listen for changes in other tabs/windows
  useEffect(() => {
    if (typeof window === "undefined") return;

    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === key && e.newValue !== null) {
        try {
          setStoredValue(deserialize(e.newValue));
        } catch (error) {
          console.error(`Error syncing localStorage key "${key}":`, error);
        }
      }
    };

    window.addEventListener("storage", handleStorageChange);
    return () => window.removeEventListener("storage", handleStorageChange);
  }, [key, deserialize]);

  return [storedValue, setValue, removeValue];
}

/**
 * Custom hook for simple localStorage operations without state sync
 * Useful for one-time reads/writes
 *
 * @example
 * const storage = useLocalStorageValue('user-preferences');
 * storage.set({ theme: 'dark' });
 * const prefs = storage.get();
 */
export function useLocalStorageValue<T>(key: string) {
  const get = useCallback((): T | null => {
    if (typeof window === "undefined") return null;

    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    } catch (error) {
      console.error(`Error reading localStorage key "${key}":`, error);
      return null;
    }
  }, [key]);

  const set = useCallback(
    (value: T) => {
      if (typeof window === "undefined") return;

      try {
        window.localStorage.setItem(key, JSON.stringify(value));
      } catch (error) {
        console.error(`Error writing localStorage key "${key}":`, error);
      }
    },
    [key],
  );

  const remove = useCallback(() => {
    if (typeof window === "undefined") return;

    try {
      window.localStorage.removeItem(key);
    } catch (error) {
      console.error(`Error removing localStorage key "${key}":`, error);
    }
  }, [key]);

  return { get, set, remove };
}
</file>

<file path="src/shared/hooks/useTheme.ts">
import { useCallback, useEffect, useLayoutEffect, useState } from "react";

export type Theme = "light" | "dark" | "system";

// Use useLayoutEffect on client, useEffect on server
const useIsomorphicLayoutEffect =
  typeof window !== "undefined" ? useLayoutEffect : useEffect;

export function useTheme() {
  const [theme, setTheme] = useState<Theme>(() => {
    if (typeof window !== "undefined") {
      const storedTheme = localStorage.getItem("theme");
      if (["light", "dark", "system"].includes(storedTheme!)) {
        return storedTheme as Theme;
      }
    }
    return "system";
  });

  const [systemTheme, setSystemTheme] = useState<"light" | "dark">(() => {
    if (typeof window !== "undefined") {
      return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }
    return "light";
  });

  useIsomorphicLayoutEffect(() => {
    const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
    const updateSystemTheme = (e: MediaQueryListEvent) => {
      setSystemTheme(e.matches ? "dark" : "light");
    };

    mediaQuery.addEventListener("change", updateSystemTheme);

    return () => mediaQuery.removeEventListener("change", updateSystemTheme);
  }, []);

  const resolvedTheme = theme === "system" ? systemTheme : theme;

  useIsomorphicLayoutEffect(() => {
    const root = document.documentElement;
    root.classList.toggle("dark", resolvedTheme === "dark");
  }, [resolvedTheme]);

  useEffect(() => {
    localStorage.setItem("theme", theme);
  }, [theme]);

  const toggleTheme = useCallback(() => {
    setTheme((prevTheme) => {
      if (prevTheme === "light") return "dark";
      if (prevTheme === "dark") return "light";
      // For system theme, check current preference without external dependency
      const isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      return isDark ? "light" : "dark";
    });
  }, []);

  return {
    theme,
    setTheme,
    resolvedTheme,
    toggleTheme,
  };
}
</file>

<file path="src/components/ui/breadcrumbs.tsx">
import { Link, useRouterState } from "@tanstack/react-router";

const LABEL_OVERRIDES: Record<string, string> = {
  dashboard: "Dashboard",
  admin: "Admin",
  teams: "Teams",
  events: "Events",
  members: "Members",
  membership: "Membership",
  profile: "Profile",
  settings: "Settings",
  reports: "Reports",
  roles: "Roles",
  forbidden: "Forbidden",
  manage: "Manage",
};

function formatSegment(segment: string): string {
  if (LABEL_OVERRIDES[segment]) {
    return LABEL_OVERRIDES[segment];
  }

  const clean = segment.replace(/[-_]/g, " ");
  return clean.charAt(0).toUpperCase() + clean.slice(1);
}

export function Breadcrumbs() {
  const location = useRouterState({ select: (state) => state.location });
  const segments = location.pathname.split("/").filter(Boolean);

  if (segments.length <= 1) {
    return null;
  }

  const crumbs = segments
    .map((segment, index) => ({ segment, index }))
    .filter(({ index }) => index !== 0) // skip the root dashboard node; rendered separately below
    .map(({ segment, index }) => {
      const href = `/${segments.slice(0, index + 1).join("/")}`;
      const label = formatSegment(segment);
      const isLast = index === segments.length - 1;

      const node = isLast ? (
        <span className="text-muted-foreground">{label}</span>
      ) : (
        <Link to={href} className="text-muted-foreground hover:text-foreground">
          {label}
        </Link>
      );

      return { key: href, node };
    });

  return (
    <nav aria-label="Breadcrumb" className="text-sm">
      <ol className="text-muted-foreground flex flex-wrap items-center gap-2">
        <li>
          <Link to="/dashboard" className="hover:text-foreground">
            Dashboard
          </Link>
        </li>
        {crumbs.map((crumb) => (
          <li key={crumb.key} className="flex items-center gap-2">
            <span aria-hidden="true">/</span>
            {crumb.node}
          </li>
        ))}
      </ol>
    </nav>
  );
}
</file>

<file path="src/components/ui/data-table.tsx">
import {
  ColumnDef,
  flexRender,
  getCoreRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  SortingState,
  useReactTable,
  VisibilityState,
} from "@tanstack/react-table";
import { ArrowUpDown } from "lucide-react";
import { useState } from "react";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "~/components/ui/table";
import { Button } from "./button";
import {
  DropdownMenu,
  DropdownMenuCheckboxItem,
  DropdownMenuContent,
  DropdownMenuTrigger,
} from "./dropdown-menu";

interface DataTableProps<TData, TValue> {
  columns: ColumnDef<TData, TValue>[];
  data: TData[];
  pageSize?: number;
  onExport?: () => void;
  enableColumnToggle?: boolean;
}

export function DataTable<TData, TValue>({
  columns,
  data,
  pageSize = 10,
  onExport,
  enableColumnToggle = true,
}: DataTableProps<TData, TValue>) {
  const [sorting, setSorting] = useState<SortingState>([]);
  const [columnVisibility, setColumnVisibility] = useState<VisibilityState>({});

  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    onSortingChange: setSorting,
    getSortedRowModel: getSortedRowModel(),
    onColumnVisibilityChange: setColumnVisibility,
    state: {
      sorting,
      columnVisibility,
    },
    initialState: {
      pagination: {
        pageSize,
      },
    },
  });

  const canRenderToolbar = enableColumnToggle || Boolean(onExport);

  return (
    <div className="space-y-4">
      {canRenderToolbar && (
        <div className="flex items-center justify-between">
          {enableColumnToggle ? (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="outline" className="ml-auto">
                  Columns
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                {table
                  .getAllColumns()
                  .filter((column) => column.getCanHide())
                  .map((column) => {
                    return (
                      <DropdownMenuCheckboxItem
                        key={column.id}
                        className="capitalize"
                        checked={column.getIsVisible()}
                        onCheckedChange={(value) => column.toggleVisibility(!!value)}
                      >
                        {column.id}
                      </DropdownMenuCheckboxItem>
                    );
                  })}
              </DropdownMenuContent>
            </DropdownMenu>
          ) : (
            <span />
          )}
          {onExport && (
            <Button onClick={onExport} variant="outline">
              Export CSV
            </Button>
          )}
        </div>
      )}
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            {table.getHeaderGroups().map((headerGroup) => (
              <TableRow key={headerGroup.id}>
                {headerGroup.headers.map((header) => {
                  return (
                    <TableHead key={header.id}>
                      {header.isPlaceholder ? null : (
                        <div className="flex items-center space-x-2">
                          {flexRender(
                            header.column.columnDef.header,
                            header.getContext(),
                          )}
                          {header.column.getCanSort() && (
                            <Button
                              variant="ghost"
                              size="sm"
                              className="data-[state=open]:bg-accent -ml-3 h-8"
                              onClick={header.column.getToggleSortingHandler()}
                            >
                              <ArrowUpDown className="h-4 w-4" />
                            </Button>
                          )}
                        </div>
                      )}
                    </TableHead>
                  );
                })}
              </TableRow>
            ))}
          </TableHeader>
          <TableBody>
            {table.getRowModel().rows?.length ? (
              table.getRowModel().rows.map((row) => (
                <TableRow key={row.id} data-state={row.getIsSelected() && "selected"}>
                  {row.getVisibleCells().map((cell) => (
                    <TableCell key={cell.id}>
                      {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </TableCell>
                  ))}
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={columns.length} className="h-24 text-center">
                  No results.
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>
      <div className="flex items-center justify-end space-x-2">
        <Button
          variant="outline"
          size="sm"
          onClick={() => table.previousPage()}
          disabled={!table.getCanPreviousPage()}
        >
          Previous
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={() => table.nextPage()}
          disabled={!table.getCanNextPage()}
        >
          Next
        </Button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/icons.tsx">
import type { SVGProps } from "react";

export function GoogleIcon(props: SVGProps<SVGSVGElement>) {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" {...props}>
      <path
        d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"
        fill="currentColor"
      />
    </svg>
  );
}

// Re-export commonly used Lucide icons for consistency
export {
  AlertCircle,
  ArrowLeft as ArrowLeftIcon,
  Calendar,
  Calendar as CalendarIcon,
  CheckCircle2,
  Check as CheckIcon,
  ChevronsUpDown as ChevronsUpDownIcon,
  Clock,
  CreditCard,
  Download as DownloadIcon,
  Link as LinkIcon,
  Loader2,
  LoaderCircle as LoaderIcon,
  GalleryVerticalEnd as LogoIcon,
  MapPin as MapPinIcon,
  MoonIcon,
  Palette as PaletteIcon,
  Plus as PlusIcon,
  Search as SearchIcon,
  SunIcon,
  Trophy,
  User,
  UserPlus,
  Users,
  Users as UsersIcon,
  XCircle,
} from "lucide-react";
</file>

<file path="src/features/layouts/__tests__/admin-layout.test.tsx">
import { beforeEach, describe, expect, it, vi } from "vitest";
import { renderWithRouter, screen } from "~/tests/utils";
import { AdminLayout } from "../admin-layout";

// Mock auth signOut
vi.mock("~/lib/auth-client", () => ({
  auth: {
    signOut: vi.fn(),
  },
}));

describe("AdminLayout with Router", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("renders admin layout with navigation", async () => {
    await renderWithRouter(<AdminLayout />);

    // Check navigation elements - Dashboard appears multiple times
    const dashboardTexts = screen.getAllByText("Dashboard");
    expect(dashboardTexts.length).toBeGreaterThanOrEqual(2);
    expect(screen.getByText("Teams")).toBeInTheDocument();
    expect(screen.getByText("Events")).toBeInTheDocument();

    // Check admin panel header - use getAllByText since it appears in both desktop and mobile views
    const quadballTexts = screen.getAllByText("Quadball Canada");
    expect(quadballTexts).toHaveLength(2); // One for desktop, one for mobile

    // "Admin Panel" text was changed to "Dashboard" in mobile view
    expect(screen.getByText("Admin Panel")).toBeInTheDocument(); // Mobile header still shows Admin Panel
  });

  it("renders with user context", async () => {
    const customUser = {
      id: "admin-user",
      name: "Admin User",
      email: "admin@example.com",
      emailVerified: true,
      image: null,
      createdAt: new Date(),
      updatedAt: new Date(),
      profileComplete: true,
      dateOfBirth: new Date("1990-01-01"),
      phone: "+1234567890",
      gender: "male" as const,
      pronouns: "he/him",
      emergencyContact: JSON.stringify({
        name: "Emergency Contact",
        phone: "+0987654321",
        relationship: "spouse",
      }),
      privacySettings: JSON.stringify({
        showEmail: false,
        showPhone: false,
        showDateOfBirth: false,
      }),
      profileVersion: 1,
      profileUpdatedAt: new Date(),
    };

    await renderWithRouter(<AdminLayout />, { user: customUser });

    // Navigation should still render with custom user
    // Multiple "Dashboard" texts appear (sidebar subtitle and nav link)
    const dashboardTexts = screen.getAllByText("Dashboard");
    expect(dashboardTexts.length).toBeGreaterThanOrEqual(2);

    // Admin Panel still appears in mobile view
    expect(screen.getByText("Admin Panel")).toBeInTheDocument();
  });

  it("handles mobile menu toggle", async () => {
    await renderWithRouter(<AdminLayout />);

    // Mobile menu is hidden by default on desktop
    // The test would need to mock window size to test mobile behavior
    expect(screen.getAllByText("Dashboard")[0]).toBeInTheDocument();
  });

  it("displays all navigation links with correct hrefs", async () => {
    await renderWithRouter(<AdminLayout />);

    const dashboardLinks = screen.getAllByRole("link", { name: /dashboard/i });
    const teamsLinks = screen.getAllByRole("link", { name: /teams/i });
    const eventsLinks = screen.getAllByRole("link", { name: /events/i });

    // Find the navigation links (not header links)
    const dashboardLink = dashboardLinks.find(
      (link) => link.getAttribute("href") === "/dashboard",
    );
    const teamsLink = teamsLinks.find(
      (link) => link.getAttribute("href") === "/dashboard/teams",
    );
    const eventsLink = eventsLinks.find(
      (link) => link.getAttribute("href") === "/dashboard/events",
    );

    expect(dashboardLink).toBeTruthy();
    expect(teamsLink).toBeTruthy();
    expect(eventsLink).toBeTruthy();
  });
});
</file>

<file path="src/features/layouts/admin-layout.tsx">
import { Outlet } from "@tanstack/react-router";
import { X } from "lucide-react";
import { useState } from "react";
import { AdminSidebar } from "~/components/ui/admin-sidebar";
import { Breadcrumbs } from "~/components/ui/breadcrumbs";
import { Button } from "~/components/ui/button";
import { MobileAdminHeader } from "~/components/ui/mobile-admin-header";

export function AdminLayout() {
  const [sidebarOpen, setSidebarOpen] = useState(false);

  return (
    <div className="flex min-h-screen bg-gray-50">
      {/* Desktop Sidebar */}
      <div className="hidden lg:block">
        <AdminSidebar />
      </div>

      {/* Mobile Sidebar Overlay */}
      {sidebarOpen && (
        <div className="fixed inset-0 z-50 lg:hidden">
          <div
            className="fixed inset-0 bg-black/50"
            onClick={() => setSidebarOpen(false)}
          />
          <div className="fixed inset-y-0 left-0 flex w-full max-w-xs flex-col bg-white">
            <div className="flex h-16 items-center justify-between border-b border-gray-200 px-4">
              <h2 className="text-lg font-bold">Menu</h2>
              <Button variant="ghost" size="icon" onClick={() => setSidebarOpen(false)}>
                <X className="h-5 w-5" />
              </Button>
            </div>
            <div className="flex-1 overflow-y-auto">
              <AdminSidebar />
            </div>
          </div>
        </div>
      )}

      {/* Main Content */}
      <div className="flex flex-1 flex-col">
        <MobileAdminHeader onMenuClick={() => setSidebarOpen(true)} />
        <main className="flex-1 p-4 sm:p-6 lg:p-8">
          <div className="mx-auto flex max-w-7xl flex-col gap-6">
            <Breadcrumbs />
            <Outlet />
          </div>
        </main>
      </div>
    </div>
  );
}
</file>

<file path="src/features/layouts/admin-nav.ts">
import type { LucideIcon } from "lucide-react";
import {
  BarChart3,
  Calendar,
  Home,
  Settings,
  ShieldCheck,
  User,
  UserCheck,
  Users,
} from "lucide-react";
import { GLOBAL_ADMIN_ROLE_NAMES } from "~/lib/auth/utils/admin-check";

export type AdminNavItem = {
  label: string;
  to: string;
  icon: LucideIcon;
  exact?: boolean;
  roles?: string[];
};

export const ADMIN_PRIMARY_NAV: AdminNavItem[] = [
  { icon: Home, label: "Dashboard", to: "/dashboard", exact: true },
  { icon: Users, label: "Teams", to: "/dashboard/teams" },
  { icon: Calendar, label: "Events", to: "/dashboard/events" },
  { icon: UserCheck, label: "Members", to: "/dashboard/members" },
  {
    icon: BarChart3,
    label: "Reports",
    to: "/dashboard/reports",
    roles: GLOBAL_ADMIN_ROLE_NAMES,
  },
  {
    icon: ShieldCheck,
    label: "Roles",
    to: "/dashboard/admin/roles",
    roles: GLOBAL_ADMIN_ROLE_NAMES,
  },
];

export const ADMIN_SECONDARY_NAV: AdminNavItem[] = [
  { icon: User, label: "Profile", to: "/dashboard/profile", exact: true },
  { icon: Settings, label: "Settings", to: "/dashboard/settings", exact: true },
];
</file>

<file path="src/features/members/members.schemas.ts">
import { z } from "zod";

export const listMembersSchema = z.object({
  search: z.string().optional(),
  limit: z.int().min(1).max(100).optional().prefault(50),
  offset: z.int().min(0).optional().prefault(0),
});

export type ListMembersInput = z.infer<typeof listMembersSchema>;
</file>

<file path="src/features/membership/membership.types.ts">
// Define types manually since we can't import from schema at top level
import type { MembershipMetadata } from "./membership.db-types";
export interface MembershipType {
  id: string;
  name: string;
  description: string | null;
  priceCents: number;
  durationMonths: number;
  status: "active" | "inactive";
  metadata: MembershipMetadata | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface Membership {
  id: string;
  userId: string;
  membershipTypeId: string;
  /** ISO date string (YYYY-MM-DD) from database date column */
  startDate: string;
  /** ISO date string (YYYY-MM-DD) from database date column */
  endDate: string;
  status: "active" | "cancelled" | "expired";
  paymentId: string | null;
  metadata: MembershipMetadata | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface MembershipOperationResult<T = unknown> {
  success: boolean;
  data?: T;
  errors?: Array<{
    code: "VALIDATION_ERROR" | "DATABASE_ERROR" | "PAYMENT_ERROR" | "NOT_FOUND";
    field?: string;
    message: string;
  }>;
}

export interface CheckoutSessionResult {
  checkoutUrl: string;
  sessionId: string;
}

export interface MembershipPurchaseInput {
  membershipTypeId: string;
  sessionId: string;
  paymentId?: string;
}

export interface UserMembership extends Membership {
  membershipType: MembershipType;
}

export interface MembershipStatus {
  hasMembership: boolean;
  currentMembership?: UserMembership;
  expiresAt?: Date;
  daysRemaining?: number;
}
</file>

<file path="src/routes/dashboard/members.tsx">
import { useQuery } from "@tanstack/react-query";
import { createFileRoute } from "@tanstack/react-router";
import type { ColumnDef } from "@tanstack/react-table";
import {
  CalendarCheck,
  Loader2,
  Mail,
  Phone,
  Search,
  ShieldCheck,
  Users,
} from "lucide-react";
import { useCallback, useDeferredValue, useMemo, useState, type ReactNode } from "react";
import { Alert, AlertDescription, AlertTitle } from "~/components/ui/alert";
import { Badge } from "~/components/ui/badge";
import { Button } from "~/components/ui/button";
import { DataTable } from "~/components/ui/data-table";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "~/components/ui/dialog";
import { Input } from "~/components/ui/input";
import {
  listMembers,
  type MemberDirectoryMember,
  type MemberDirectoryResponse,
} from "~/features/members";
import { exportToCSV, formatDate } from "~/lib/utils/csv-export";

export const Route = createFileRoute("/dashboard/members")({
  component: MembersPage,
});

function MembersPage() {
  const [searchTerm, setSearchTerm] = useState("");
  const deferredSearch = useDeferredValue(searchTerm);
  const [selectedMember, setSelectedMember] = useState<MemberDirectoryMember | null>(
    null,
  );

  const { data, isLoading, isFetching, error } = useQuery<
    MemberDirectoryResponse,
    Error,
    MemberDirectoryResponse
  >({
    queryKey: ["members-directory", { search: deferredSearch }],
    queryFn: async (): Promise<MemberDirectoryResponse> => {
      const payload = deferredSearch ? { search: deferredSearch } : {};
      const result = await listMembers({ data: payload });

      if (!result.success || !result.data) {
        throw new Error(
          result.errors?.[0]?.message || "Failed to fetch member directory",
        );
      }

      return result.data;
    },
  });

  const columns = useMemo<ColumnDef<MemberDirectoryMember>[]>(
    () => [
      {
        accessorKey: "name",
        header: "Member",
        cell: ({ row }) => {
          const member = row.original;
          return (
            <div className="space-y-1">
              <div className="leading-none font-medium">{member.name}</div>
              <div className="text-muted-foreground text-xs">
                {member.pronouns || "Pronouns not provided"}
              </div>
            </div>
          );
        },
      },
      {
        accessorKey: "teams",
        header: "Active Teams",
        cell: ({ row }) => {
          const teams = row.original.teams;

          if (!teams.length) {
            return <span className="text-muted-foreground text-sm">No active team</span>;
          }

          return (
            <div className="flex flex-wrap gap-1">
              {teams.map((team) => (
                <Badge key={team} variant="secondary" className="text-xs">
                  {team}
                </Badge>
              ))}
            </div>
          );
        },
      },
      {
        accessorKey: "membershipStatus",
        header: "Membership",
        cell: ({ row }) => {
          const { membershipStatus, hasActiveMembership, membershipType } = row.original;
          const badgeClass = hasActiveMembership
            ? "bg-green-100 text-green-800"
            : membershipStatus === "expired"
              ? "bg-amber-100 text-amber-800"
              : membershipStatus === "cancelled"
                ? "bg-red-100 text-red-800"
                : "bg-gray-200 text-gray-700";
          const label = hasActiveMembership
            ? "Active"
            : membershipStatus === "none"
              ? "No membership"
              : membershipStatus.charAt(0).toUpperCase() + membershipStatus.slice(1);

          return (
            <div className="flex flex-col gap-1">
              <Badge variant="secondary" className={`text-xs font-medium ${badgeClass}`}>
                {label}
              </Badge>
              {membershipType ? (
                <span className="text-muted-foreground text-xs">{membershipType}</span>
              ) : null}
            </div>
          );
        },
      },
      {
        accessorKey: "membershipEndDate",
        header: "Expires",
        cell: ({ row }) => {
          const { membershipEndDate, hasActiveMembership } = row.original;

          if (!membershipEndDate) {
            return <span className="text-muted-foreground text-sm">â€”</span>;
          }

          return (
            <span
              className={`text-sm ${hasActiveMembership ? "text-green-700" : "text-muted-foreground"}`}
            >
              {formatDate(membershipEndDate)}
            </span>
          );
        },
      },
      {
        id: "contact",
        header: "Contact",
        cell: ({ row }) => {
          const member = row.original;
          return (
            <div className="space-y-1 text-xs">
              <div className="flex items-center gap-1">
                <Mail className="text-muted-foreground h-3.5 w-3.5" />
                {member.emailVisible && member.email ? (
                  <a
                    href={`mailto:${member.email}`}
                    className="text-primary hover:underline"
                  >
                    {member.email}
                  </a>
                ) : (
                  <span className="text-muted-foreground">Hidden</span>
                )}
              </div>
              <div className="flex items-center gap-1">
                <Phone className="text-muted-foreground h-3.5 w-3.5" />
                {member.phoneVisible && member.phone ? (
                  <span>{member.phone}</span>
                ) : (
                  <span className="text-muted-foreground">Hidden</span>
                )}
              </div>
            </div>
          );
        },
      },
      {
        id: "actions",
        header: () => <span className="sr-only">Actions</span>,
        cell: ({ row }) => (
          <Button
            variant="outline"
            size="sm"
            onClick={() => setSelectedMember(row.original)}
          >
            View
          </Button>
        ),
        enableSorting: false,
        enableHiding: false,
      },
    ],
    [setSelectedMember],
  );

  const handleClearSearch = useCallback(() => {
    setSearchTerm("");
  }, []);

  const handleExport = useCallback(() => {
    const members = data?.members;
    if (!members?.length) {
      return;
    }

    const rows = members.map((member) => ({
      Name: member.name,
      Pronouns: member.pronouns || "",
      Email: member.emailVisible && member.email ? member.email : "Hidden",
      Phone: member.phoneVisible && member.phone ? member.phone : "Hidden",
      "Active Teams": member.teams.join(", "),
      "Membership Status": member.membershipStatus,
      "Membership Type": member.membershipType ?? "",
      "Membership Expires": member.membershipEndDate
        ? formatDate(member.membershipEndDate)
        : "",
      "Open to Invites": member.allowTeamInvitations ? "Yes" : "No",
      "Birth Year":
        member.birthYearVisible && member.birthYear ? String(member.birthYear) : "Hidden",
    }));

    const filename = `members-directory-${new Date().toISOString().split("T")[0]}.csv`;
    exportToCSV(rows, filename);
  }, [data]);

  const totalMembers = data?.pagination.total ?? 0;

  return (
    <div className="container mx-auto space-y-8 p-6">
      <div className="space-y-2">
        <h1 className="text-3xl font-bold tracking-tight">Members Directory</h1>
        <p className="text-muted-foreground">
          Browse Quadball Canada members, check membership status, and find players open
          to team invitations.
        </p>
      </div>

      <div className="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
        <div className="flex w-full flex-col gap-2 lg:max-w-lg">
          <label htmlFor="member-search" className="text-sm font-medium">
            Search members
          </label>
          <div className="relative flex items-center">
            <Search className="text-muted-foreground absolute left-3 h-4 w-4" />
            <Input
              id="member-search"
              placeholder="Search by name, email, or team"
              value={searchTerm}
              onChange={(event) => setSearchTerm(event.target.value)}
              className="pl-9"
              autoComplete="off"
            />
            {searchTerm ? (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                className="absolute top-1/2 right-1 -translate-y-1/2 px-2 text-xs"
                onClick={handleClearSearch}
              >
                Clear
              </Button>
            ) : null}
          </div>
        </div>
        <div className="flex items-center gap-3">
          <Badge variant="secondary" className="flex items-center gap-1 text-xs">
            <Users className="h-3.5 w-3.5" />
            <span>{totalMembers} members</span>
          </Badge>
          <Button
            variant="outline"
            onClick={handleExport}
            disabled={!data?.members?.length}
          >
            Export CSV
          </Button>
        </div>
      </div>

      {isLoading && !data ? (
        <div className="flex h-64 items-center justify-center">
          <Loader2 className="text-muted-foreground mr-2 h-6 w-6 animate-spin" />
          <span className="text-muted-foreground">Loading membersâ€¦</span>
        </div>
      ) : error ? (
        <Alert variant="destructive">
          <AlertTitle>Unable to load members</AlertTitle>
          <AlertDescription>
            {(error as Error).message ||
              "An unexpected error occurred while loading the member directory."}
          </AlertDescription>
        </Alert>
      ) : (
        <div className="space-y-4">
          {isFetching && (
            <div className="text-muted-foreground flex items-center gap-2 text-sm">
              <Loader2 className="h-4 w-4 animate-spin" />
              <span>Refreshing directoryâ€¦</span>
            </div>
          )}
          <DataTable
            columns={columns}
            data={data?.members ?? []}
            pageSize={10}
            enableColumnToggle={false}
          />
          {data?.members?.length === 0 && (
            <div className="border-border bg-muted/30 text-muted-foreground flex flex-col items-center gap-2 rounded-md border p-8 text-center">
              <ShieldCheck className="h-8 w-8" />
              <p>No members match your current search.</p>
            </div>
          )}
        </div>
      )}

      <MemberDetailDialog
        member={selectedMember}
        onClose={() => setSelectedMember(null)}
      />
    </div>
  );
}

interface MemberDetailDialogProps {
  member: MemberDirectoryMember | null;
  onClose: () => void;
}

function MemberDetailDialog({ member, onClose }: MemberDetailDialogProps) {
  const open = Boolean(member);

  return (
    <Dialog open={open} onOpenChange={(nextOpen) => !nextOpen && onClose()}>
      <DialogContent>
        {member ? (
          <div className="space-y-6">
            <DialogHeader className="space-y-1">
              <DialogTitle className="text-2xl">{member.name}</DialogTitle>
              <DialogDescription>View member profile details</DialogDescription>
            </DialogHeader>

            <div className="grid gap-4 md:grid-cols-2">
              <InfoBlock title="Membership" icon={<CalendarCheck className="h-4 w-4" />}>
                <div className="space-y-1 text-sm">
                  <div className="flex items-center gap-2">
                    <Badge
                      variant="secondary"
                      className={
                        member.hasActiveMembership
                          ? "bg-green-100 text-green-800"
                          : member.membershipStatus === "expired"
                            ? "bg-amber-100 text-amber-800"
                            : member.membershipStatus === "cancelled"
                              ? "bg-red-100 text-red-800"
                              : "bg-gray-200 text-gray-700"
                      }
                    >
                      {member.hasActiveMembership
                        ? "Active"
                        : member.membershipStatus === "none"
                          ? "No membership"
                          : member.membershipStatus.charAt(0).toUpperCase() +
                            member.membershipStatus.slice(1)}
                    </Badge>
                    {member.membershipType ? (
                      <span className="text-muted-foreground text-xs">
                        {member.membershipType}
                      </span>
                    ) : null}
                  </div>
                  {member.membershipEndDate ? (
                    <p className="text-muted-foreground text-xs">
                      Expires: {formatDate(member.membershipEndDate)}
                    </p>
                  ) : null}
                </div>
              </InfoBlock>

              <InfoBlock title="Contact" icon={<Mail className="h-4 w-4" />}>
                <div className="space-y-2 text-sm">
                  <div>
                    <p className="text-muted-foreground text-xs tracking-wide uppercase">
                      Email
                    </p>
                    {member.emailVisible && member.email ? (
                      <a
                        href={`mailto:${member.email}`}
                        className="text-primary hover:underline"
                      >
                        {member.email}
                      </a>
                    ) : (
                      <p className="text-muted-foreground">Hidden (privacy settings)</p>
                    )}
                  </div>
                  <div>
                    <p className="text-muted-foreground text-xs tracking-wide uppercase">
                      Phone
                    </p>
                    {member.phoneVisible && member.phone ? (
                      <p>{member.phone}</p>
                    ) : (
                      <p className="text-muted-foreground">Hidden (privacy settings)</p>
                    )}
                  </div>
                </div>
              </InfoBlock>

              <InfoBlock title="Teams" icon={<Users className="h-4 w-4" />}>
                {member.teams.length ? (
                  <ul className="space-y-1 text-sm">
                    {member.teams.map((team) => (
                      <li key={team}>{team}</li>
                    ))}
                  </ul>
                ) : (
                  <p className="text-muted-foreground text-sm">No active team</p>
                )}
              </InfoBlock>

              <InfoBlock title="Availability" icon={<ShieldCheck className="h-4 w-4" />}>
                <div className="space-y-2 text-sm">
                  <div>
                    <p className="text-muted-foreground text-xs tracking-wide uppercase">
                      Open to Team Invitations
                    </p>
                    <p>{member.allowTeamInvitations ? "Yes" : "No"}</p>
                  </div>
                  <div>
                    <p className="text-muted-foreground text-xs tracking-wide uppercase">
                      Birth Year
                    </p>
                    <p>
                      {member.birthYearVisible && member.birthYear
                        ? member.birthYear
                        : "Hidden (privacy settings)"}
                    </p>
                  </div>
                </div>
              </InfoBlock>
            </div>

            <div className="space-y-3">
              <h3 className="text-lg font-semibold">Membership history</h3>
              {member.membershipHistory.length ? (
                <div className="rounded-md border">
                  <div className="bg-muted/40 text-muted-foreground grid grid-cols-3 gap-2 border-b p-3 text-xs font-semibold uppercase">
                    <span>Status</span>
                    <span>Membership Type</span>
                    <span>Valid Dates</span>
                  </div>
                  <div className="divide-y text-sm">
                    {member.membershipHistory.map((entry, index) => (
                      <div
                        key={`${entry.status}-${entry.endDate ?? index}`}
                        className="grid grid-cols-3 gap-2 p-3"
                      >
                        <span className="font-medium">
                          {entry.status.charAt(0).toUpperCase() + entry.status.slice(1)}
                        </span>
                        <span className="text-muted-foreground">
                          {entry.membershipType || "â€”"}
                        </span>
                        <span className="text-muted-foreground">
                          {entry.startDate ? formatDate(entry.startDate) : "â€”"} â€“{" "}
                          {entry.endDate ? formatDate(entry.endDate) : "â€”"}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <p className="text-muted-foreground text-sm">
                  No membership records found for this member.
                </p>
              )}
            </div>
          </div>
        ) : null}
      </DialogContent>
    </Dialog>
  );
}

interface InfoBlockProps {
  title: string;
  icon?: ReactNode;
  children: ReactNode;
}

function InfoBlock({ title, icon, children }: InfoBlockProps) {
  return (
    <div className="rounded-lg border p-4 shadow-sm">
      <div className="mb-3 flex items-center gap-2 text-sm font-semibold">
        {icon}
        <span>{title}</span>
      </div>
      <div>{children}</div>
    </div>
  );
}
</file>

<file path="src/components/ui/TypedLink.tsx">
import type { RegisteredRouter } from "@tanstack/react-router";
import {
  Link,
  useNavigate,
  useRouterState,
  type LinkComponentProps,
} from "@tanstack/react-router";
import type { AnchorHTMLAttributes } from "react";

// Properly typed Link component that preserves generic type parameters
export function TypedLink<
  TFrom extends string = string,
  TTo extends string | undefined = ".",
  TMaskFrom extends string = TFrom,
  TMaskTo extends string = ".",
>(props: LinkComponentProps<"a", RegisteredRouter, TFrom, TTo, TMaskFrom, TMaskTo>) {
  const navigate = useNavigate();
  const routerState = useRouterState();
  const isWebKit =
    typeof navigator !== "undefined" &&
    /WebKit/.test(navigator.userAgent) &&
    !/Chrome|Edg|OPR/.test(navigator.userAgent);

  if (isWebKit) {
    // For WebKit, manually handle active state
    const { activeProps, to, children, ...restProps } = props;
    const isActive = routerState.location.pathname === to;

    const activeAttributes = isActive && activeProps ? activeProps : {};
    const anchorProps = restProps as AnchorHTMLAttributes<HTMLAnchorElement>;
    const activeAnchorProps = activeAttributes as AnchorHTMLAttributes<HTMLAnchorElement>;

    // Fallback to a real <a> so Safari's click semantics are 100% reliable
    return (
      <a
        href={(to as string) ?? routerState.location.pathname}
        {...anchorProps}
        {...activeAnchorProps}
        onClick={(e) => {
          anchorProps.onClick?.(e);
          if (e.defaultPrevented) {
            return;
          }
          e.preventDefault();
          // Use navigate with proper typing
          navigate({ to: to as string });
        }}
      >
        {typeof children === "function"
          ? children({ isActive, isTransitioning: false })
          : children}
      </a>
    );
  }

  return <Link {...props} />;
}
</file>

<file path="src/features/dashboard/MemberDashboard.tsx">
import { Link } from "@tanstack/react-router";
import {
  AlertCircle,
  Calendar,
  CheckCircle2,
  Clock,
  CreditCard,
  Settings,
  Shield,
  UserCircle,
  Users,
  XCircle,
} from "lucide-react";
import { Button } from "~/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "~/components/ui/card";
import type { MembershipStatus } from "~/features/membership/membership.types";
import { isAnyAdmin } from "~/features/roles/permission.service";

// Types for the dashboard data
interface ProfileStatus {
  complete: boolean;
  missingFields: string[];
}

interface UserTeam {
  team: {
    id: string;
    name: string;
    slug: string;
    city: string | null;
    province: string | null;
  };
  membership: {
    role: string;
    status: string;
  };
  memberCount: number;
}

interface PendingInvite {
  team: {
    id: string;
    name: string;
    slug: string;
  };
  membership: {
    id: string;
    role: string;
  };
  inviter: {
    id: string;
    name: string | null;
    email: string;
  } | null;
}

interface UpcomingEvent {
  id: string;
  name: string;
  slug: string;
  startDate: Date | string;
  city: string | null;
  province: string | null;
  status: string;
}

interface User {
  id: string;
  name: string | null;
  email: string;
  roles?: Array<{ role: { name: string } }>;
}

export interface MemberDashboardProps {
  user: User;
  membershipStatus: MembershipStatus | null;
  profileStatus: ProfileStatus;
  userTeams: UserTeam[];
  pendingInvites: PendingInvite[];
  upcomingEvents: UpcomingEvent[];
}

export function MemberDashboard({
  user,
  membershipStatus,
  profileStatus,
  userTeams,
  pendingInvites,
  upcomingEvents,
}: MemberDashboardProps) {
  const isAdmin = isAnyAdmin(user);

  return (
    <div className="container mx-auto space-y-8 p-6">
      {/* Header */}
      <header>
        <h1 className="text-3xl font-bold tracking-tight">
          Welcome back, {user.name || "Member"}!
        </h1>
        <div className="mt-2 flex flex-wrap items-center gap-2">
          {membershipStatus?.hasMembership ? (
            <span className="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
              <CheckCircle2 className="mr-1 h-3 w-3" />
              Active Member
            </span>
          ) : (
            <span className="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
              <AlertCircle className="mr-1 h-3 w-3" />
              Membership Required
            </span>
          )}
          {isAdmin && (
            <span className="inline-flex items-center rounded-full bg-purple-100 px-2.5 py-0.5 text-xs font-medium text-purple-800">
              <Shield className="mr-1 h-3 w-3" />
              Admin
            </span>
          )}
        </div>
      </header>

      {/* Action Cards - Your Next Steps */}
      <ActionCards
        profileStatus={profileStatus}
        membershipStatus={membershipStatus}
        pendingInvites={pendingInvites}
      />

      {/* Main Content Grid */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* Teams Section */}
        <TeamsCard teams={userTeams} invites={pendingInvites} />

        {/* Membership Card */}
        <MembershipCard status={membershipStatus} />
      </div>

      {/* Upcoming Events */}
      <UpcomingEventsCard events={upcomingEvents} />

      {/* Admin Tools (conditional) */}
      {isAdmin && <AdminToolsCard />}

      {/* Quick Links */}
      <QuickLinksCard />
    </div>
  );
}

// Action Cards Component
function ActionCards({
  profileStatus,
  membershipStatus,
  pendingInvites,
}: {
  profileStatus: ProfileStatus;
  membershipStatus: MembershipStatus | null;
  pendingInvites: PendingInvite[];
}) {
  const actions: Array<{
    show: boolean;
    title: string;
    description: string;
    href: string;
    icon: typeof UserCircle;
    variant: "default" | "warning" | "info";
  }> = [];

  // Profile incomplete
  if (!profileStatus.complete) {
    actions.push({
      show: true,
      title: "Complete your profile",
      description: `Missing: ${profileStatus.missingFields.slice(0, 2).join(", ")}${profileStatus.missingFields.length > 2 ? "..." : ""}`,
      href: "/dashboard/profile",
      icon: UserCircle,
      variant: "warning",
    });
  }

  // No membership
  if (!membershipStatus?.hasMembership) {
    actions.push({
      show: true,
      title: "Activate membership",
      description: "Get your annual player membership to compete",
      href: "/dashboard/membership",
      icon: CreditCard,
      variant: "warning",
    });
  }

  // Membership expiring soon
  if (
    membershipStatus?.hasMembership &&
    membershipStatus.daysRemaining &&
    membershipStatus.daysRemaining < 30
  ) {
    actions.push({
      show: true,
      title: "Renew membership",
      description: `Expires in ${membershipStatus.daysRemaining} days`,
      href: "/dashboard/membership",
      icon: Clock,
      variant: "warning",
    });
  }

  // Pending team invites
  if (pendingInvites.length > 0) {
    actions.push({
      show: true,
      title: "Team invitations",
      description: `${pendingInvites.length} pending invite${pendingInvites.length !== 1 ? "s" : ""}`,
      href: "/dashboard/teams",
      icon: Users,
      variant: "info",
    });
  }

  if (actions.length === 0) {
    return null;
  }

  return (
    <section>
      <h2 className="mb-4 text-lg font-semibold">Your Next Steps</h2>
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {actions.map((action) => (
          <Link key={action.href + action.title} to={action.href}>
            <Card className="transition-shadow hover:shadow-md">
              <CardContent className="flex items-center gap-4 pt-6">
                <div
                  className={`rounded-full p-2 ${
                    action.variant === "warning"
                      ? "bg-yellow-100 text-yellow-700"
                      : "bg-blue-100 text-blue-700"
                  }`}
                >
                  <action.icon className="h-5 w-5" />
                </div>
                <div>
                  <p className="font-medium">{action.title}</p>
                  <p className="text-muted-foreground text-sm">{action.description}</p>
                </div>
              </CardContent>
            </Card>
          </Link>
        ))}
      </div>
    </section>
  );
}

// Teams Card
function TeamsCard({ teams, invites }: { teams: UserTeam[]; invites: PendingInvite[] }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Users className="h-5 w-5" />
          Your Teams
        </CardTitle>
        <CardDescription>
          {teams.length === 0
            ? "You're not on any teams yet"
            : `${teams.length} active team${teams.length !== 1 ? "s" : ""}`}
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {teams.length === 0 ? (
          <div className="py-4 text-center">
            <p className="text-muted-foreground mb-4 text-sm">
              Join a team to compete in tournaments and events
            </p>
            <Button asChild variant="outline">
              <Link to="/dashboard/teams/browse">Browse Teams</Link>
            </Button>
          </div>
        ) : (
          <ul className="space-y-3">
            {teams.map(({ team, membership, memberCount }) => (
              <li key={team.id}>
                <Link
                  to="/dashboard/teams/$teamId"
                  params={{ teamId: team.slug }}
                  className="hover:bg-muted/50 flex items-center justify-between rounded-lg border p-3 transition-colors"
                >
                  <div>
                    <p className="font-medium">{team.name}</p>
                    <p className="text-muted-foreground text-sm">
                      {team.city}
                      {team.province ? `, ${team.province}` : ""} &middot; {memberCount}{" "}
                      member{memberCount !== 1 ? "s" : ""}
                    </p>
                  </div>
                  <span className="bg-muted rounded-full px-2 py-1 text-xs capitalize">
                    {membership.role}
                  </span>
                </Link>
              </li>
            ))}
          </ul>
        )}

        {/* Pending Invites */}
        {invites.length > 0 && (
          <div className="border-t pt-4">
            <p className="mb-2 text-sm font-medium">Pending Invitations</p>
            <ul className="space-y-2">
              {invites.map(({ team, membership, inviter }) => (
                <li
                  key={membership.id}
                  className="flex items-center justify-between rounded-lg border border-dashed p-3"
                >
                  <div>
                    <p className="font-medium">{team.name}</p>
                    <p className="text-muted-foreground text-sm">
                      Invited as {membership.role}
                      {inviter?.name ? ` by ${inviter.name}` : ""}
                    </p>
                  </div>
                  <div className="flex gap-2">
                    <Button size="sm" variant="outline">
                      Decline
                    </Button>
                    <Button size="sm">Accept</Button>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

// Membership Card
function MembershipCard({ status }: { status: MembershipStatus | null }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <CreditCard className="h-5 w-5" />
          Membership Status
        </CardTitle>
      </CardHeader>
      <CardContent>
        {status?.hasMembership ? (
          <div className="space-y-4">
            <div className="flex items-center gap-3">
              <CheckCircle2 className="h-8 w-8 text-green-600" />
              <div>
                <p className="text-2xl font-bold">Active</p>
                <p className="text-muted-foreground text-sm">
                  {status.currentMembership?.membershipType.name}
                </p>
              </div>
            </div>
            {status.expiresAt && (
              <div className="bg-muted rounded-lg p-3">
                <p className="text-sm">
                  <Clock className="mr-1 inline h-4 w-4" />
                  Valid until{" "}
                  {new Date(status.expiresAt).toLocaleDateString("en-CA", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })}
                </p>
                {typeof status.daysRemaining === "number" &&
                  status.daysRemaining < 60 && (
                    <p className="mt-1 text-sm text-yellow-700">
                      {status.daysRemaining <= 0
                        ? "Expires today"
                        : `${status.daysRemaining} days remaining`}
                    </p>
                  )}
              </div>
            )}
            <Button asChild variant="outline" className="w-full">
              <Link to="/dashboard/membership">
                {typeof status.daysRemaining === "number" && status.daysRemaining < 30
                  ? "Renew Now"
                  : "View Details"}
              </Link>
            </Button>
          </div>
        ) : (
          <div className="space-y-4 text-center">
            <XCircle className="text-muted-foreground mx-auto h-12 w-12" />
            <div>
              <p className="font-medium">No Active Membership</p>
              <p className="text-muted-foreground text-sm">
                Get your membership to compete in official events
              </p>
            </div>
            <Button asChild className="w-full">
              <Link to="/dashboard/membership">View Membership Options</Link>
            </Button>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

// Upcoming Events Card
function UpcomingEventsCard({ events }: { events: UpcomingEvent[] }) {
  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle className="flex items-center gap-2">
            <Calendar className="h-5 w-5" />
            Upcoming Events
          </CardTitle>
          <Button asChild variant="ghost" size="sm">
            <Link to="/dashboard/events">View all</Link>
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        {events.length === 0 ? (
          <p className="text-muted-foreground py-4 text-center text-sm">
            No upcoming events scheduled
          </p>
        ) : (
          <ul className="space-y-3">
            {events.slice(0, 5).map((event) => (
              <li key={event.id}>
                <Link
                  to="/dashboard/events/$slug"
                  params={{ slug: event.slug }}
                  className="hover:bg-muted/50 flex items-center justify-between rounded-lg border p-3 transition-colors"
                >
                  <div>
                    <p className="font-medium">{event.name}</p>
                    <p className="text-muted-foreground text-sm">
                      {new Date(event.startDate).toLocaleDateString("en-CA", {
                        month: "short",
                        day: "numeric",
                        year: "numeric",
                      })}{" "}
                      &middot; {event.city}
                      {event.province ? `, ${event.province}` : ""}
                    </p>
                  </div>
                  <span
                    className={`rounded-full px-2 py-1 text-xs ${
                      event.status === "registration_open"
                        ? "bg-green-100 text-green-800"
                        : "bg-muted text-muted-foreground"
                    }`}
                  >
                    {event.status === "registration_open" ? "Open" : event.status}
                  </span>
                </Link>
              </li>
            ))}
          </ul>
        )}
      </CardContent>
    </Card>
  );
}

// Admin Tools Card
function AdminToolsCard() {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Shield className="h-5 w-5" />
          Admin Tools
        </CardTitle>
        <CardDescription>Manage organization settings and data</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
          <Button asChild variant="outline">
            <Link to="/dashboard/members">Members</Link>
          </Button>
          <Button asChild variant="outline">
            <Link to="/dashboard/admin/roles">Roles</Link>
          </Button>
          <Button asChild variant="outline">
            <Link to="/dashboard/events">Events</Link>
          </Button>
          <Button asChild variant="outline">
            <Link to="/dashboard/reports">Reports</Link>
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}

// Quick Links Card
function QuickLinksCard() {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Settings className="h-5 w-5" />
          Quick Links
        </CardTitle>
      </CardHeader>
      <CardContent>
        <div className="grid gap-3 sm:grid-cols-3">
          <Button asChild variant="ghost" className="justify-start">
            <Link to="/dashboard/profile">
              <UserCircle className="mr-2 h-4 w-4" />
              Edit Profile
            </Link>
          </Button>
          <Button asChild variant="ghost" className="justify-start">
            <Link to="/dashboard/settings">
              <Settings className="mr-2 h-4 w-4" />
              Settings
            </Link>
          </Button>
          <Button asChild variant="ghost" className="justify-start">
            <a href="https://quadballcanada.ca" target="_blank" rel="noopener noreferrer">
              <Calendar className="mr-2 h-4 w-4" />
              News & Updates
            </a>
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/lib/email/sendgrid.ts">
/**
 * SendGrid email service wrapper
 * Provides type-safe methods for sending transactional emails
 */

import { z } from "zod";

// Email configuration schemas
export const EmailRecipientSchema = z.object({
  email: z.email(),
  name: z.string().optional(),
});

export const EmailDataSchema = z.object({
  to: z.union([EmailRecipientSchema, z.array(EmailRecipientSchema)]),
  from: EmailRecipientSchema,
  subject: z.string(),
  text: z.string().optional(),
  html: z.string().optional(),
  templateId: z.string().optional(),
  dynamicTemplateData: z.record(z.string(), z.unknown()).optional(),
  replyTo: EmailRecipientSchema.optional(),
  attachments: z
    .array(
      z.object({
        content: z.string(),
        filename: z.string(),
        type: z.string().optional(),
        disposition: z.string().optional(),
      }),
    )
    .optional(),
});

export type EmailRecipient = z.infer<typeof EmailRecipientSchema>;
export type EmailData = z.infer<typeof EmailDataSchema>;

// Response types
export interface SendEmailResult {
  success: boolean;
  messageId?: string;
  error?: string;
}

// Email template IDs (to be populated with actual SendGrid template IDs)
export const EMAIL_TEMPLATES = {
  MEMBERSHIP_PURCHASE_RECEIPT: "membership_purchase_receipt",
  WELCOME: "welcome",
  PASSWORD_RESET: "password_reset",
  TEAM_INVITATION: "team_invitation",
  EVENT_REGISTRATION_CONFIRMATION: "event_registration_confirmation",
} as const;

export type EmailTemplateId = (typeof EMAIL_TEMPLATES)[keyof typeof EMAIL_TEMPLATES];

// Mock email service for development
class MockEmailService {
  async send(data: EmailData): Promise<SendEmailResult> {
    console.log("ðŸ“§ Mock Email Service - Sending email:", {
      to: data.to,
      subject: data.subject,
      templateId: data.templateId,
      dynamicTemplateData: data.dynamicTemplateData,
    });

    // Simulate network delay
    await new Promise((resolve) => setTimeout(resolve, 1000));

    // Simulate success
    return {
      success: true,
      messageId: `mock-${Date.now()}`,
    };
  }

  setApiKey(_key: string): void {
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    const key = _key;
    console.log("ðŸ“§ Mock Email Service - API key set");
  }
}

// Real SendGrid service
class SendGridEmailService {
  private client: unknown;
  private initialized = false;

  async initialize(): Promise<void> {
    if (this.initialized) return;

    try {
      const sgMail = await import("@sendgrid/mail");
      this.client = sgMail.default;

      const apiKey = process.env["SENDGRID_API_KEY"];
      if (!apiKey) {
        throw new Error("SENDGRID_API_KEY environment variable is not set");
      }

      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      (this.client as any).setApiKey(apiKey);
      this.initialized = true;
    } catch (error) {
      console.error("Failed to initialize SendGrid:", error);
      throw error;
    }
  }

  async send(data: EmailData): Promise<SendEmailResult> {
    try {
      await this.initialize();

      // Validate email data
      const validatedData = EmailDataSchema.parse(data);

      // Convert to SendGrid format
      const msg = {
        to: validatedData.to,
        from: validatedData.from,
        subject: validatedData.subject,
        text: validatedData.text,
        html: validatedData.html,
        templateId: validatedData.templateId,
        dynamicTemplateData: validatedData.dynamicTemplateData,
        replyTo: validatedData.replyTo,
        attachments: validatedData.attachments,
      };

      // Send email
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const [response] = await (this.client as any).send(msg);

      return {
        success: true,
        messageId: response.headers["x-message-id"],
      };
    } catch (error) {
      console.error("SendGrid error:", error);
      return {
        success: false,
        error: error instanceof Error ? error.message : "Failed to send email",
      };
    }
  }
}

// Factory function to get the appropriate email service
type EmailService = MockEmailService | SendGridEmailService;

let cachedEmailService: EmailService | null = null;

const resolveEmailService = async (): Promise<EmailService> => {
  if (cachedEmailService) {
    return cachedEmailService;
  }

  const useSendGrid =
    process.env["SENDGRID_API_KEY"] && process.env["NODE_ENV"] !== "test";

  cachedEmailService = useSendGrid ? new SendGridEmailService() : new MockEmailService();
  return cachedEmailService;
};

export const getEmailService = async (): Promise<EmailService> => resolveEmailService();

// Convenience function for sending membership purchase receipts
export const sendMembershipPurchaseReceipt = async (params: {
  to: EmailRecipient;
  membershipType: string;
  amount: number;
  paymentId: string;
  expiresAt: Date;
}) => {
  const service = await getEmailService();

  const fromEmail = process.env["SENDGRID_FROM_EMAIL"] || "noreply@quadballcanada.com";
  const fromName = process.env["SENDGRID_FROM_NAME"] || "Quadball Canada";

  return service.send({
    to: params.to,
    from: {
      email: fromEmail,
      name: fromName,
    },
    subject: "Membership Purchase Confirmation - Quadball Canada",
    templateId: EMAIL_TEMPLATES.MEMBERSHIP_PURCHASE_RECEIPT,
    dynamicTemplateData: {
      memberName: params.to.name || "Member",
      membershipType: params.membershipType,
      amount: `$${(params.amount / 100).toFixed(2)}`,
      paymentId: params.paymentId,
      expiresAt: params.expiresAt.toLocaleDateString("en-CA"),
      year: new Date().getFullYear(),
    },
    // Fallback plain text version
    text: `Thank you for purchasing a ${params.membershipType} membership!

Amount paid: $${(params.amount / 100).toFixed(2)}
Payment ID: ${params.paymentId}
Expires: ${params.expiresAt.toLocaleDateString("en-CA")}

You can view your membership status at any time by logging into your dashboard.

If you have any questions, please contact us at support@quadballcanada.com.

Best regards,
Quadball Canada Team`,
    // HTML version (used if no template ID is configured)
    html: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Membership Purchase Confirmation</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <h1 style="color: #0ea5e9;">Membership Purchase Confirmation</h1>
    
    <p>Hello ${params.to.name || "Member"},</p>
    
    <p>Thank you for purchasing a <strong>${params.membershipType}</strong> membership!</p>
    
    <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
      <h2 style="margin-top: 0;">Purchase Details</h2>
      <p><strong>Amount paid:</strong> $${(params.amount / 100).toFixed(2)}</p>
      <p><strong>Payment ID:</strong> ${params.paymentId}</p>
      <p><strong>Expires:</strong> ${params.expiresAt.toLocaleDateString("en-CA")}</p>
    </div>
    
    <p>You can view your membership status at any time by logging into your dashboard.</p>
    
    <p>If you have any questions, please contact us at <a href="mailto:support@quadballcanada.com">support@quadballcanada.com</a>.</p>
    
    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e5e7eb;">
    
    <p style="color: #6b7280; font-size: 14px;">
      Best regards,<br>
      Quadball Canada Team
    </p>
  </div>
</body>
</html>
    `,
  });
};

export const sendTeamInvitationEmail = async (params: {
  to: EmailRecipient;
  teamName: string;
  teamSlug: string;
  role: string;
  invitedByName?: string;
  invitedByEmail?: string;
}) => {
  const service = await getEmailService();

  const fromEmail = process.env["SENDGRID_FROM_EMAIL"] || "noreply@quadballcanada.com";
  const fromName = process.env["SENDGRID_FROM_NAME"] || "Quadball Canada";

  const siteUrl =
    process.env["SITE_URL"] ||
    process.env["URL"] ||
    process.env["VITE_BASE_URL"] ||
    "http://localhost:5173";
  const normalizedSiteUrl = siteUrl.endsWith("/") ? siteUrl.slice(0, -1) : siteUrl;
  const dashboardUrl = `${normalizedSiteUrl}/dashboard/teams`;
  const invitationUrl = `${dashboardUrl}/${params.teamSlug}`;

  const inviterDisplay =
    params.invitedByName ||
    params.invitedByEmail ||
    "a Quadball Canada team representative";

  const textBody = `You've been invited to join ${params.teamName} as a ${params.role}.

Accept or decline your invitation here: ${dashboardUrl}

If the link above doesn't work, copy and paste this URL into your browser: ${invitationUrl}

Invitation sent by ${inviterDisplay}.`;

  return service.send({
    to: params.to,
    from: {
      email: fromEmail,
      name: fromName,
    },
    subject: `${params.teamName} team invitation`,
    templateId: EMAIL_TEMPLATES.TEAM_INVITATION,
    dynamicTemplateData: {
      teamName: params.teamName,
      role: params.role,
      inviterName: inviterDisplay,
      dashboardUrl,
      invitationUrl,
    },
    text: textBody,
  });
};

// Convenience function for sending welcome emails
export const sendWelcomeEmail = async (params: {
  to: EmailRecipient;
  profileUrl: string;
}) => {
  const service = await getEmailService();

  const fromEmail = process.env["SENDGRID_FROM_EMAIL"] || "noreply@quadballcanada.com";
  const fromName = process.env["SENDGRID_FROM_NAME"] || "Quadball Canada";

  return service.send({
    to: params.to,
    from: {
      email: fromEmail,
      name: fromName,
    },
    subject: "Welcome to Quadball Canada!",
    templateId: EMAIL_TEMPLATES.WELCOME,
    dynamicTemplateData: {
      memberName: params.to.name || "New Member",
      profileUrl: params.profileUrl,
      year: new Date().getFullYear(),
    },
    text: `Welcome to Quadball Canada!

We're thrilled to have you join our community.

To get started, please complete your profile: ${params.profileUrl}

If you have any questions, feel free to reach out to us at support@quadballcanada.com.

Best regards,
Quadball Canada Team`,
  });
};
</file>

<file path="src/routes/dashboard/reports.tsx">
import { createFileRoute } from "@tanstack/react-router";
import { Suspense } from "react";
import { AdminMembershipsReport } from "~/features/membership/components/admin-memberships-report";
import { requireGlobalAdmin } from "~/lib/auth/middleware/role-guard";

export const Route = createFileRoute("/dashboard/reports")({
  beforeLoad: async ({ context }) => {
    await requireGlobalAdmin(context.user);
  },
  component: ReportsPage,
});

function ReportsPage() {
  return (
    <div className="container mx-auto space-y-8 p-6">
      <h1 className="text-3xl font-bold tracking-tight">Reports</h1>

      <Suspense
        fallback={
          <div className="flex h-64 items-center justify-center">
            <div className="text-muted-foreground">Loading reports...</div>
          </div>
        }
      >
        <AdminMembershipsReport />
      </Suspense>
    </div>
  );
}
</file>

<file path="src/features/members/members.queries.ts">
import { createServerFn } from "@tanstack/react-start";
import { zod$ } from "~/lib/server/fn-utils";
import { listMembersSchema } from "./members.schemas";
import type {
  MemberDirectoryMember,
  MemberDirectoryMembershipSummary,
  MemberDirectoryOperationResult,
  MemberDirectoryResponse,
} from "./members.types";

type PrivacySettings = import("~/features/profile/profile.types").PrivacySettings;
type SQLExpression = import("drizzle-orm").SQL<unknown>;

type ListMembersResult = MemberDirectoryOperationResult<MemberDirectoryResponse>;

type MembershipAccumulator = {
  id: string;
  status: "active" | "expired" | "cancelled";
  membershipType: string | null;
  startDate: Date | null;
  endDate: Date | null;
};

type MemberAccumulator = {
  id: string;
  name: string;
  email: string | null;
  phone: string | null;
  pronouns: string | null;
  dateOfBirth: Date | null;
  privacySettings: string | null;
  profileUpdatedAt: Date | null;
  teams: Set<string>;
  memberships: Map<string, MembershipAccumulator>;
};

function escapeSearchTerm(value: string): string {
  return value.replace(/[%_]/g, (match) => `\\${match}`);
}

function parsePrivacySettings(
  value: string | null,
  fallback: PrivacySettings,
): PrivacySettings {
  if (!value) {
    return fallback;
  }

  try {
    const parsed = JSON.parse(value) as Partial<PrivacySettings>;
    return {
      showEmail: parsed.showEmail ?? fallback.showEmail,
      showPhone: parsed.showPhone ?? fallback.showPhone,
      showBirthYear: parsed.showBirthYear ?? fallback.showBirthYear,
      allowTeamInvitations: parsed.allowTeamInvitations ?? fallback.allowTeamInvitations,
    };
  } catch (error) {
    console.warn("Failed to parse privacy settings", error);
    return fallback;
  }
}

export const listMembers = createServerFn({ method: "GET" })
  .inputValidator(zod$(listMembersSchema))
  .handler(async ({ data }): Promise<ListMembersResult> => {
    try {
      const searchTerm = data.search?.trim();
      const limit = Math.min(100, Math.max(1, data.limit ?? 50));
      const offset = Math.max(0, data.offset ?? 0);

      const [{ getDb }, { getCurrentUser }] = await Promise.all([
        import("~/db/server-helpers"),
        import("~/features/auth/auth.queries"),
      ]);

      const [db, currentUser] = await Promise.all([getDb(), getCurrentUser()]);

      if (!currentUser) {
        return {
          success: false,
          errors: [
            {
              code: "NOT_AUTHENTICATED",
              message: "User not authenticated",
            },
          ],
        };
      }

      const { user, teamMembers, teams, memberships, membershipTypes } = await import(
        "~/db/schema"
      );
      const { defaultPrivacySettings } = await import("~/features/profile/profile.types");
      const { and, eq, inArray, sql } = await import("drizzle-orm");

      const conditions: SQLExpression[] = [];

      if (searchTerm) {
        const pattern = `%${escapeSearchTerm(searchTerm)}%`;
        conditions.push(
          sql`(
            ${user.name} ILIKE ${pattern} OR
            ${user.email} ILIKE ${pattern} OR
            ${user.phone} ILIKE ${pattern} OR
            ${teams.name} ILIKE ${pattern}
          )`,
        );
      }

      const whereClause = conditions.length > 0 ? and(...conditions) : undefined;

      const baseQuery = db
        .select({ userId: user.id })
        .from(user)
        .leftJoin(teamMembers, eq(teamMembers.userId, user.id))
        .leftJoin(teams, eq(teamMembers.teamId, teams.id));

      const filteredBaseQuery = whereClause ? baseQuery.where(whereClause) : baseQuery;

      const userIdRows = await filteredBaseQuery
        .groupBy(user.id)
        .orderBy(sql`LOWER(${user.name})`)
        .limit(limit)
        .offset(offset);
      const userIds = userIdRows.map((row) => row.userId);

      const totalQuery = db
        .select({ count: sql<number>`COUNT(DISTINCT ${user.id})::int` })
        .from(user)
        .leftJoin(teamMembers, eq(teamMembers.userId, user.id))
        .leftJoin(teams, eq(teamMembers.teamId, teams.id));

      const filteredTotalQuery = whereClause ? totalQuery.where(whereClause) : totalQuery;

      const totalResult = await filteredTotalQuery;
      const total = totalResult[0]?.count ?? 0;

      if (userIds.length === 0) {
        return {
          success: true,
          data: {
            members: [],
            pagination: {
              total,
              limit,
              offset,
              hasMore: false,
            },
          },
        };
      }

      const detailRows = await db
        .select({
          id: user.id,
          name: user.name,
          email: user.email,
          phone: user.phone,
          pronouns: user.pronouns,
          dateOfBirth: user.dateOfBirth,
          privacySettings: user.privacySettings,
          profileUpdatedAt: user.profileUpdatedAt,
          teamId: teamMembers.teamId,
          teamName: teams.name,
          teamStatus: teamMembers.status,
          membershipId: memberships.id,
          membershipStatus: memberships.status,
          membershipStartDate: memberships.startDate,
          membershipEndDate: memberships.endDate,
          membershipTypeName: membershipTypes.name,
        })
        .from(user)
        .leftJoin(teamMembers, eq(teamMembers.userId, user.id))
        .leftJoin(teams, eq(teamMembers.teamId, teams.id))
        .leftJoin(memberships, eq(memberships.userId, user.id))
        .leftJoin(membershipTypes, eq(membershipTypes.id, memberships.membershipTypeId))
        .where(inArray(user.id, userIds));

      const memberAccumulator = new Map<string, MemberAccumulator>();

      for (const row of detailRows) {
        let accumulator = memberAccumulator.get(row.id);

        if (!accumulator) {
          const dateOfBirth = row.dateOfBirth
            ? row.dateOfBirth instanceof Date
              ? row.dateOfBirth
              : new Date(row.dateOfBirth)
            : null;
          const profileUpdatedAt = row.profileUpdatedAt
            ? row.profileUpdatedAt instanceof Date
              ? row.profileUpdatedAt
              : new Date(row.profileUpdatedAt)
            : null;

          accumulator = {
            id: row.id,
            name: row.name || "Unknown",
            email: row.email ?? null,
            phone: row.phone ?? null,
            pronouns: row.pronouns ?? null,
            dateOfBirth,
            privacySettings: row.privacySettings ?? null,
            profileUpdatedAt,
            teams: new Set<string>(),
            memberships: new Map<string, MembershipAccumulator>(),
          };

          memberAccumulator.set(row.id, accumulator);
        }

        if (row.teamName && row.teamStatus === "active") {
          accumulator.teams.add(row.teamName);
        }

        if (row.membershipId) {
          const existingMembership = accumulator.memberships.get(row.membershipId);

          if (!existingMembership) {
            const startDate = row.membershipStartDate
              ? new Date(row.membershipStartDate)
              : null;
            const endDate = row.membershipEndDate
              ? new Date(row.membershipEndDate)
              : null;

            accumulator.memberships.set(row.membershipId, {
              id: row.membershipId,
              status: (row.membershipStatus ??
                "expired") as MembershipAccumulator["status"],
              membershipType: row.membershipTypeName ?? null,
              startDate,
              endDate,
            });
          }
        }
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const members: MemberDirectoryMember[] = [];

      for (const memberId of userIds) {
        const accumulator = memberAccumulator.get(memberId);

        if (!accumulator) {
          continue;
        }

        const privacy = parsePrivacySettings(
          accumulator.privacySettings,
          defaultPrivacySettings,
        );

        const isSelf = memberId === currentUser.id;
        const showEmail = privacy.showEmail || isSelf;
        const showPhone = privacy.showPhone || isSelf;
        const showBirthYear = privacy.showBirthYear || isSelf;

        const membershipList = Array.from(accumulator.memberships.values()).sort(
          (a, b) => {
            const aTime = a.endDate ? a.endDate.getTime() : 0;
            const bTime = b.endDate ? b.endDate.getTime() : 0;
            return bTime - aTime;
          },
        );

        const activeMembership = membershipList.find(
          (membership) =>
            membership.status === "active" &&
            membership.endDate !== null &&
            membership.endDate.getTime() >= today.getTime(),
        );

        const latestMembership = membershipList[0];

        const membershipStatus = activeMembership
          ? "active"
          : latestMembership
            ? latestMembership.status
            : "none";

        const membershipType = activeMembership
          ? activeMembership.membershipType
          : (latestMembership?.membershipType ?? null);

        const membershipEndDate = activeMembership?.endDate
          ? activeMembership.endDate.toISOString()
          : latestMembership?.endDate
            ? latestMembership.endDate.toISOString()
            : null;

        const membershipHistory: MemberDirectoryMembershipSummary[] = membershipList.map(
          (membership) => ({
            status: membership.status,
            membershipType: membership.membershipType,
            startDate: membership.startDate ? membership.startDate.toISOString() : null,
            endDate: membership.endDate ? membership.endDate.toISOString() : null,
          }),
        );

        const birthDate = accumulator.dateOfBirth;

        members.push({
          id: accumulator.id,
          name: accumulator.name,
          email: showEmail ? accumulator.email : null,
          emailVisible: Boolean(showEmail && accumulator.email),
          phone: showPhone ? accumulator.phone : null,
          phoneVisible: Boolean(showPhone && accumulator.phone),
          pronouns: accumulator.pronouns,
          teams: Array.from(accumulator.teams).sort((a, b) => a.localeCompare(b)),
          membershipStatus,
          membershipType,
          membershipEndDate,
          hasActiveMembership: membershipStatus === "active",
          allowTeamInvitations: privacy.allowTeamInvitations,
          birthYear: showBirthYear && birthDate ? birthDate.getUTCFullYear() : null,
          birthYearVisible: showBirthYear && Boolean(birthDate),
          profileUpdatedAt: accumulator.profileUpdatedAt
            ? accumulator.profileUpdatedAt.toISOString()
            : null,
          membershipHistory,
        });
      }

      return {
        success: true,
        data: {
          members,
          pagination: {
            total,
            limit,
            offset,
            hasMore: offset + members.length < total,
          },
        },
      };
    } catch (error) {
      console.error("Error listing members:", error);
      return {
        success: false,
        errors: [
          {
            code: "DATABASE_ERROR",
            message: "Failed to fetch members",
          },
        ],
      };
    }
  });
</file>

<file path="src/features/membership/membership.queries.ts">
import { createServerFn } from "@tanstack/react-start";
import { zod$ } from "~/lib/server/fn-utils";
import { getMembershipTypeSchema } from "./membership.schemas";
import type {
  MembershipOperationResult,
  MembershipStatus,
  UserMembership,
} from "./membership.types";

/**
 * List all active membership types available for purchase
 */
export const listMembershipTypes = createServerFn({ method: "GET" }).handler(
  async (): Promise<
    MembershipOperationResult<import("./membership.types").MembershipType[]>
  > => {
    try {
      // Import server-only modules inside the handler
      const { getDb } = await import("~/db/server-helpers");

      // Import database dependencies inside handler
      const { eq } = await import("drizzle-orm");
      const { membershipTypes } = await import("~/db/schema");

      const db = await getDb();

      const activeTypes = await db
        .select()
        .from(membershipTypes)
        .where(eq(membershipTypes.status, "active"))
        .orderBy(membershipTypes.priceCents);

      return {
        success: true,
        data: activeTypes,
      };
    } catch (error) {
      console.error("Error fetching membership types:", error);
      return {
        success: false,
        errors: [
          {
            code: "DATABASE_ERROR",
            message: "Failed to fetch membership types",
          },
        ],
      };
    }
  },
);

/**
 * Get a specific membership type by ID
 */
export const getMembershipType = createServerFn({ method: "GET" })
  .inputValidator(zod$(getMembershipTypeSchema))
  .handler(
    async ({
      data,
    }): Promise<
      MembershipOperationResult<import("./membership.types").MembershipType>
    > => {
      try {
        // Import server-only modules inside the handler
        const { getDb } = await import("~/db/server-helpers");

        // Import database dependencies inside handler
        const { eq } = await import("drizzle-orm");
        const { membershipTypes } = await import("~/db/schema");

        const db = await getDb();

        const [membershipType] = await db
          .select()
          .from(membershipTypes)
          .where(eq(membershipTypes.id, data.membershipTypeId))
          .limit(1);

        if (!membershipType) {
          return {
            success: false,
            errors: [
              {
                code: "NOT_FOUND",
                message: "Membership type not found",
              },
            ],
          };
        }

        return {
          success: true,
          data: membershipType,
        };
      } catch (error) {
        console.error("Error fetching membership type:", error);
        return {
          success: false,
          errors: [
            {
              code: "DATABASE_ERROR",
              message: "Failed to fetch membership type",
            },
          ],
        };
      }
    },
  );

/**
 * Get current user's membership status
 */
export const getUserMembershipStatus = createServerFn({ method: "GET" }).handler(
  async (): Promise<MembershipOperationResult<MembershipStatus>> => {
    try {
      // Import server-only modules inside the handler
      const [{ getDb }, { getAuth }] = await Promise.all([
        import("~/db/server-helpers"),
        import("~/lib/auth/server-helpers"),
      ]);

      const auth = await getAuth();
      const { getRequest } = await import("@tanstack/react-start/server");
      const { headers } = getRequest();
      const session = await auth.api.getSession({ headers });

      if (!session?.user?.id) {
        return {
          success: false,
          errors: [
            {
              code: "VALIDATION_ERROR",
              message: "User not authenticated",
            },
          ],
        };
      }

      // Import database dependencies inside handler
      const { and, eq, gte, sql } = await import("drizzle-orm");
      const { membershipTypes, memberships } = await import("~/db/schema");

      // Get active membership for the user
      const db = await getDb();

      const [currentMembership] = await db
        .select({
          membership: memberships,
          membershipType: membershipTypes,
        })
        .from(memberships)
        .innerJoin(membershipTypes, eq(memberships.membershipTypeId, membershipTypes.id))
        .where(
          and(
            eq(memberships.userId, session.user.id),
            eq(memberships.status, "active"),
            gte(memberships.endDate, sql`CURRENT_DATE`),
          ),
        )
        .orderBy(sql`${memberships.endDate} DESC`)
        .limit(1);

      if (!currentMembership) {
        return {
          success: true,
          data: {
            hasMembership: false,
          },
        };
      }

      const endDate = new Date(currentMembership.membership.endDate);
      const daysRemaining = Math.ceil(
        (endDate.getTime() - Date.now()) / (1000 * 60 * 60 * 24),
      );

      const userMembership: UserMembership = {
        ...currentMembership.membership,
        membershipType: currentMembership.membershipType,
      };

      return {
        success: true,
        data: {
          hasMembership: true,
          currentMembership: userMembership,
          expiresAt: endDate,
          daysRemaining,
        },
      };
    } catch (error) {
      console.error("Error fetching membership status:", error);
      return {
        success: false,
        errors: [
          {
            code: "DATABASE_ERROR",
            message: "Failed to fetch membership status",
          },
        ],
      };
    }
  },
);
</file>

<file path="src/routes/__root.tsx">
/// <reference types="vite/client" />
import type { QueryClient } from "@tanstack/react-query";
import {
  createRootRouteWithContext,
  HeadContent,
  Outlet,
  ScriptOnce,
  Scripts,
} from "@tanstack/react-router";

import { lazy, Suspense } from "react";
import {
  authQueryOptions,
  getCurrentUser,
  type AuthQueryResult,
} from "~/features/auth/auth.queries";
import appCss from "~/styles.css?url";

// Lazy load devtools only in development to exclude from production bundles
const ReactQueryDevtools = import.meta.env.DEV
  ? lazy(() =>
      import("@tanstack/react-query-devtools").then((mod) => ({
        default: mod.ReactQueryDevtools,
      })),
    )
  : null;

const TanStackRouterDevtools = import.meta.env.DEV
  ? lazy(() =>
      import("@tanstack/react-router-devtools").then((mod) => ({
        default: mod.TanStackRouterDevtools,
      })),
    )
  : null;

// Lazy load Toaster to avoid SSR issues
const Toaster = lazy(() => import("sonner").then((mod) => ({ default: mod.Toaster })));

export const Route = createRootRouteWithContext<{
  queryClient: QueryClient;
  user: AuthQueryResult;
}>()({
  beforeLoad: async ({ context }) => {
    try {
      // Check if we're on the server or client
      if (typeof window === "undefined") {
        // Server: use the server function
        const user = await getCurrentUser();
        return { user };
      } else {
        // Client: fetch the full user data
        const user = await context.queryClient.fetchQuery(authQueryOptions());
        return { user };
      }
    } catch (error) {
      console.error("Error loading user:", error);
      return { user: null };
    }
  },
  head: () => ({
    meta: [
      {
        charSet: "utf-8",
      },
      {
        name: "viewport",
        content: "width=device-width, initial-scale=1",
      },
      {
        title: "Quadball Canada",
      },
      {
        name: "description",
        content:
          "Official hub for Quadball Canada competitions, club resources, and national team updates.",
      },
    ],
    links: [{ rel: "stylesheet", href: appCss }],
  }),
  component: RootComponent,
});

function RootComponent() {
  return (
    <RootDocument>
      <Outlet />
    </RootDocument>
  );
}

function RootDocument({ children }: { readonly children: React.ReactNode }) {
  return (
    // suppress since we're updating the "dark" class in a custom script below
    <html lang="en" suppressHydrationWarning>
      <head>
        <HeadContent />
      </head>
      <body>
        <ScriptOnce>
          {`
            // Minimal process shim for TanStack server functions
            if (typeof globalThis.process === 'undefined') {
              globalThis.process = {
                env: { NODE_ENV: '${import.meta.env.PROD ? "production" : "development"}' },
                versions: { node: '22.0.0' }
              };
            }

            // Theme toggle
            document.documentElement.classList.toggle(
              'dark',
              localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
            );
          `}
        </ScriptOnce>

        {children}

        <Suspense fallback={null}>
          <Toaster richColors closeButton />
        </Suspense>
        {import.meta.env.DEV && ReactQueryDevtools && TanStackRouterDevtools && (
          <Suspense fallback={null}>
            <ReactQueryDevtools buttonPosition="bottom-left" />
            <TanStackRouterDevtools position="bottom-right" />
          </Suspense>
        )}

        <Scripts />
      </body>
    </html>
  );
}
</file>

<file path="src/routes/dashboard/index.tsx">
import { createFileRoute } from "@tanstack/react-router";
import { SafeLink as Link } from "~/components/ui/SafeLink";
import { Button } from "~/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "~/components/ui/card";
import {
  AlertCircle,
  Calendar,
  CheckCircle2,
  Clock,
  CreditCard,
  Trophy,
  User,
  UserPlus,
  Users,
  XCircle,
} from "~/components/ui/icons";
import { getUserMembershipStatus } from "~/features/membership/membership.queries";
import type { MembershipStatus } from "~/features/membership/membership.types";
import { getUserTeams, type UserTeam } from "~/features/teams/teams.queries";

export const Route = createFileRoute("/dashboard/")({
  loader: async () => {
    // Load data in parallel on the server
    const [membershipResult, userTeams] = await Promise.all([
      getUserMembershipStatus(),
      getUserTeams({ data: {} }),
    ]);

    const membershipStatus: MembershipStatus | null = membershipResult.success
      ? (membershipResult.data ?? null)
      : null;

    return {
      membershipStatus,
      userTeams: userTeams || [],
    };
  },
  component: DashboardIndex,
});

function DashboardIndex() {
  const { user } = Route.useRouteContext();
  const { membershipStatus, userTeams } = Route.useLoaderData();

  const teamCount = (userTeams as UserTeam[]).length;
  const upcomingEventsCount = 0;

  return (
    <div className="container mx-auto space-y-8 p-6">
      {/* Welcome Section */}
      <div>
        <h1 className="text-3xl font-bold tracking-tight">
          Welcome back, {user?.name || "Player"}!
        </h1>
        <p className="text-muted-foreground mt-2">
          Here's an overview of your Quadball Canada account
        </p>
      </div>

      {/* Stats Cards */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Membership Status Card */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Membership Status</CardTitle>
            {membershipStatus?.hasMembership ? (
              <CheckCircle2 className="h-4 w-4 text-green-600" />
            ) : (
              <XCircle className="text-muted-foreground h-4 w-4" />
            )}
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {membershipStatus?.hasMembership ? "Active" : "Inactive"}
            </div>
            {membershipStatus?.hasMembership && membershipStatus.daysRemaining ? (
              <p className="text-muted-foreground mt-1 text-xs">
                <Clock className="mr-1 inline h-3 w-3" />
                {membershipStatus.daysRemaining} days remaining
              </p>
            ) : null}
            {!membershipStatus?.hasMembership && (
              <p className="text-muted-foreground mt-1 text-xs">
                <AlertCircle className="mr-1 inline h-3 w-3" />
                No active membership
              </p>
            )}
          </CardContent>
        </Card>

        {/* Teams Card */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">My Teams</CardTitle>
            <Users className="text-muted-foreground h-4 w-4" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{teamCount}</div>
            <p className="text-muted-foreground mt-1 text-xs">
              {teamCount === 0
                ? "Not on any teams yet"
                : `Active team${teamCount !== 1 ? "s" : ""}`}
            </p>
          </CardContent>
        </Card>

        {/* Upcoming Events Card */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Upcoming Events</CardTitle>
            <Calendar className="text-muted-foreground h-4 w-4" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{upcomingEventsCount}</div>
            <p className="text-muted-foreground mt-1 text-xs">
              {upcomingEventsCount === 0 ? "No events scheduled" : "Events this season"}
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Quick Actions */}
      <div>
        <h2 className="mb-4 text-lg font-semibold">Quick Actions</h2>
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {/* Complete Profile - always shown since profile is complete to access dashboard */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <User className="h-5 w-5" />
                View Profile
              </CardTitle>
              <CardDescription>
                Review and update your profile information
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Button asChild className="w-full">
                <Link to="/dashboard/profile">View Profile</Link>
              </Button>
            </CardContent>
          </Card>

          {/* Buy/Renew Membership */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <CreditCard className="h-5 w-5" />
                {membershipStatus?.hasMembership ? "Renew Membership" : "Buy Membership"}
              </CardTitle>
              <CardDescription>
                {membershipStatus?.hasMembership
                  ? "Extend your membership for another year"
                  : "Get your annual player membership"}
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Button asChild className="w-full">
                <Link to="/dashboard/membership">
                  {membershipStatus?.hasMembership ? "Renew Now" : "Get Membership"}
                </Link>
              </Button>
            </CardContent>
          </Card>

          {/* Join Team */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <UserPlus className="h-5 w-5" />
                Join a Team
              </CardTitle>
              <CardDescription>
                Find and join a team to compete in tournaments
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Button asChild className="w-full" variant="outline">
                <Link to="/dashboard/teams/browse">Browse Teams</Link>
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>

      {/* Recent Activity - Placeholder */}
      <div>
        <h2 className="mb-4 text-lg font-semibold">Recent Activity</h2>
        <Card>
          <CardContent className="pt-6">
            <div className="text-muted-foreground flex items-center justify-center py-8">
              <Trophy className="mr-3 h-12 w-12 opacity-20" />
              <div>
                <p className="text-sm font-medium">No recent activity</p>
                <p className="text-xs">Your recent activities will appear here</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="src/features/events/events.types.ts">
import type { z } from "zod";
import type { Event, EventRegistration } from "~/db/schema";
import type { createEventInputSchema } from "~/db/schema/events.schema";
import type {
  EventAmenities,
  EventDivisions,
  EventMetadata,
  EventPaymentMetadata,
  EventRegistrationRoster,
  EventRequirements,
  EventRules,
  EventSchedule,
} from "./events.db-types";

// Input types
export type CreateEventInput = z.infer<typeof createEventInputSchema>;

export type UpdateEventInput = Partial<CreateEventInput> & {
  status?: EventStatus;
};

export type EventFilters = {
  status?: Event["status"] | Event["status"][];
  type?: Event["type"] | Event["type"][];
  organizerId?: string;
  startDateFrom?: Date;
  startDateTo?: Date;
  city?: string;
  province?: string;
};

export type EventRegistrationInput = {
  eventId: string;
  teamId?: string;
  division?: string;
  notes?: string;
  roster?: {
    userId: string;
    role: string;
  }[];
};

// Response types
export interface EventWithDetails
  extends Omit<
    Event,
    "rules" | "schedule" | "divisions" | "amenities" | "requirements" | "metadata"
  > {
  rules: EventRules;
  schedule: EventSchedule;
  divisions: EventDivisions;
  amenities: EventAmenities;
  requirements: EventRequirements;
  metadata: EventMetadata;
  organizer: {
    id: string;
    name: string;
    email: string;
  };
  registrationCount: number;
  isRegistrationOpen: boolean;
  availableSpots: number | undefined;
}

export interface EventRegistrationWithDetails
  extends Omit<EventRegistration, "roster" | "paymentMetadata"> {
  roster: EventRegistrationRoster;
  paymentMetadata: EventPaymentMetadata | null;
  event: EventWithDetails;
  team?: {
    id: string;
    name: string;
    slug: string;
  };
  user: {
    id: string;
    name: string;
    email: string;
  };
}

export type EventPaymentMethod = EventRegistration["paymentMethod"];
export type EventPaymentStatus = EventRegistration["paymentStatus"];

export type EventRegistrationPaymentInfo =
  | {
      method: "square";
      checkoutUrl: string;
      sessionId: string;
    }
  | {
      method: "etransfer";
      instructions?: string | null;
      recipient?: string | null;
    }
  | {
      method: "free";
    };

export interface EventRegistrationResultPayload {
  registration: EventRegistrationWithDetails;
  payment?: EventRegistrationPaymentInfo;
}

export type CancelEventErrorCode =
  | "REFUND_FAILED"
  | "NO_PAYMENT_SESSION"
  | "NOT_PAID"
  | "UNAUTHORIZED";

export interface CancelEventResult {
  eventId: string;
  affected: {
    totalRegistrations: number;
    cancelled: number;
    alreadyCancelled: number;
    squareRefunded: number;
    etransferMarkedForRefund: number;
    freeOrUnpaid: number;
  };
  errors: Array<{
    registrationId: string;
    code: CancelEventErrorCode;
    message: string;
    paymentId?: string;
  }>;
}

// Operation result types
export type EventOperationResult<T = Event> =
  | { success: true; data: T }
  | { success: false; errors: EventError[] };

export type EventError = {
  code: EventErrorCode;
  message: string;
  field?: string;
};

export type EventErrorCode =
  | "VALIDATION_ERROR"
  | "NOT_FOUND"
  | "DUPLICATE_SLUG"
  | "UNAUTHORIZED"
  | "FORBIDDEN"
  | "REGISTRATION_CLOSED"
  | "EVENT_FULL"
  | "ALREADY_REGISTERED"
  | "INVALID_DATES"
  | "DATABASE_ERROR";

// Utility types
export type EventStatus = Event["status"];
export type EventType = Event["type"];
export type RegistrationType = Event["registrationType"];

// Pagination
export type EventListResult = {
  events: EventWithDetails[];
  totalCount: number;
  pageInfo: {
    currentPage: number;
    pageSize: number;
    totalPages: number;
    hasNextPage: boolean;
    hasPreviousPage: boolean;
  };
};
</file>

<file path="src/features/profile/components/complete-profile-form-simple.tsx">
import { useForm } from "@tanstack/react-form";
import { useQueryClient } from "@tanstack/react-query";
import { useRouter } from "@tanstack/react-router";
import { useState } from "react";
import { FormSubmitButton } from "~/components/form-fields/FormSubmitButton";
import { ValidatedCheckbox } from "~/components/form-fields/ValidatedCheckbox";
import { ValidatedDatePicker } from "~/components/form-fields/ValidatedDatePicker";
import { ValidatedInput } from "~/components/form-fields/ValidatedInput";
import { ValidatedSelect } from "~/components/form-fields/ValidatedSelect";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "~/components/ui/card";
import { Separator } from "~/components/ui/separator";
import { authQueryKey } from "~/features/auth/auth.queries";
import { unwrapServerFnResult } from "~/lib/server/fn-utils";
import { cn } from "~/shared/lib/utils";
import { completeUserProfile } from "../profile.mutations";
import type { ProfileInputType } from "../profile.schemas";
import type { ProfileInput, ProfileOperationResult } from "../profile.types";

const STEPS = [
  {
    id: "personal",
    title: "Personal Information",
    description: "Basic information about you",
  },
  {
    id: "emergency",
    title: "Emergency Contact",
    description: "Who should we contact in case of emergency",
  },
  {
    id: "privacy",
    title: "Privacy Settings",
    description: "Control what information is visible to others",
  },
] as const;

type StepId = (typeof STEPS)[number]["id"];

export function CompleteProfileForm() {
  const router = useRouter();
  const queryClient = useQueryClient();
  const [currentStep, setCurrentStep] = useState<StepId>("personal");
  const [error, setError] = useState<string | null>(null);

  const form = useForm({
    defaultValues: {
      dateOfBirth: new Date(),
      gender: "",
      pronouns: "",
      phone: "",
      emergencyContact: {
        name: "",
        relationship: "",
        phone: "",
        email: "",
      },
      privacySettings: {
        showEmail: false,
        showPhone: false,
        showBirthYear: false,
        allowTeamInvitations: true,
      },
    } as ProfileInputType,
    onSubmit: async ({ value }) => {
      if (currentStepIndex < STEPS.length - 1) {
        goToNextStep();
        return;
      }

      setError(null);

      try {
        // Build profile input with only defined values
        const dataToSubmit: ProfileInput = {
          dateOfBirth: value.dateOfBirth,
        };

        // Add optional fields only if they have values
        if (value.gender) dataToSubmit.gender = value.gender;
        if (value.pronouns) dataToSubmit.pronouns = value.pronouns;
        if (value.phone) dataToSubmit.phone = value.phone;
        if (value.privacySettings) dataToSubmit.privacySettings = value.privacySettings;

        // Only include emergency contact if it has meaningful data
        if (
          value.emergencyContact &&
          (value.emergencyContact.name ||
            value.emergencyContact.relationship ||
            value.emergencyContact.phone ||
            value.emergencyContact.email)
        ) {
          // Build emergency contact with required fields
          const emergencyContact: ProfileInput["emergencyContact"] = {
            name: value.emergencyContact.name || "",
            relationship: value.emergencyContact.relationship || "",
          };
          if (value.emergencyContact.phone)
            emergencyContact.phone = value.emergencyContact.phone;
          if (value.emergencyContact.email)
            emergencyContact.email = value.emergencyContact.email;

          dataToSubmit.emergencyContact = emergencyContact;
        }

        const result = (await unwrapServerFnResult(
          completeUserProfile({
            data: dataToSubmit,
          }),
        )) as ProfileOperationResult;

        if (result.success) {
          await queryClient.invalidateQueries({ queryKey: authQueryKey });
          router.navigate({ to: "/dashboard" });
        } else {
          const errorMessage = result.errors?.[0]?.message || "Failed to save profile";
          setError(errorMessage);
        }
      } catch (err) {
        setError("An unexpected error occurred. Please try again.");
        console.error("Profile submission error:", err);
      }
    },
  });

  const currentStepIndex = STEPS.findIndex((step) => step.id === currentStep);

  // Check if emergency contact has any data
  const emergencyContact = form.getFieldValue("emergencyContact");
  const hasEmergencyContactData =
    emergencyContact &&
    (emergencyContact.name ||
      emergencyContact.relationship ||
      emergencyContact.phone ||
      emergencyContact.email);

  const goToStep = (stepId: StepId) => setCurrentStep(stepId);
  const goToNextStep = () => {
    const nextIndex = currentStepIndex + 1;
    if (nextIndex < STEPS.length) {
      setCurrentStep(STEPS[nextIndex].id);
    }
  };
  const goToPreviousStep = () => {
    const prevIndex = currentStepIndex - 1;
    if (prevIndex >= 0) {
      setCurrentStep(STEPS[prevIndex].id);
    }
  };

  const isLastStep = currentStepIndex === STEPS.length - 1;

  // Gender options for select component
  const genderOptions = [
    { value: "male", label: "Male" },
    { value: "female", label: "Female" },
    { value: "non-binary", label: "Non-binary" },
    { value: "other", label: "Other" },
    { value: "prefer-not-to-say", label: "Prefer not to say" },
  ];

  return (
    <div className="space-y-6">
      {/* Step indicators */}
      <div className="flex justify-between">
        {STEPS.map((step, index) => (
          <button
            key={step.id}
            onClick={() => goToStep(step.id)}
            className={cn(
              "flex items-center gap-2 text-sm font-medium transition-colors",
              index <= currentStepIndex ? "text-primary" : "text-muted-foreground",
              "hover:text-primary",
            )}
            type="button"
          >
            <div
              className={cn(
                "flex h-8 w-8 items-center justify-center rounded-full border-2 transition-colors",
                index <= currentStepIndex
                  ? "border-primary bg-primary text-primary-foreground"
                  : "border-muted-foreground",
              )}
            >
              {index + 1}
            </div>
            <span className="hidden sm:inline">{step.title}</span>
          </button>
        ))}
      </div>

      {error && (
        <div className="bg-destructive/10 text-destructive rounded-md p-3 text-sm">
          {error}
        </div>
      )}

      <form
        onSubmit={(e) => {
          e.preventDefault();
          e.stopPropagation();
          form.handleSubmit();
        }}
      >
        <Card>
          <CardHeader>
            <CardTitle>{STEPS[currentStepIndex].title}</CardTitle>
            <CardDescription>{STEPS[currentStepIndex].description}</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Personal Information Step */}
            {currentStep === "personal" && (
              <>
                <form.Field
                  name="dateOfBirth"
                  validators={{
                    onChange: ({ value }) => {
                      if (!value) return "Date of birth is required";
                      // Value is a YYYY-MM-DD string from ValidatedDatePicker
                      const birthDate = new Date(value);
                      const age = new Date().getFullYear() - birthDate.getFullYear();
                      if (age < 13 || age > 120) {
                        return "Age must be between 13 and 120 years";
                      }
                      return undefined;
                    },
                  }}
                >
                  {(field) => (
                    <ValidatedDatePicker
                      field={field}
                      label="Date of Birth"
                      minAge={13}
                      maxAge={120}
                    />
                  )}
                </form.Field>

                <form.Field name="gender">
                  {(field) => (
                    <ValidatedSelect
                      field={field}
                      label="Gender (optional)"
                      options={genderOptions}
                      placeholderText="Select gender"
                    />
                  )}
                </form.Field>

                <form.Field name="pronouns">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Pronouns (optional)"
                      placeholder="e.g., they/them, she/her, he/him"
                    />
                  )}
                </form.Field>

                <form.Field name="phone">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Phone Number (optional)"
                      type="tel"
                      placeholder="+1 (555) 000-0000"
                    />
                  )}
                </form.Field>
              </>
            )}

            {/* Emergency Contact Step */}
            {currentStep === "emergency" && (
              <>
                <p className="text-muted-foreground mb-4 text-sm">
                  Emergency contact information is optional but recommended for your
                  safety.
                </p>

                <form.Field name="emergencyContact.name">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Emergency Contact Name (optional)"
                      placeholder="Full name"
                    />
                  )}
                </form.Field>

                <form.Field name="emergencyContact.relationship">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Relationship"
                      placeholder="e.g., Parent, Spouse, Friend"
                      disabled={!hasEmergencyContactData}
                    />
                  )}
                </form.Field>

                <form.Field name="emergencyContact.phone">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Emergency Contact Phone"
                      type="tel"
                      placeholder="+1 (555) 000-0000"
                      disabled={!hasEmergencyContactData}
                    />
                  )}
                </form.Field>

                <form.Field name="emergencyContact.email">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Emergency Contact Email"
                      type="email"
                      placeholder="email@example.com"
                      disabled={!hasEmergencyContactData}
                    />
                  )}
                </form.Field>

                {hasEmergencyContactData && (
                  <p className="text-muted-foreground text-sm">
                    If providing emergency contact, please include at least one contact
                    method (phone or email).
                  </p>
                )}
              </>
            )}

            {/* Privacy Settings Step */}
            {currentStep === "privacy" && (
              <>
                <div className="space-y-4">
                  <p className="text-muted-foreground text-sm">
                    Choose what information other members can see about you.
                  </p>

                  <Separator />

                  <form.Field name="privacySettings.showEmail">
                    {(field) => (
                      <ValidatedCheckbox
                        field={field}
                        label="Show my email address to team members"
                      />
                    )}
                  </form.Field>

                  <form.Field name="privacySettings.showPhone">
                    {(field) => (
                      <ValidatedCheckbox
                        field={field}
                        label="Show my phone number to team members"
                      />
                    )}
                  </form.Field>

                  <form.Field name="privacySettings.showBirthYear">
                    {(field) => (
                      <ValidatedCheckbox
                        field={field}
                        label="Show my birth year on my profile"
                      />
                    )}
                  </form.Field>

                  <form.Field name="privacySettings.allowTeamInvitations">
                    {(field) => (
                      <ValidatedCheckbox
                        field={field}
                        label="Allow team captains to send me invitations"
                      />
                    )}
                  </form.Field>
                </div>
              </>
            )}

            <Separator />

            {/* Navigation buttons */}
            <div className="flex justify-between">
              <button
                type="button"
                onClick={goToPreviousStep}
                disabled={currentStepIndex === 0}
                className={cn(
                  "rounded-md px-4 py-2 text-sm font-medium transition-colors",
                  currentStepIndex === 0
                    ? "invisible"
                    : "border-input bg-background hover:bg-accent hover:text-accent-foreground border",
                )}
              >
                Previous
              </button>

              {isLastStep ? (
                <FormSubmitButton
                  isSubmitting={form.state.isSubmitting}
                  loadingText="Completing Profile..."
                >
                  Complete Profile
                </FormSubmitButton>
              ) : (
                <button
                  type="submit"
                  className="text-primary-foreground bg-primary hover:bg-primary/90 rounded-md px-4 py-2 text-sm font-medium transition-colors"
                >
                  Next
                </button>
              )}
            </div>
          </CardContent>
        </Card>
      </form>
    </div>
  );
}
</file>

<file path="src/features/profile/components/profile-view.tsx">
import { useForm } from "@tanstack/react-form";
import { useQuery, useQueryClient } from "@tanstack/react-query";
import { Edit2, LoaderCircle, Save, X } from "lucide-react";
import { useState } from "react";
import { toast } from "sonner";
import { ValidatedCheckbox } from "~/components/form-fields/ValidatedCheckbox";
import { ValidatedDatePicker } from "~/components/form-fields/ValidatedDatePicker";
import { ValidatedInput } from "~/components/form-fields/ValidatedInput";
import { ValidatedSelect } from "~/components/form-fields/ValidatedSelect";
import { Button } from "~/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "~/components/ui/card";
import { Label } from "~/components/ui/label";
import { Separator } from "~/components/ui/separator";
import { updateUserProfile } from "../profile.mutations";
import { getUserProfile } from "../profile.queries";
import type { PartialProfileInputType } from "../profile.schemas";
import type { ProfileOperationResult } from "../profile.types";

function toUtcDate(value: Date | string | undefined): Date | null {
  if (!value) return null;
  if (typeof value === "string") {
    const isoValue = value.includes("T") ? value : `${value}T00:00:00.000Z`;
    const parsed = new Date(isoValue);
    return isNaN(parsed.getTime()) ? null : parsed;
  }
  return isNaN(value.getTime()) ? null : value;
}

function calculateAgeUtc(value: Date | string | undefined): number | null {
  const birthDate = toUtcDate(value);
  if (!birthDate) return null;
  const today = new Date();
  let age = today.getUTCFullYear() - birthDate.getUTCFullYear();
  const monthDiff = today.getUTCMonth() - birthDate.getUTCMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getUTCDate() < birthDate.getUTCDate())) {
    age--;
  }
  return age;
}

function formatDateOnly(value: Date | string | undefined): string | null {
  const date = toUtcDate(value);
  if (!date) return null;
  return new Intl.DateTimeFormat(undefined, {
    year: "numeric",
    month: "numeric",
    day: "numeric",
    timeZone: "UTC",
  }).format(date);
}

export function ProfileView() {
  const queryClient = useQueryClient();
  const [isEditing, setIsEditing] = useState(false);
  const [formError, setFormError] = useState<string | null>(null);

  // Fetch profile data
  const {
    data: profileResult,
    isLoading,
    error,
  } = useQuery({
    queryKey: ["userProfile"],
    queryFn: async () => getUserProfile(),
    retry: 1,
  });

  const profile = profileResult?.success ? profileResult.data : null;

  // TanStack Form for editing
  const form = useForm({
    defaultValues: {
      dateOfBirth: undefined as Date | undefined,
      gender: "",
      pronouns: "",
      phone: "",
      emergencyContact: {
        name: "",
        relationship: "",
        phone: "",
        email: "",
      },
      privacySettings: {
        showEmail: false,
        showPhone: false,
        showBirthYear: false,
        allowTeamInvitations: true,
      },
    } as PartialProfileInputType,
    onSubmit: async ({ value }) => {
      // Build ProfileInput with only changed/meaningful values
      // Use a more flexible type since we need to handle Date serialization
      const dataToSubmit: Record<string, unknown> = {};

      // Include fields that have values - convert Date to ISO string for serialization
      if (value.dateOfBirth) {
        dataToSubmit["dateOfBirth"] =
          value.dateOfBirth instanceof Date
            ? value.dateOfBirth.toISOString()
            : value.dateOfBirth;
      }
      if (value.gender) dataToSubmit["gender"] = value.gender;
      if (value.pronouns) dataToSubmit["pronouns"] = value.pronouns;
      if (value.phone) dataToSubmit["phone"] = value.phone;

      // Handle emergency contact
      if (value.emergencyContact) {
        const ec = value.emergencyContact;
        if (ec.name || ec.relationship || ec.phone || ec.email) {
          dataToSubmit["emergencyContact"] = {
            name: ec.name || "",
            relationship: ec.relationship || "",
            ...(ec.phone && { phone: ec.phone }),
            ...(ec.email && { email: ec.email }),
          };
        }
      }

      // Always include privacy settings as they have default values
      if (value.privacySettings) {
        dataToSubmit["privacySettings"] = {
          showEmail: value.privacySettings.showEmail ?? false,
          showPhone: value.privacySettings.showPhone ?? false,
          showBirthYear: value.privacySettings.showBirthYear ?? false,
          allowTeamInvitations: value.privacySettings.allowTeamInvitations ?? true,
        };
      }

      try {
        setFormError(null); // Clear any previous errors

        // Debug logging to check what we're sending
        console.log("Form value:", value);
        console.log("Data to submit:", dataToSubmit);
        console.log("Data to submit keys:", Object.keys(dataToSubmit));
        console.log("Privacy settings in dataToSubmit:", dataToSubmit["privacySettings"]);

        // Make sure we're not sending an empty object
        if (Object.keys(dataToSubmit).length === 0) {
          console.error("No data to submit!");
          setFormError("No changes detected");
          return;
        }

        console.log("Sending to server function:", JSON.stringify(dataToSubmit, null, 2));
        console.log("Data type:", typeof dataToSubmit);

        const result = (await updateUserProfile({
          data: dataToSubmit as PartialProfileInputType,
        })) as ProfileOperationResult;

        if (result.success) {
          toast.success("Profile updated successfully");
          await queryClient.invalidateQueries({ queryKey: ["userProfile"] });
          // Only exit edit mode on success
          setIsEditing(false);
          setFormError(null);
        } else {
          // Show error but don't exit edit mode
          const error = result.errors?.[0]?.message || "Failed to update profile";
          setFormError(error);
          toast.error(error);
          // Don't throw - let form remain interactive
        }
      } catch (error) {
        // Network/unexpected errors
        const errorMessage =
          error instanceof Error ? error.message : "An unexpected error occurred";
        setFormError(errorMessage);
        toast.error(errorMessage);
        console.error("Profile update error:", error);
        // Don't throw - let form remain interactive
      } finally {
        // Don't reset form on error - this was causing fields to clear
        // TanStack Form handles submission state automatically
      }
    },
  });

  // Gender options for select component
  const genderOptions = [
    { value: "male", label: "Male" },
    { value: "female", label: "Female" },
    { value: "non-binary", label: "Non-binary" },
    { value: "other", label: "Other" },
    { value: "prefer-not-to-say", label: "Prefer not to say" },
  ];

  // Initialize form data when entering edit mode
  const startEditing = () => {
    if (!profile) return;

    // Reset form with current profile data
    form.reset();

    // Set field values from profile
    if (profile.dateOfBirth) {
      const date = toUtcDate(profile.dateOfBirth);
      if (date) {
        form.setFieldValue("dateOfBirth", date);
      }
    }
    if (profile.gender) {
      form.setFieldValue("gender", profile.gender);
    }
    if (profile.pronouns) {
      form.setFieldValue("pronouns", profile.pronouns);
    }
    if (profile.phone) {
      form.setFieldValue("phone", profile.phone);
    }
    if (profile.emergencyContact) {
      form.setFieldValue("emergencyContact.name", profile.emergencyContact.name || "");
      form.setFieldValue(
        "emergencyContact.relationship",
        profile.emergencyContact.relationship || "",
      );
      form.setFieldValue("emergencyContact.phone", profile.emergencyContact.phone || "");
      form.setFieldValue("emergencyContact.email", profile.emergencyContact.email || "");
    }

    const privacySettings = profile.privacySettings || {
      showEmail: false,
      showPhone: false,
      showBirthYear: false,
      allowTeamInvitations: true,
    };
    form.setFieldValue("privacySettings.showEmail", privacySettings.showEmail);
    form.setFieldValue("privacySettings.showPhone", privacySettings.showPhone);
    form.setFieldValue("privacySettings.showBirthYear", privacySettings.showBirthYear);
    form.setFieldValue(
      "privacySettings.allowTeamInvitations",
      privacySettings.allowTeamInvitations,
    );

    setIsEditing(true);
  };

  const cancelEditing = () => {
    // Reset form to original values
    form.reset();
    // Clear any errors
    setFormError(null);
    // Exit edit mode
    setIsEditing(false);
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <LoaderCircle className="h-8 w-8 animate-spin" />
      </div>
    );
  }

  if (!profile) {
    const errorMessage =
      profileResult?.errors?.[0]?.message || error?.message || "Failed to load profile";
    return (
      <div className="p-8 text-center">
        <p className="text-muted-foreground">{errorMessage}</p>
        {profileResult?.errors?.[0]?.code === "VALIDATION_ERROR" && (
          <p className="text-muted-foreground mt-2 text-sm">
            Please try logging in again
          </p>
        )}
      </div>
    );
  }

  const age = calculateAgeUtc(profile.dateOfBirth);
  const formattedDob = formatDateOnly(profile.dateOfBirth);

  return (
    <div className="space-y-6">
      {/* Basic Information */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Basic Information</CardTitle>
              <CardDescription>
                Your personal details and contact information
              </CardDescription>
            </div>
            {!isEditing && (
              <Button onClick={startEditing} variant="outline" size="sm">
                <Edit2 className="mr-2 h-4 w-4" />
                Edit Profile
              </Button>
            )}
            {isEditing && (
              <div className="flex gap-2">
                <Button
                  onClick={cancelEditing}
                  variant="outline"
                  size="sm"
                  disabled={form.state.isSubmitting}
                >
                  <X className="mr-2 h-4 w-4" />
                  Cancel
                </Button>
                <form.Subscribe
                  selector={(state) => [state.canSubmit, state.isSubmitting]}
                >
                  {([canSubmit, isSubmitting]) => (
                    <Button
                      type="button"
                      onClick={() => form.handleSubmit()}
                      disabled={!canSubmit || isSubmitting}
                      size="sm"
                    >
                      {isSubmitting ? (
                        <>
                          <LoaderCircle className="mr-2 h-4 w-4 animate-spin" />
                          Saving...
                        </>
                      ) : (
                        <>
                          <Save className="mr-2 h-4 w-4" />
                          Save Changes
                        </>
                      )}
                    </Button>
                  )}
                </form.Subscribe>
              </div>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {formError && (
            <div className="bg-destructive/10 text-destructive rounded-md p-3 text-sm">
              {formError}
            </div>
          )}
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <Label>Name</Label>
              <p className="text-base">{profile.name || "Not set"}</p>
            </div>
            <div className="space-y-2">
              <Label>Email</Label>
              <p className="text-base">{profile.email}</p>
            </div>
          </div>

          <Separator />

          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              {isEditing ? (
                <form.Field
                  name="dateOfBirth"
                  validators={{
                    onChange: ({ value }) => {
                      if (value) {
                        const computedAge = calculateAgeUtc(value);
                        if (
                          computedAge !== null &&
                          (computedAge < 13 || computedAge > 120)
                        ) {
                          return "You must be between 13 and 120 years old";
                        }
                      }
                      return undefined;
                    },
                  }}
                >
                  {(field) => (
                    <ValidatedDatePicker
                      field={field}
                      label="Date of Birth"
                      minAge={13}
                      maxAge={120}
                    />
                  )}
                </form.Field>
              ) : (
                <>
                  <Label>Date of Birth</Label>
                  <p className="text-base">
                    {formattedDob
                      ? `${formattedDob}${age !== null ? ` (Age: ${age})` : ""}`
                      : "Not set"}
                  </p>
                </>
              )}
            </div>

            <div className="space-y-2">
              {isEditing ? (
                <form.Field name="phone">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Phone Number"
                      type="tel"
                      placeholder="+1 (555) 000-0000"
                    />
                  )}
                </form.Field>
              ) : (
                <>
                  <Label>Phone Number</Label>
                  <p className="text-base">{profile.phone || "Not set"}</p>
                </>
              )}
            </div>

            <div className="space-y-2">
              {isEditing ? (
                <form.Field name="gender">
                  {(field) => (
                    <ValidatedSelect
                      field={field}
                      label="Gender"
                      options={genderOptions}
                      placeholderText="Select gender"
                    />
                  )}
                </form.Field>
              ) : (
                <>
                  <Label>Gender</Label>
                  <p className="text-base">{profile.gender || "Not set"}</p>
                </>
              )}
            </div>

            <div className="space-y-2">
              {isEditing ? (
                <form.Field name="pronouns">
                  {(field) => (
                    <ValidatedInput
                      field={field}
                      label="Pronouns"
                      placeholder="e.g., they/them, she/her, he/him"
                    />
                  )}
                </form.Field>
              ) : (
                <>
                  <Label>Pronouns</Label>
                  <p className="text-base">{profile.pronouns || "Not set"}</p>
                </>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Emergency Contact */}
      <Card>
        <CardHeader>
          <CardTitle>Emergency Contact</CardTitle>
          <CardDescription>Who should we contact in case of emergency</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {isEditing ? (
            <div className="grid gap-4 md:grid-cols-2">
              <form.Field name="emergencyContact.name">
                {(field) => (
                  <ValidatedInput
                    field={field}
                    label="Contact Name"
                    placeholder="Full name"
                  />
                )}
              </form.Field>

              <form.Field name="emergencyContact.relationship">
                {(field) => (
                  <ValidatedInput
                    field={field}
                    label="Relationship"
                    placeholder="e.g., Parent, Spouse, Friend"
                  />
                )}
              </form.Field>

              <form.Field name="emergencyContact.phone">
                {(field) => (
                  <ValidatedInput
                    field={field}
                    label="Contact Phone"
                    type="tel"
                    placeholder="+1 (555) 000-0000"
                  />
                )}
              </form.Field>

              <form.Field name="emergencyContact.email">
                {(field) => (
                  <ValidatedInput
                    field={field}
                    label="Contact Email"
                    type="email"
                    placeholder="email@example.com"
                  />
                )}
              </form.Field>
            </div>
          ) : (
            <div className="grid gap-4 md:grid-cols-2">
              <div className="space-y-2">
                <Label>Contact Name</Label>
                <p className="text-base">{profile.emergencyContact?.name || "Not set"}</p>
              </div>
              <div className="space-y-2">
                <Label>Relationship</Label>
                <p className="text-base">
                  {profile.emergencyContact?.relationship || "Not set"}
                </p>
              </div>
              <div className="space-y-2">
                <Label>Contact Phone</Label>
                <p className="text-base">
                  {profile.emergencyContact?.phone || "Not set"}
                </p>
              </div>
              <div className="space-y-2">
                <Label>Contact Email</Label>
                <p className="text-base">
                  {profile.emergencyContact?.email || "Not set"}
                </p>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Privacy Settings */}
      <Card>
        <CardHeader>
          <CardTitle>Privacy Settings</CardTitle>
          <CardDescription>Control what information is visible to others</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {isEditing ? (
            <div className="space-y-4">
              <form.Field name="privacySettings.showEmail">
                {(field) => (
                  <ValidatedCheckbox
                    field={field}
                    label="Show my email address to team members"
                  />
                )}
              </form.Field>

              <form.Field name="privacySettings.showPhone">
                {(field) => (
                  <ValidatedCheckbox
                    field={field}
                    label="Show my phone number to team members"
                  />
                )}
              </form.Field>

              <form.Field name="privacySettings.showBirthYear">
                {(field) => (
                  <ValidatedCheckbox
                    field={field}
                    label="Show my birth year on my profile"
                  />
                )}
              </form.Field>

              <form.Field name="privacySettings.allowTeamInvitations">
                {(field) => (
                  <ValidatedCheckbox
                    field={field}
                    label="Allow team captains to send me invitations"
                  />
                )}
              </form.Field>
            </div>
          ) : (
            <div className="space-y-2">
              <p className="text-sm">
                <span className="font-medium">Email visibility:</span>{" "}
                {profile.privacySettings?.showEmail
                  ? "Visible to team members"
                  : "Hidden"}
              </p>
              <p className="text-sm">
                <span className="font-medium">Phone visibility:</span>{" "}
                {profile.privacySettings?.showPhone
                  ? "Visible to team members"
                  : "Hidden"}
              </p>
              <p className="text-sm">
                <span className="font-medium">Birth year visibility:</span>{" "}
                {profile.privacySettings?.showBirthYear ? "Visible on profile" : "Hidden"}
              </p>
              <p className="text-sm">
                <span className="font-medium">Team invitations:</span>{" "}
                {profile.privacySettings?.allowTeamInvitations !== false
                  ? "Allowed"
                  : "Not allowed"}
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Profile Metadata */}
      <Card>
        <CardHeader>
          <CardTitle>Profile Information</CardTitle>
          <CardDescription>Technical details about your profile</CardDescription>
        </CardHeader>
        <CardContent className="space-y-2">
          <p className="text-sm">
            <span className="font-medium">Profile Status:</span>{" "}
            {profile.profileComplete ? "Complete" : "Incomplete"}
          </p>
          <p className="text-sm">
            <span className="font-medium">Profile Version:</span> {profile.profileVersion}
          </p>
          <p className="text-sm">
            <span className="font-medium">Last Updated:</span>{" "}
            {profile.profileUpdatedAt
              ? new Date(profile.profileUpdatedAt).toLocaleString()
              : "Never"}
          </p>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="src/routes/index.tsx">
import { createFileRoute, useNavigate, useRouteContext } from "@tanstack/react-router";
import { useEffect } from "react";
import { PublicPortalPage } from "~/features/dashboard";

export const Route = createFileRoute("/")({
  component: HomePage,
});

function HomePage() {
  const { user } = useRouteContext({ from: "__root__" });
  const navigate = useNavigate();

  useEffect(() => {
    if (user) {
      navigate({ to: "/dashboard", replace: true });
    }
  }, [navigate, user]);

  if (user) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4">
        <p className="text-muted-foreground text-sm">Redirecting to your dashboard...</p>
      </div>
    );
  }

  return <PublicPortalPage />;
}
</file>

<file path="src/routes/dashboard/membership.tsx">
import { useQuery } from "@tanstack/react-query";
import { createFileRoute } from "@tanstack/react-router";
import { AlertCircle, Loader2 } from "lucide-react";
import { useCallback, useEffect, useState } from "react";
import { toast } from "sonner";
import { Alert, AlertDescription, AlertTitle } from "~/components/ui/alert";
import { Button } from "~/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "~/components/ui/card";
import {
  clearPaymentParams,
  getPaymentErrorMessage,
  usePaymentReturn,
} from "~/features/membership/hooks/usePaymentReturn";
import {
  confirmMembershipPurchase,
  createCheckoutSession,
} from "~/features/membership/membership.mutations";
import {
  getUserMembershipStatus,
  listMembershipTypes,
} from "~/features/membership/membership.queries";
import { unwrapServerFnResult } from "~/lib/server/fn-utils";

export const Route = createFileRoute("/dashboard/membership")({
  component: MembershipPage,
});

function MembershipPage() {
  const [processingPayment, setProcessingPayment] = useState(false);
  const paymentReturn = usePaymentReturn();
  const [hasProcessedReturn, setHasProcessedReturn] = useState(false);

  const membershipStatusQuery = useQuery({
    queryKey: ["membership-status"],
    queryFn: async () => {
      const result = await getUserMembershipStatus();
      if (!result.success) {
        throw new Error(
          result.errors?.[0]?.message || "Failed to fetch membership status",
        );
      }
      return result.data || null;
    },
  });

  const { refetch: refetchMembershipStatus } = membershipStatusQuery;

  const membershipTypesQuery = useQuery({
    queryKey: ["membership-types"],
    queryFn: async () => {
      const result = await listMembershipTypes();
      if (!result.success) {
        throw new Error(
          result.errors?.[0]?.message || "Failed to fetch membership types",
        );
      }
      return result.data || [];
    },
  });

  const squareStatusQuery = useQuery({
    queryKey: ["square-status"],
    queryFn: async () => {
      const response = await fetch("/api/health");
      if (!response.ok) {
        throw new Error("Failed to load payment status");
      }
      const data = (await response.json()) as {
        services?: { square?: { environment?: string } };
      };
      return data.services?.square ?? null;
    },
    staleTime: 60_000,
    retry: false,
    enabled: typeof window !== "undefined",
  });

  const confirmPurchase = useCallback(
    async (sessionId: string, membershipTypeId: string, paymentId: string) => {
      setProcessingPayment(true);
      try {
        const result = await unwrapServerFnResult(
          confirmMembershipPurchase({
            data: {
              membershipTypeId,
              sessionId,
              paymentId,
            },
          }),
        );

        if (result.success) {
          toast.success("Membership purchased successfully!");
          clearPaymentParams();
          await refetchMembershipStatus();
        } else {
          toast.error(result.errors?.[0]?.message || "Failed to confirm membership");
        }
      } catch (error) {
        console.error("Error confirming membership:", error);
        toast.error("Failed to confirm membership purchase");
      } finally {
        setProcessingPayment(false);
      }
    },
    [refetchMembershipStatus],
  );

  const handleMockPaymentReturn = useCallback(
    async (sessionId: string, membershipTypeId: string) => {
      await confirmPurchase(sessionId, membershipTypeId, `mock_payment_${Date.now()}`);
    },
    [confirmPurchase],
  );

  // Process payment return if needed
  const processPaymentReturn = useCallback(async () => {
    if (hasProcessedReturn) return;

    // Handle mock checkout
    if (paymentReturn.isMockCheckout && paymentReturn.sessionId) {
      if (!paymentReturn.membershipTypeId) {
        setHasProcessedReturn(true);
        toast.error("Missing membership type for checkout session");
        clearPaymentParams();
        return;
      }

      setHasProcessedReturn(true);
      await handleMockPaymentReturn(
        paymentReturn.sessionId,
        paymentReturn.membershipTypeId || "",
      );
    }
    // Handle real Square success
    else if (paymentReturn.success && paymentReturn.paymentId) {
      if (!paymentReturn.sessionId || !paymentReturn.membershipTypeId) {
        setHasProcessedReturn(true);
        toast.error("Missing checkout information. Please contact support.");
        clearPaymentParams();
        return;
      }

      setHasProcessedReturn(true);
      await confirmPurchase(
        paymentReturn.sessionId,
        paymentReturn.membershipTypeId,
        paymentReturn.paymentId,
      );
    }
    // Handle errors
    else if (paymentReturn.error) {
      setHasProcessedReturn(true);
      const errorMessage = getPaymentErrorMessage(paymentReturn.error);
      if (errorMessage) toast.error(errorMessage);
      clearPaymentParams();
    }
  }, [hasProcessedReturn, paymentReturn, handleMockPaymentReturn, confirmPurchase]);

  // Process payment return using useEffect
  useEffect(() => {
    if (
      !hasProcessedReturn &&
      (paymentReturn.isMockCheckout || paymentReturn.success || paymentReturn.error) &&
      (paymentReturn.sessionId || paymentReturn.paymentId || paymentReturn.error)
    ) {
      processPaymentReturn();
    }
  }, [paymentReturn, hasProcessedReturn, processPaymentReturn]);

  const handlePurchase = async (membershipTypeId: string) => {
    try {
      const result = await unwrapServerFnResult(
        createCheckoutSession({
          data: { membershipTypeId },
        }),
      );
      if (result.success && result.data) {
        // Redirect to checkout URL
        window.location.href = result.data.checkoutUrl;
      } else {
        toast.error(result.errors?.[0]?.message || "Failed to create checkout session");
      }
    } catch (error) {
      console.error("Error creating checkout session:", error);
      toast.error("Failed to create checkout session");
    }
  };

  if (membershipStatusQuery.isLoading || membershipTypesQuery.isLoading) {
    return (
      <div className="flex min-h-[400px] items-center justify-center">
        <Loader2 className="h-8 w-8 animate-spin" />
      </div>
    );
  }

  if (membershipStatusQuery.error || membershipTypesQuery.error) {
    return (
      <div className="container mx-auto py-8">
        <Card className="border-destructive">
          <CardHeader>
            <CardTitle>Error</CardTitle>
            <CardDescription>
              {membershipStatusQuery.error?.message ||
                membershipTypesQuery.error?.message}
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  const membershipStatus = membershipStatusQuery.data;
  const membershipTypes = membershipTypesQuery.data || [];
  const isSandbox = squareStatusQuery.data?.environment === "sandbox";

  if (processingPayment) {
    return (
      <div className="container mx-auto py-8">
        <Card>
          <CardContent className="pt-6">
            <div className="flex flex-col items-center justify-center space-y-4">
              <Loader2 className="h-8 w-8 animate-spin" />
              <p>Processing your payment...</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8">
      <h1 className="mb-8 text-3xl font-bold">Membership</h1>
      <p className="text-muted-foreground mb-6">
        Join Quadball Canada and access exclusive member benefits
      </p>

      {isSandbox ? (
        <Alert className="mb-6 border-amber-200 bg-amber-50 text-amber-900">
          <AlertCircle className="text-amber-700" />
          <AlertTitle>Sandbox payments enabled</AlertTitle>
          <AlertDescription>
            Purchases are running in Square sandbox mode. Use test credentials only.
          </AlertDescription>
        </Alert>
      ) : null}

      {/* Current Membership Status */}
      <Card className="mb-8">
        <CardHeader>
          <CardTitle>Current Status</CardTitle>
        </CardHeader>
        <CardContent>
          {membershipStatus?.hasMembership ? (
            <div className="space-y-2">
              <p className="text-lg font-semibold text-green-600 dark:text-green-400">
                Active Membership
              </p>
              <p className="text-muted-foreground text-sm">
                Type: {membershipStatus.currentMembership?.membershipType.name}
              </p>
              <p className="text-muted-foreground text-sm">
                Expires:{" "}
                {membershipStatus.currentMembership
                  ? new Date(
                      membershipStatus.currentMembership.endDate,
                    ).toLocaleDateString()
                  : "N/A"}
              </p>
              {membershipStatus.daysRemaining != null &&
                membershipStatus.daysRemaining > 0 && (
                  <p className="text-muted-foreground text-sm">
                    Days Remaining: {membershipStatus.daysRemaining}
                  </p>
                )}
            </div>
          ) : (
            <div>
              <p className="text-lg font-semibold">No Active Membership</p>
              <p className="text-muted-foreground text-sm">
                Join today to participate in events and access member benefits
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Available Memberships */}
      <div>
        <h2 className="mb-4 text-2xl font-bold">Available Memberships</h2>
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {membershipTypes.map((type) => {
            const isCurrent =
              membershipStatus?.currentMembership?.membershipType.id === type.id;
            const canPurchase =
              !membershipStatus?.hasMembership ||
              (membershipStatus.daysRemaining ?? 0) <= 30;

            return (
              <Card key={type.id}>
                <CardHeader>
                  <CardTitle>{type.name}</CardTitle>
                  <CardDescription>${(type.priceCents / 100).toFixed(2)}</CardDescription>
                </CardHeader>
                <CardContent>
                  <p className="text-muted-foreground text-sm">{type.description}</p>
                </CardContent>
                <CardFooter>
                  {isCurrent ? (
                    <Button className="w-full" disabled>
                      Current Plan
                    </Button>
                  ) : canPurchase ? (
                    <Button
                      className="w-full"
                      onClick={() => handlePurchase(type.id)}
                      disabled={processingPayment}
                    >
                      {membershipStatus?.hasMembership &&
                      (membershipStatus.daysRemaining ?? 0) <= 30
                        ? "Renew"
                        : "Purchase"}
                    </Button>
                  ) : (
                    <Button className="w-full" disabled>
                      Not Available
                    </Button>
                  )}
                </CardFooter>
              </Card>
            );
          })}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/features/events/events.queries.ts">
import { createServerFn } from "@tanstack/react-start";
import { and, asc, desc, eq, gte, inArray, lte, sql } from "drizzle-orm";
import { z } from "zod";
import type { EventRegistration } from "~/db/schema";
import { eventRegistrations, events, teams, user } from "~/db/schema";
import { getAuthMiddleware, requireUser } from "~/lib/server/auth";
import { forbidden } from "~/lib/server/errors";
import { zod$ } from "~/lib/server/fn-utils";
import type {
  EventAmenities,
  EventDivisions,
  EventMetadata,
  EventPaymentMetadata,
  EventRequirements,
  EventRules,
  EventSchedule,
} from "./events.db-types";
import {
  checkEventRegistrationSchema,
  getEventSchema,
  getUpcomingEventsSchema,
  listEventsSchema,
} from "./events.schemas";
import type {
  EventListResult,
  EventOperationResult,
  EventPaymentMethod,
  EventPaymentStatus,
  EventWithDetails,
} from "./events.types";
import { castRegistrationJsonbFields, type EventRegistrationWithRoster } from "./utils";

export type EventRegistrationSummary = {
  id: string;
  userId: string | null;
  teamId: string | null;
  eventId: string;
  registrationType: EventRegistration["registrationType"];
  status: EventRegistration["status"];
  paymentStatus: EventPaymentStatus;
  paymentMethod: EventPaymentMethod;
  paymentId: string | null;
  amountDueCents: number;
  amountPaidCents: number | null;
  paymentCompletedAt: Date | null;
  paymentMetadata: EventPaymentMetadata | null;
  createdAt: Date;
  userName: string | null;
  userEmail: string | null;
  teamName: string | null;
};

/**
 * List events with filters and pagination
 */
export const listEvents = createServerFn({ method: "GET" })
  .inputValidator(zod$(listEventsSchema))
  .handler(async ({ data }): Promise<EventListResult> => {
    // Import server-only modules inside the handler
    const { getDb } = await import("~/db/server-helpers");
    const db = await getDb();

    const filters = data.filters || {};
    const page = Math.max(1, data.page || 1);
    const pageSize = Math.min(100, Math.max(1, data.pageSize || 20));
    const offset = (page - 1) * pageSize;
    const sortBy = data.sortBy || "startDate";
    const sortOrder = data.sortOrder || "asc";

    // Build filter conditions
    const conditions: ReturnType<typeof eq>[] = [];

    if (filters.status) {
      const statuses = Array.isArray(filters.status) ? filters.status : [filters.status];
      conditions.push(
        inArray(events.status, statuses as (typeof events.status._.data)[]),
      );
    }

    if (filters.type) {
      const types = Array.isArray(filters.type) ? filters.type : [filters.type];
      conditions.push(inArray(events.type, types as (typeof events.type._.data)[]));
    }

    if (filters.organizerId) {
      conditions.push(eq(events.organizerId, filters.organizerId));
    }

    if (filters.startDateFrom) {
      conditions.push(
        gte(events.startDate, filters.startDateFrom.toISOString().split("T")[0]),
      );
    }

    if (filters.startDateTo) {
      conditions.push(
        lte(events.startDate, filters.startDateTo.toISOString().split("T")[0]),
      );
    }

    if (filters.city) {
      conditions.push(eq(events.city, filters.city));
    }

    if (filters.province) {
      conditions.push(eq(events.province, filters.province));
    }

    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;

    // Get total count
    const [{ count }] = await db
      .select({ count: sql<number>`count(*)::int` })
      .from(events)
      .where(whereClause);

    // Get events with details
    const orderByColumn =
      sortBy === "name"
        ? events.name
        : sortBy === "createdAt"
          ? events.createdAt
          : events.startDate;

    const eventsList = await db
      .select({
        event: events,
        organizer: {
          id: user.id,
          name: user.name,
          email: user.email,
        },
        registrationCount: sql<number>`(
          SELECT COUNT(*)::int 
          FROM ${eventRegistrations} 
          WHERE ${eventRegistrations.eventId} = ${events.id}
          AND ${eventRegistrations.status} != 'cancelled'
        )`,
      })
      .from(events)
      .leftJoin(user, eq(events.organizerId, user.id))
      .where(whereClause)
      .orderBy(sortOrder === "desc" ? desc(orderByColumn) : asc(orderByColumn))
      .limit(pageSize)
      .offset(offset);

    // Transform results
    const eventsWithDetails: EventWithDetails[] = eventsList.map(
      ({ event, organizer, registrationCount }) => {
        const now = new Date();
        const registrationOpens = event.registrationOpensAt
          ? new Date(event.registrationOpensAt)
          : null;
        const registrationCloses = event.registrationClosesAt
          ? new Date(event.registrationClosesAt)
          : null;

        const isRegistrationOpen =
          event.status === "registration_open" &&
          (!registrationOpens || now >= registrationOpens) &&
          (!registrationCloses || now <= registrationCloses);

        let availableSpots: number | undefined;
        if (event.registrationType === "team" && event.maxTeams) {
          availableSpots = Math.max(0, event.maxTeams - registrationCount);
        } else if (event.registrationType === "individual" && event.maxParticipants) {
          availableSpots = Math.max(0, event.maxParticipants - registrationCount);
        }

        return {
          ...event,
          rules: (event.rules as EventRules) || {},
          schedule: (event.schedule as EventSchedule) || {},
          divisions: (event.divisions as EventDivisions) || {},
          amenities: (event.amenities as EventAmenities) || {},
          requirements: (event.requirements as EventRequirements) || {},
          metadata: (event.metadata as EventMetadata) || {},
          organizer: organizer!,
          registrationCount,
          isRegistrationOpen,
          availableSpots,
        };
      },
    );

    const totalPages = Math.ceil(count / pageSize);

    return {
      events: eventsWithDetails,
      totalCount: count,
      pageInfo: {
        currentPage: page,
        pageSize,
        totalPages,
        hasNextPage: page < totalPages,
        hasPreviousPage: page > 1,
      },
    };
  });

/**
 * Get a single event by ID or slug
 */
export const getEvent = createServerFn({ method: "GET" })
  .inputValidator(zod$(getEventSchema))
  .handler(async ({ data }): Promise<EventOperationResult<EventWithDetails>> => {
    try {
      if (!data.id && !data.slug) {
        return {
          success: false,
          errors: [
            {
              code: "VALIDATION_ERROR",
              message: "Either id or slug must be provided",
            },
          ],
        };
      }

      // Import server-only modules inside the handler
      const { getDb } = await import("~/db/server-helpers");
      const db = await getDb();

      const condition = data.id ? eq(events.id, data.id) : eq(events.slug, data.slug!);

      const result = await db
        .select({
          event: events,
          organizer: {
            id: user.id,
            name: user.name,
            email: user.email,
          },
          registrationCount: sql<number>`(
            SELECT COUNT(*)::int 
            FROM ${eventRegistrations} 
            WHERE ${eventRegistrations.eventId} = ${events.id}
            AND ${eventRegistrations.status} != 'cancelled'
          )`,
        })
        .from(events)
        .leftJoin(user, eq(events.organizerId, user.id))
        .where(condition)
        .limit(1);

      if (result.length === 0) {
        return {
          success: false,
          errors: [
            {
              code: "NOT_FOUND",
              message: "Event not found",
            },
          ],
        };
      }

      const { event, organizer, registrationCount } = result[0];
      const now = new Date();
      const registrationOpens = event.registrationOpensAt
        ? new Date(event.registrationOpensAt)
        : null;
      const registrationCloses = event.registrationClosesAt
        ? new Date(event.registrationClosesAt)
        : null;

      const isRegistrationOpen =
        event.status === "registration_open" &&
        (!registrationOpens || now >= registrationOpens) &&
        (!registrationCloses || now <= registrationCloses);

      let availableSpots: number | undefined;
      if (event.registrationType === "team" && event.maxTeams) {
        availableSpots = Math.max(0, event.maxTeams - registrationCount);
      } else if (event.registrationType === "individual" && event.maxParticipants) {
        availableSpots = Math.max(0, event.maxParticipants - registrationCount);
      }

      return {
        success: true,
        data: {
          ...event,
          rules: (event.rules as EventRules) || {},
          schedule: (event.schedule as EventSchedule) || {},
          divisions: (event.divisions as EventDivisions) || {},
          amenities: (event.amenities as EventAmenities) || {},
          requirements: (event.requirements as EventRequirements) || {},
          metadata: (event.metadata as EventMetadata) || {},
          organizer: organizer!,
          registrationCount,
          isRegistrationOpen,
          availableSpots,
        },
      };
    } catch (error) {
      console.error("Error fetching event:", error);
      return {
        success: false,
        errors: [
          {
            code: "DATABASE_ERROR",
            message: "Failed to fetch event",
          },
        ],
      };
    }
  });

/**
 * Get upcoming events for the dashboard
 */
export const getUpcomingEvents = createServerFn({ method: "GET" })
  .inputValidator(zod$(getUpcomingEventsSchema))
  .handler(async ({ data }): Promise<EventWithDetails[]> => {
    const limit = Math.min(10, data.limit || 3);

    const result = (await listEvents({
      data: {
        filters: {
          status: ["published", "registration_open"],
          startDateFrom: new Date(),
        },
        pageSize: limit,
        sortBy: "startDate",
        sortOrder: "asc",
      },
    })) as EventListResult;

    return result.events;
  });

/**
 * Get all registrations for an event (organizer or admin only)
 * Returns user emails and payment data - must be protected
 */
export const getEventRegistrations = createServerFn({ method: "GET" })
  .middleware(getAuthMiddleware())
  .inputValidator(z.object({ eventId: z.uuid() }).parse)
  .handler(async ({ data, context }): Promise<EventRegistrationSummary[]> => {
    const authUser = requireUser(context);
    const { getDb } = await import("~/db/server-helpers");
    const { isAdmin } = await import("~/lib/auth/utils/admin-check");
    const db = await getDb();

    // Check if user is organizer or admin
    const [event] = await db
      .select({ organizerId: events.organizerId })
      .from(events)
      .where(eq(events.id, data.eventId))
      .limit(1);

    if (!event) {
      throw forbidden("Event not found");
    }

    const userIsAdmin = await isAdmin(authUser.id);
    if (event.organizerId !== authUser.id && !userIsAdmin) {
      throw forbidden("Only event organizers or admins can view registrations");
    }

    const registrations = await db
      .select({
        id: eventRegistrations.id,
        userId: eventRegistrations.userId,
        teamId: eventRegistrations.teamId,
        eventId: eventRegistrations.eventId,
        registrationType: eventRegistrations.registrationType,
        status: eventRegistrations.status,
        paymentStatus: eventRegistrations.paymentStatus,
        paymentMethod: eventRegistrations.paymentMethod,
        paymentId: eventRegistrations.paymentId,
        amountDueCents: eventRegistrations.amountDueCents,
        amountPaidCents: eventRegistrations.amountPaidCents,
        paymentCompletedAt: eventRegistrations.paymentCompletedAt,
        paymentMetadata: eventRegistrations.paymentMetadata,
        createdAt: eventRegistrations.createdAt,
        userName: user.name,
        userEmail: user.email,
        teamName: teams.name,
      })
      .from(eventRegistrations)
      .leftJoin(user, eq(eventRegistrations.userId, user.id))
      .leftJoin(teams, eq(eventRegistrations.teamId, teams.id))
      .where(eq(eventRegistrations.eventId, data.eventId))
      .orderBy(desc(eventRegistrations.createdAt));

    return registrations.map((registration) => ({
      ...registration,
      userName: registration.userName ?? null,
      userEmail: registration.userEmail ?? null,
      teamName: registration.teamName ?? null,
      paymentMetadata: registration.paymentMetadata
        ? (registration.paymentMetadata as EventPaymentMetadata)
        : null,
    }));
  });

/**
 * Check if a user is registered for an event
 */
export const checkEventRegistration = createServerFn({ method: "GET" })
  .inputValidator(zod$(checkEventRegistrationSchema))
  .handler(
    async ({
      data,
    }): Promise<{
      isRegistered: boolean;
      registration?: EventRegistrationWithRoster;
    }> => {
      // Get user from session - not from client input
      const { getRequest } = await import("@tanstack/react-start/server");
      const { getAuth } = await import("~/lib/auth/server-helpers");
      const auth = await getAuth();
      const { headers } = getRequest();
      const session = await auth.api.getSession({ headers });
      const userId = session?.user?.id;

      if (!userId && !data.teamId) {
        return { isRegistered: false };
      }

      // Import server-only modules inside the handler
      const { getDb } = await import("~/db/server-helpers");
      const db = await getDb();

      const conditions: ReturnType<typeof eq>[] = [
        eq(eventRegistrations.eventId, data.eventId),
        eq(eventRegistrations.status, "confirmed"),
      ];

      if (userId) {
        conditions.push(eq(eventRegistrations.userId, userId));
      }

      if (data.teamId) {
        conditions.push(eq(eventRegistrations.teamId, data.teamId));
      }

      const [registration] = await db
        .select()
        .from(eventRegistrations)
        .where(and(...conditions))
        .limit(1);

      if (!registration) {
        return { isRegistered: false };
      }

      return {
        isRegistered: true,
        registration: castRegistrationJsonbFields(registration),
      };
    },
  );
</file>

<file path="src/components/ui/admin-sidebar.tsx">
import { useQueryClient } from "@tanstack/react-query";
import { useNavigate, useRouteContext, useRouter } from "@tanstack/react-router";
import { LogOut } from "lucide-react";
import { useMemo, useState } from "react";
import { SafeLink as Link } from "~/components/ui/SafeLink";
import { authQueryKey } from "~/features/auth/auth.queries";
import { ADMIN_PRIMARY_NAV, ADMIN_SECONDARY_NAV } from "~/features/layouts/admin-nav";
import { userHasRole } from "~/features/roles/permission.service";
import { auth } from "~/lib/auth-client";

export function AdminSidebar() {
  const queryClient = useQueryClient();
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  const router = useRouter();
  const navigate = useNavigate();
  const context = useRouteContext({ strict: false });
  const user = context?.user || null;

  // Filter sidebar items based on user roles
  const sidebarItems = useMemo(
    () =>
      ADMIN_PRIMARY_NAV.filter((item) => {
        if (!item.roles || item.roles.length === 0) {
          return true;
        }
        if (!user) {
          return false;
        }
        return item.roles.some((roleName) => userHasRole(user, roleName));
      }),
    [user],
  );

  const secondaryItems = ADMIN_SECONDARY_NAV;

  const handleLogout = async () => {
    if (isLoggingOut) return;
    setIsLoggingOut(true);

    try {
      await auth.signOut({
        fetchOptions: {
          onResponse: async () => {
            queryClient.setQueryData(authQueryKey, null);
            await router.invalidate();
          },
        },
      });

      await navigate({ to: "/auth/login" });
    } catch (error) {
      console.error("Logout failed:", error);
      setIsLoggingOut(false);
      return;
    }

    setIsLoggingOut(false);
  };

  return (
    <aside className="flex w-64 flex-col border-r border-gray-200 bg-white">
      <div className="p-6">
        <Link to="/" className="transition-opacity hover:opacity-80">
          <h1 className="text-admin-text-primary text-xl font-bold">Quadball Canada</h1>
          <p className="text-admin-text-secondary text-sm">Dashboard</p>
        </Link>
      </div>
      <nav className="flex-1 space-y-2 px-4 py-2">
        {sidebarItems.map((item) => {
          const Icon = item.icon;
          return (
            <Link
              key={item.to}
              to={item.to}
              className="nav-item"
              {...(item.exact ? { activeOptions: { exact: true as const } } : {})}
              activeProps={{
                className: "nav-item-active",
                "aria-current": "page",
                "data-status": "active",
              }}
            >
              <Icon className="pointer-events-none h-5 w-5" />
              <span>{item.label}</span>
            </Link>
          );
        })}
      </nav>
      <div className="space-y-2 border-t border-gray-200 px-4 py-4">
        {secondaryItems.map((item) => {
          const Icon = item.icon;
          return (
            <Link
              key={item.to}
              to={item.to}
              className="nav-item"
              {...(item.exact ? { activeOptions: { exact: true as const } } : {})}
              activeProps={{
                className: "nav-item-active",
                "aria-current": "page",
                "data-status": "active",
              }}
            >
              <Icon className="pointer-events-none h-5 w-5" />
              <span>{item.label}</span>
            </Link>
          );
        })}
        <button
          type="button"
          onClick={handleLogout}
          className="nav-item w-full text-left hover:bg-red-50 hover:text-red-600 disabled:opacity-60"
          disabled={isLoggingOut}
        >
          <LogOut className="h-5 w-5" />
          <span>{isLoggingOut ? "Logging out..." : "Logout"}</span>
        </button>
      </div>
    </aside>
  );
}
</file>

</files>
